<!DOCTYPE html>
<html lang="en">
<head>
    <title>MDsrv/NGL - embedded</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="icon" href="mdsrv/webapp/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"><!-- test -->
    <link rel="stylesheet" href="mdsrv/webapp/css/font-awesome.min.css" />
    <link rel="stylesheet" href="mdsrv/webapp/css/main.css" />
    <link rel="subresource" href="mdsrv/webapp/css/light.css" />
    <link rel="subresource" href="mdsrv/webapp/css/dark.css" />

</head>
<body >
    <!-- NGL -->
    <script src="mdsrv/webapp/js/ngl.js"></script>

    <!-- UI -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script><!-- test -->
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script><!-- test -->
    <script src="mdsrv/webapp/js/lib/signals.min.js"></script>
    <script src="mdsrv/webapp/js/lib/tether.min.js"></script>
    <script src="mdsrv/webapp/js/lib/colorpicker.min.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.extra.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.ngl.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.helper.js"></script>
    <script src="mdsrv/webapp/js/gui.js"></script>

    <!-- MDSRV -->
    <script src="mdsrv/webapp/js/mdsrv.js"></script>
    <script>
        NGL.cssDirectory = "mdsrv/webapp/css/";
        NGL.documentationUrl = "http://arose.github.io/ngl/api/";

        // Datasources
        NGL.DatasourceRegistry.add(
            "file", new MdsrvDatasource( window.location.origin + "/mdsrv/" )
        );
        NGL.DatasourceRegistry.listing = NGL.DatasourceRegistry.get( "file" );
        NGL.DatasourceRegistry.trajectory = NGL.DatasourceRegistry.get( "file" );
        document.addEventListener( "DOMContentLoaded", function(){
            stage = new NGL.Stage( "viewport" );

////////////////// Functions
        $(document).ready(function(){
        document.domain=document.domain;

        function selWithinComponent(o,dist_comp){
            var radius=Number(dist_comp[0]);
            var ligSele =dist_comp[1];
            var restriction="";
            if (ligSele.indexOf("protein and") > -1){
                restriction="not "+ligSele.slice(12)+" and ";
            }
            var sele=o.structure.getAtomSetWithinSelection( new NGL.Selection( ligSele ), radius );
            //var center=o.structure.atomCenter( new NGL.Selection( ligSele ) );
            var sele2 = o.structure.getAtomSetWithinGroup( sele );
            return([restriction,sele, sele2])
        }
        
        function trajButtons(o,dist_within_li){
            $(".ui-slider-handle").css({"height":"15px","width":"15px","border-radius":"100%","margin-top":"-7px","margin-left":"0"});
            $(".ui-slider-track").css({"height":"5px","margin-top":"7px"});
            $(".ui-slider-input").css({"font-size":"12px","padding":"2px","margin-top":"2px","margin-left":"2px"});
            var some_clicked=false;
            $(".traj_btn").click( function(){
                var btn_traj_Bid=$(this).attr("id");
                var tPatt = /\d*$/g;
                var btn_traj_id = tPatt.exec(btn_traj_Bid);
                var pos_class=$(this).attr("class");
                if(pos_class.indexOf("active") > -1){
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                    player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                    $(this).attr("class","btn btn-info btn-xs traj_btn");
                    $(this).children().attr("class","glyphicon glyphicon-play");
                    player.play();
                    player.pause();
                    some_clicked=false;
                } else if (! some_clicked){
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                    $("#trajRange").attr("max",trajComp.trajectory.numframes);
                    player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                    $("#toiframe").find("#trajRangeDiv").css("visibility","visible");
                    player.play();
                    $(this).attr("class","btn btn-danger btn-xs traj_btn active"); 
                    $(this).siblings().attr("class","btn btn-success btn-xs traj_btn"); 
                    $(this).children().attr("class","glyphicon glyphicon-pause");
                    some_clicked=true;
                    trajComp.signals.frameChanged.add(function(){
                        var fnum=trajComp.trajectory.currentFrame;
                        $("#trajRange").val(fnum);
                        $("#trajRange").slider("refresh");
                    })
                    if (dist_within_li.length > 0){
                        trajComp.signals.frameChanged.add(function(){
                            for (wth_n in dist_within_li){
                                var dist_comp=  dist_within_li[wth_n].split("-");
                                var result=selWithinComponent(o,dist_comp);
                                var restriction=result[0];
                                var sele = result[1];
                                var sele2 = result[2];
                                WthRepName="sel"+dist_comp[1];
                                stage.getRepresentationsByName(WthRepName).setSelection("protein and "+restriction + sele.toSeleString())
                                stage.getRepresentationsByName(WthRepName+"2").setSelection("protein and "+restriction + sele2.toSeleString())
                            }

                        })
                    }

                }
            });
        }

        function fromChainLiToNGL(nonGPCR){ 
            var nonGPCR_li=nonGPCR.split(",");
            var nonGPCR_mod="";
            for (chain_n in nonGPCR_li){
                nonGPCR_mod+=":"+nonGPCR_li[chain_n]+" , ";
            }
            nonGPCR_mod=nonGPCR_mod.slice(0,-3);
            return nonGPCR_mod
        }

        function clickDists(){
            var clicktrue = true;
            $("#submit", window.parent.document).click(function(){
                if (! clicktrue && lbl_name1){
                    clicktrue = true;
                    stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                    stage.getRepresentationsByName(lbl_name1).setVisibility(false)
                }
            });
            //$("#clear_dist_reps", window.parent.document).click(function(){
            $("#clear_dists_btn").on("click","#clear_dist_reps",function(){
                if (! clicktrue && lbl_name1){
                    clicktrue = true;
                    stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                    stage.getRepresentationsByName(lbl_name1).setVisibility(false);
                }
                for (repN in clickedRepLi){
                    var repNm =clickedRepLi[repN];
                    if (typeof repNm =="string"){
                        var rep_to_rv=stage.getRepresentationsByName(repNm);
                        rep_to_rv.list[0].repr.clear();
                        rep_to_rv.setVisibility(false);
                    }
                }
                /*for (cdN in compDistsLi){
                    var repNm =compDistsLi[cdN];
                    if (typeof repNm =="string"){
                        console.log(repNm)
                        var rep_to_rv=stage.getRepresentationsByName(repNm);
                        rep_to_rv.list[0].repr.clear();
                        rep_to_rv.setVisibility(false);
                    }                
                }*/
                $("#clear_dists_btn").html("");
                clickedRep={};
                clickedRepLi=[];
                clickedDist={};
                clicktrue = true;
            });
            var o=stage.getComponentsByName("my_comp").list[0];
            var hovrep;
            stage.signals.hovered.add( function( d ){
                if (d.atom){
                    var hatom = d.atom;
                    var info="["+hatom.resname.toString()+"]"+hatom.resno.toString()+":"+hatom.chainname+"."+hatom.atomname+" (atom ind: "+hatom.serial+")";
                    $("#atomInfo").text(info);
                } 
                $("#viewport").mousemove(function(){$("#atomInfo").text("")});
            })
            var atom1 , atom2 , res2 , res2, myrepr;
            var lbl_id=0;
            var dist_id=0;
            var lbl_name1, lbl_name2, dist_name;
            stage.signals.clicked.add( function( d ){
                if (clicktrue){
                    if (d.atom){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.serial+") - ";
                        $("#atomClicked").text(info)
                        lbl_name1="label_"+lbl_id.toString();
                        lbl_id+=1;
                        myrepr = o.addRepresentation( "label", {
                            sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                            color: "#ffffff", scale: 1.7, labelType: "qualified name",fontWeight: "normal", name :lbl_name1  } );
                        atom1 = d.atom.serial.toString();
                        clicktrue = false;
                    }else {
                        $("#atomClicked").text("")
                    }
                }else{
                    if (d.atom){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.serial+") - ";
                        $("#atomClicked").text(info)                                            
                        atom2 = d.atom.serial.toString();
                        //res2 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
                        clicktrue = true;
                        if (atom1 != atom2){
                            lbl_name2="label_"+lbl_id.toString();
                            lbl_id+=1;
                            dist_name="dist_"+dist_id.toString();
                            clickedDist[dist_name]=[atom1,atom2];
                            dist_id+=1;
                            var add1=[lbl_name1, lbl_name2 , dist_name];
                            var add2 = [lbl_name1, lbl_name2 , dist_name];
                            if (! clickedRep[atom1]){
                                clickedRep[atom1]=[];
                            }
                            if (! clickedRep[atom2]){
                                clickedRep[atom2]=[];
                            }
                            for (an in add1){
                                var repNm=add1[an];
                                clickedRep[atom1][clickedRep[atom1].length]=repNm;
                                if (!(repNm in clickedRepLi)){
                                    clickedRepLi.push(repNm);
                                }
                            }
                            for (an in add2){
                                clickedRep[atom2][clickedRep[atom2].length]=add2[an];
                            }
                            o.addRepresentation( "label", {
                                sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                                color: "#ffffff", scale: 1.7, labelType: "qualified name" ,fontWeight: "normal" , name:lbl_name2 } );
                            var atomPair = [[ Number(atom1), Number(atom2) ]];
                            o.addRepresentation( "distance", { atomPair: atomPair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dist_name} );

                        } else {
                            if (atom1 in clickedRep){
                                var toRv=clickedRep[atom1];
                                for (rvN in toRv){
                                    var repName=toRv[rvN];
                                    stage.getRepresentationsByName(repName).list[0].repr.clear();
                                    stage.getRepresentationsByName(repName).setVisibility(false);
                                    if (repName.substr(0, 4)=="dist"){
                                        if (repName in clickedDist){
                                            delete clickedDist[repName];
                                        }
                                    }
                                    var rvIndex = clickedRepLi.indexOf(repName);
                                    if (rvIndex > -1){
                                        clickedRepLi.splice(rvIndex, 1);
                                    }
                                }
                                if (clickedRepLi.length ==0){
                                    $("#clear_dists_btn").html("");
                                }
                                stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                                stage.getRepresentationsByName(lbl_name1).setVisibility(false);
                                delete clickedRep[atom1];
                            } else {
                                if (! clickedRep[atom1]){
                                    clickedRep[atom1]=[];
                                }
                                clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;
                                if (!(lbl_name1 in clickedRepLi)){
                                    clickedRepLi.push(lbl_name1);
                                }
                            }
                        }
                        if (clickedRepLi.length > 0){
                            $("#clear_dists_btn").html('<button class="btn btn-danger btn-xs" type="button" id="clear_dist_reps">Clear dists.</button>');
                        }
                    } else {
                        $("#atomClicked").text("");
                        clicktrue = true;
                        stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                        stage.getRepresentationsByName(lbl_name1).setVisibility(false)
                    }
                 }
            } );

        }
        
        
        function createReps(){
            parent.passInfoToIframe();

            var results = parent.results;
            //alert(results);
            cp = results[0];
            high_pre=results[1];
            sel=results[2];
            var sel_method =results[3];
            var traj =results[4];
            var nonGPCR =results[5];
            var int_res_li =results[6];
            var dist_groups_li=results[7];
            var cons_pos = parent.pd;
            var dist_within_li=parent.dist_of;
            var onlyChains="";
            var rc = parent.seeReceptor;
            var onlyChains=parent.onlyChains;
            var  pdA= high_pre["A"];
            var  pdB= high_pre["B"];
            var  pdC= high_pre["C"];
            var  pdF= high_pre["F"];
            var rc_sel = "";
            var all_cp = "";
            if (trajComp && player){
                player.pause();
            }
            
            if (rc=="y" || ! nonGPCR){
                rc_sel = "protein";
                if (cp.length > 0) {
                    rc_sel="protein or ";
                }
            }
            if (cp.length > 0){
                for (comp in cp){
                    all_cp += (cp[comp] + " or ");
                }
                all_cp = all_cp.slice(0, -3);
            }

            var visibility=true;
            if (rc=="n" && cp.length == 0 && nonGPCR){
                visibility = false;
            }

            var sele_final = "";
            if (sel && sel_method=="sel"){
               sele_final = "("+rc_sel + all_cp + ") and ("+ sel +")" ;
            } else{
               sele_final = rc_sel + all_cp;
            }

            var substr_nonGPCR="";

            if (nonGPCR){
                var nonGPCR_mod = fromChainLiToNGL(nonGPCR);
                substr_nonGPCR=" and not ("+ nonGPCR_mod+")";
            }
            var o=stage.getComponentsByName("my_comp").list[0];
            o.eachRepresentation(function(rep, comp){
                if (clickedRepLi.indexOf(rep.name) == -1){
                    //rep.clearRepresentations();
                    //rep.removeRepresentation();
                    //rep.stage.tasks.clear(),
                    rep.repr.clear();
                    rep.setVisibility(false);

                }
            }); 
            //o.updateRepresentations();
            //console.log(o);
            $("#buttons").html("");
            o.setSelection( sele_final );
            if (rc=="y"){
                o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein"+substr_nonGPCR } );
            } else {
                if (onlyChains){ //When we don't have receptor but have other prots
                    var nonGPCR_add = fromChainLiToNGL(onlyChains);
                    var add_nonGPCR=" and ("+ nonGPCR_add+")";
                    o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein"+ add_nonGPCR } );
                }

            }
            if (cp.length > 0){
                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: all_cp, radius: 0.30 } )
            }
            if (cons_pos == "y"){
                var pd_all = [pdA,pdB,pdC,pdF];
                var color_list = ["#00d8ff","#ff8500","#ccff00","#ff00d2"] // A, B, C, F
                if (sel ){
                    if (sel_method == "high"){
                        o.addRepresentation( "licorice", {  colorValue: "#00d215", radius: "0.210", sele: sel  } ); 
                    }
                }
                for (ind in pd_all) {
                    class_li=pd_all[ind];
                    if (typeof class_li == "object"){
                        if (class_li.length > 0){
                            var cons_pos_ok = class_li.join(" OR ");
                            o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele: cons_pos_ok  } );
                        }
                    }
                }   
            } else {
                if (sel ){
                    if (sel_method == "high"){
                        o.addRepresentation( "licorice", {  colorValue: "#00d215", radius: "0.210", sele: sel  } );
                    }
                }
            }


            if (dist_within_li.length > 0){
                for (wth_n in dist_within_li){
                    var dist_comp=  dist_within_li[wth_n].split("-");
                    var result=selWithinComponent(o,dist_comp);
                    var restriction=result[0];
                    var sele = result[1];
                    var sele2 = result[2];
                    WthRepName="sel"+dist_comp[1];
                    o.addRepresentation( "licorice", { colorValue:"#ff7575", radius: "0.210", sele: "protein and "+restriction + sele.toSeleString(), name:WthRepName } );
                    o.addRepresentation( "licorice", { colorValue:"#ff7575",opacity:0.5 , radius: "0.210", sele: "protein and "+restriction + sele2.toSeleString() , name:WthRepName+"2"} );
                }

            }
            if( traj.length > 0) {
                traj_li=traj;
                //var playing = false;
                var traj_html="<div style='width:536px;height:30px;overflow: auto;'>";
                for (t in traj_li_all) {
                    var mytraj=traj_li_all[t];
                    if (traj_li.indexOf(mytraj) > -1){
                        traj_html+="<button style='margin:1px' type='button' class='btn btn-success btn-xs traj_btn' id='playerButton"+t+"'><span style='vertical-align:0px' class='glyphicon glyphicon-play'></span> "+mytraj.match(/(\w*)(\.\w*)$/)[1]+"</button>"; 
                    }
                }
                traj_html+="</div>";
                $("#buttons").html(traj_html);
                trajButtons(o,dist_within_li);
            } else {
                $("#toiframe").find("#trajRangeDiv").css("visibility","hidden");
            }
            if (dist_groups_li.length>0){
                var cd_id=0;
                var plot_colors=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"]; 
                for (distgN in dist_groups_li){
                    var dist_group=dist_groups_li[distgN];
                    var dist_pair_li=dist_group.split("a");
                    for (pair_n in dist_pair_li){
                        var d_from_to_str = dist_pair_li[pair_n];
                        if (typeof d_from_to_str == "string"){
                            var d_from_to = d_from_to_str.split("-");
                            var d_from = d_from_to[0];
                            var d_to = d_from_to[1];
                            var comp_dist_name="comp_dist_"+cd_id.toString();
                           // o.addRepresentation( "label", {sele: Number(d_from), scale: 1.7, labelType: "serial"  } );
                            o.addRepresentation( "distance", { atomPair: [[Number(d_from),Number(d_to)]] , colorValue: plot_colors[pair_n], colorScheme:"uniform", labelColor: plot_colors[pair_n] ,fontWeight: "normal" ,name : comp_dist_name } );
                            //compDistsLi.push(comp_dist_name);
                            cd_id +=1;
                        }
                    }
                }
            }
            if (int_res_li.length > 0){
                for (pos_info_n in int_res_li){
                    var pos_info = int_res_li[pos_info_n];
                    var pos = pos_info[0]+":"+pos_info[1];
                    o.addRepresentation( "licorice", {  radius: "0.210", sele: pos , colorValue: "#8e74ff" } );// colorValue: "#00d215"
                    var label = pos_info[2];
                    var res_sele =  new NGL.Selection( pos );
                    var label_pos="";
                    o.structure.eachAtom(function(a){
                        if (a.atomname == "CA"){
                            label_pos=a.serial;
                        }
                    },res_sele)
                    o.addRepresentation("label", {labelType: "text", labelText:  { label_pos : label}});
                }

            }
            //o.centerView();
        }
/////////// Set variables:
            var struc=$(".str_file", window.parent.document).data("struc_file");
            var traj_li_all = [];
            var  path= "/mdsrv/file/_DB/";
            var  traj_path= "_DB/";
            $(".traj_element",window.parent.document).each(function(){
                traj_li_all[traj_li_all.length]=$(this).attr("value");
            });

            var trajComp, player;
            var clickedRep={};
            var clickedRepLi=[];
            //var compDistsLi=[];
            var clickedDist={};
            var traj_li=[];
            if (struc) {
                stage.loadFile( path + struc , {visible: true}).then( function( o ){
                        o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein" } );
                        o.setName("my_comp");
                    if( traj_li_all.length > 0 ) {
                        for (t in traj_li_all) {
                            o.addTrajectory( traj_path + traj_li_all[t] );                        
                        }
                        mytraj=traj_li_all[0];
                        traj_li=[mytraj];
                        $("#buttons").html("<div style='width:536px;height:30px;overflow: auto;'><button style='margin:1px' type='button' class='btn btn-success btn-xs traj_btn' id='playerButton0'><span style='vertical-align:0px' class='glyphicon glyphicon-play'></span> "+mytraj.match(/(\w*)(\.\w*)$/)[1])+'</button></div>'; 
                        //trajButtons(o,[]);
                    }
                    createReps();
                    stage.centerView("protein");
                    $("#submit", window.parent.document).click(function(){
                        createReps();
                    });
                    clickDists();
                });
                $("#trajRange").change(function(){
                    if (trajComp){
                        var toframe=$(".ui-slider-handle").attr("aria-valuenow");
                        trajComp.setFrame(toframe);
                    }
                });
                $("#screenshot", window.parent.document).click(function(){
                    stage.makeImage( {
                        factor: 5,
                        antialias: true,
                        trim: false,
                        transparent: false
                    } ).then( function( blob ){
                        NGL.download( blob, "screenshot.png" );
                    } );
                });
                //$(".imp_btn2", window.parent.document).click
                $(".dist_btw", window.parent.document).on("click" , ".imp_btn2" ,function(){
                
                    allClickedDists=[];
                    for (k in clickedDist){
                        allClickedDists.push(clickedDist[k]);
                    }
                    parent.clickedDistToAnalysis(allClickedDists);
                })
                $(".bckg_theme", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).siblings(".bckg_theme").removeClass("active");
                        $(this).addClass("active");
                        if ($(this).attr("id")=="bckg_light"){
                            stage.setParameters( { backgroundColor: "white" } );
                        } else {
                            stage.setParameters( { backgroundColor: "black" } );
                        }
                    }
                });
            }
        });
        });
    </script>
    <div id="toiframe" style="width:540px">
        <div id="viewport" style="width:540px; height:370px;"></div>
        <div style="height:80px">
            <div id="buttons" style="width:536px;margin-top:36px;margin-left:2px"><!-- 30+36+10 =~ 80 -->
            </div>
            <div id="clear_dists_btn" style="margin-left:3px;height:10px;margin-top:1px">
            </div>
        </div>
        <div id="trajRangeDiv" style="position:absolute;width:536px;height:30px;margin-top:245px;margin-left:2px;visibility:hidden">
          <input title="Frame" id="trajRange" type="range" name="points" id="points" value="0" min="0" max="100">
        </div>
        <div style="width:536px;height:30px;margin-top:285px;margin-left:2px;">
            <div id="atomClicked" style="color:grey;float:left;margin-right:4px;"></div>
            <div id="atomInfo" style="color:green;"></div>
        </div>
    </div>
</body>
</html>
