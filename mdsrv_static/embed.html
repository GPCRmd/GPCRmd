<!DOCTYPE html>
<html lang="en">
<head>
    <title>MDsrv/NGL - embedded</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="icon" href="mdsrv/webapp/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"><!-- test -->
    <link rel="stylesheet" href="mdsrv/webapp/css/font-awesome.min.css" />
    <link rel="stylesheet" href="mdsrv/webapp/css/main.css" />
    <link rel="subresource" href="mdsrv/webapp/css/light.css" />
    <link rel="subresource" href="mdsrv/webapp/css/dark.css" />

</head>
<body >
    <!-- NGL -->
    <script src="mdsrv/webapp/js/ngl.js"></script>

    <!-- UI -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script><!-- test -->
    <script src="mdsrv/webapp/js/lib/signals.min.js"></script>
    <script src="mdsrv/webapp/js/lib/tether.min.js"></script>
    <script src="mdsrv/webapp/js/lib/colorpicker.min.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.extra.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.ngl.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.helper.js"></script>
    <script src="mdsrv/webapp/js/gui.js"></script>

    <!-- MDSRV -->
    <script src="mdsrv/webapp/js/mdsrv.js"></script>
    <script>
        NGL.cssDirectory = "mdsrv/webapp/css/";
        NGL.documentationUrl = "http://arose.github.io/ngl/api/";

        // Datasources
        NGL.DatasourceRegistry.add(
            "file", new MdsrvDatasource( window.location.origin + "/mdsrv/" )
        );
        NGL.DatasourceRegistry.listing = NGL.DatasourceRegistry.get( "file" );
        NGL.DatasourceRegistry.trajectory = NGL.DatasourceRegistry.get( "file" );
        document.addEventListener( "DOMContentLoaded", function(){
            stage = new NGL.Stage( "viewport" );

////////////////// Functions
        $(document).ready(function(){
        document.domain=document.domain;
        stage.setParameters( { backgroundColor: "white" /*, cameraType:"orthographic"*/} );
        
        
        function selWithinComponent(o,dist_comp){
            var show = dist_comp[0];
            var radius=Number(dist_comp[1]);
            var ligSele =dist_comp[2];
            var sele=o.structure.getAtomSetWithinSelection( new NGL.Selection( ligSele ), radius );
            //var center=o.structure.atomCenter( new NGL.Selection( ligSele ) );
            var sele2 = o.structure.getAtomSetWithinGroup( sele );
            return([sele, sele2]);
        }
        
        function trajButtons(o){
            $(".ui-slider").css({"margin-left":"25px"});
            $(".ui-slider-handle").css({"height":"15px","width":"15px","border-radius":"100%","margin-top":"-7px","margin-left":"0"});
            $(".ui-slider-track").css({"height":"5px","margin-top":"7px"});
            $(".ui-slider-input").css({"font-size":"10px","padding":"2px","margin-top":"2px","margin-left":"6px"});
            $("#toiframe").find("#trajRangeDiv").css("visibility","visible");
            $(".traj_btn").click( function(){
                parent.passinfoToPlayTraj();
                var bs_info = parent.bs_info;
                var dist_within_li=parent.dist_of;  
            
                var btn_traj_Bid=$(this).attr("id");
                var tPatt = /\d*$/g;
                var btn_traj_id = tPatt.exec(btn_traj_Bid);
                var isact = $(this).hasClass("active");
                //var pos_class=$(this).attr("class");
                if(isact){
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                    player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                    player.step=stepsize;
                    $(this).removeClass("active");
                    $(this).children().attr("class","glyphicon glyphicon-play");
                    player.play();
                    player.pause();
                } else {
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                    $("#trajRange").attr("max",trajComp.trajectory.numframes);
                    player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                    player.step=stepsize;
                    //$("#toiframe").find("#trajRangeDiv").css("visibility","visible");
                    player.play();
                    $(this).addClass("active");
                    $(this).siblings().removeClass("active");
                    $(this).children().attr("class","glyphicon glyphicon-pause");
                    var patt = new RegExp("/(.*)$");
                    var res = patt.exec(traj_li_all[btn_traj_id]);
                    var mytraj_nm=res[1];
                    $("#last_played").text(mytraj_nm);
                    trajComp.signals.frameChanged.add(function(){
                        var fnum=trajComp.trajectory.currentFrame;
                        $("#trajRange").val(fnum);
                        $("#trajRange").slider("refresh");
                        if (bs_info.length > 0){
                            var bs_info_li=bs_info.split("-");
                            var recept =bs_info_li[0];
                            var ligli=bs_info_li[1].split(",");
                            var bsnum =0;
                            for (liN = 0; liN < ligli.length; liN++){
                                var lig = ligli[liN];
                                var result = selWithinComponent(o,[recept , "2.5" ,lig ]);
                                var sele = result[0];
                                var sele2 = result[1];
                                BSRepName="BS"+bsnum.toString();
                                stage.getRepresentationsByName(BSRepName).setSelection(recept+" and "+sele.toSeleString());
                                stage.getRepresentationsByName(BSRepName+"_2").setSelection(recept+" and "+ sele2.toSeleString());
                                bsnum+=1;
                            }
                        }
                        if (dist_within_li.length > 0){
                            for (wth_n in dist_within_li){
                                var dist_comp=  dist_within_li[wth_n].split("-");
                                var show=dist_comp[0];
                                var ligSele=dist_comp[2];
                                var restriction="";
                                var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                                if (show_sup != "NONE"){
                                    restriction="not ("+ligSele+") and ";
                                } 
                                var result=selWithinComponent(o,dist_comp);
                                var sele = result[0];
                                var sele2 = result[1];
                                WthRepName="sel"+dist_comp[2];
                                stage.getRepresentationsByName(WthRepName).setSelection(show+" and "+restriction + sele.toSeleString());
                                stage.getRepresentationsByName(WthRepName+"2").setSelection(show+" and "+restriction + sele2.toSeleString());
                            }
                        }
                    });
                }
            });
        }

        function fromChainLiToNGL(nonGPCR){ 
            var nonGPCR_li=nonGPCR.split(",");
            var nonGPCR_mod="";
            for (chain_n in nonGPCR_li){
                nonGPCR_mod+=":"+nonGPCR_li[chain_n]+" , ";
            }
            nonGPCR_mod=nonGPCR_mod.slice(0,-3);
            return nonGPCR_mod;
        }
        
        function clearDists(clicktrue,lbl_name1){
            if (! clicktrue && lbl_name1){
                clicktrue = true;
                stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                stage.getRepresentationsByName(lbl_name1).setVisibility(false);
            }
            for (repN in clickedRepLi){
                var repNm =clickedRepLi[repN];
                if (typeof repNm =="string"){
                    var rep_to_rv=stage.getRepresentationsByName(repNm);
                    rep_to_rv.list[0].repr.clear();
                    rep_to_rv.setVisibility(false);
                }
            }
            $("#clear_dists_btn").html("");
            clickedRep={};
            clickedRepLi=[];
            clickedDistData={};
            clickedLabData={};
            clickedDist={};
            clicktrue = true;
            return(clicktrue);
        }
        
        function clickDists(){
            var clicktrue = true;
            $("#selectionDiv", window.parent.document).click(function(){
                if (! clicktrue && lbl_name1){
                    clicktrue = true;
                }
            });
            //$("#clear_dist_reps", window.parent.document).click(function(){
            $("#clear_dists_btn").on("click","#clear_dist_reps",function(){
                clicktrue=clearDists(clicktrue,lbl_name1);
            });
            $("#clearAll", window.parent.document).click(function(){
                clicktrue=clearDists(clicktrue,lbl_name1);
            });            
            var o=stage.getComponentsByName("my_comp").list[0];
            var hovrep;
            stage.signals.hovered.add( function( d ){
                if (d.atom){
                    var hatom = d.atom;
                    var info="["+hatom.resname.toString()+"]"+hatom.resno.toString()+":"+hatom.chainname+"."+hatom.atomname+" (atom ind: "+hatom.index+")";
                    $("#atomInfo").text(info);
                } 
                $("#viewport").mousemove(function(){$("#atomInfo").text("")});
            });
            var atom1 , atom2 , res2 , res2, myrepr;
            var lbl_id=0;
            var dist_id=0;
            var lbl_name1, lbl_name2, dist_name ,labsele1 , labsele2 , labsele1;
            stage.signals.clicked.add( function( d ){
                if (clicktrue){
                    if (d.atom){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.index+") - ";
                        $("#atomClicked").text(info);
                        lbl_name1="label_"+lbl_id.toString();
                        lbl_id+=1;
                        labsele1=d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname;
                        myrepr = o.addRepresentation( "label", {
                            sele: labsele1,
                            color: "#cccccc", scale: 1.7, labelType: "qualified name",fontWeight: "normal", name :lbl_name1  } );
                        atom1 = d.atom.index.toString();
                        clicktrue = false;
                    }else {
                        $("#atomClicked").text("");
                    }
                }else{
                    if (d.atom){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.index+") - ";
                        $("#atomClicked").text(info);                                            
                        atom2 = d.atom.index.toString();
                        //res2 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
                        clicktrue = true;
                        if (atom1 != atom2){
                            lbl_name2="label_"+lbl_id.toString();
                            lbl_id+=1;
                            dist_name="dist_"+dist_id.toString();
                            clickedDist[dist_name]=[atom1,atom2];
                            dist_id+=1;
                            var add1=[lbl_name1, lbl_name2 , dist_name];
                            var add2 = [lbl_name1, lbl_name2 , dist_name];
                            if (! clickedRep[atom1]){
                                clickedRep[atom1]=[];
                            }
                            if (! clickedRep[atom2]){
                                clickedRep[atom2]=[];
                            }
                            for (an in add1){
                                var repNm=add1[an];
                                clickedRep[atom1][clickedRep[atom1].length]=repNm;
                                if (!(repNm in clickedRepLi)){
                                    clickedRepLi.push(repNm);
                                }
                            }
                            for (an in add2){
                                clickedRep[atom2][clickedRep[atom2].length]=add2[an];
                            }
                            labsele2=d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname;
                            o.addRepresentation( "label", {
                                sele: labsele2,
                                color: "#cccccc", scale: 1.7, labelType: "qualified name" ,fontWeight: "normal" , name:lbl_name2 } );
                            var atomPair = [[ Number(atom1), Number(atom2) ]];
                            o.addRepresentation( "distance", { atomPair: atomPair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dist_name} );
                            clickedDistData[dist_name]=atomPair;
                            clickedLabData[lbl_name1]=labsele1;
                            clickedLabData[lbl_name2]=labsele2; 

                        } else {
                            if (atom1 in clickedRep){
                                var toRv=clickedRep[atom1];
                                for (rvN in toRv){
                                    var repName=toRv[rvN];
                                    stage.getRepresentationsByName(repName).list[0].repr.clear();
                                    stage.getRepresentationsByName(repName).setVisibility(false);
                                    if (repName.substr(0, 4)=="dist"){
                                        if (repName in clickedDist){
                                            delete clickedDist[repName];
                                        }
                                        if (repName in clickedDistData){
                                            delete clickedDistData[repName];
                                        }
                                    } else {
                                        if (repName in clickedLabData){
                                            delete clickedLabData[repName];
                                        }
                                    }
                                    var rvIndex = clickedRepLi.indexOf(repName);
                                    if (rvIndex > -1){
                                        clickedRepLi.splice(rvIndex, 1);
                                    }
                                }
                                if (clickedRepLi.length ==0){
                                    $("#clear_dists_btn").html("");
                                }
                                
                                stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                                stage.getRepresentationsByName(lbl_name1).setVisibility(false);
                                delete clickedRep[atom1];
                            } else {
                                if (! clickedRep[atom1]){
                                    clickedRep[atom1]=[];
                                }
                                clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;
                                if (!(lbl_name1 in clickedRepLi)){
                                    clickedRepLi.push(lbl_name1);
                                }
                                clickedLabData[lbl_name1]=labsele1;
                            }
                        }
                        if (clickedRepLi.length > 0){
                            $("#clear_dists_btn").html('<button class="btn btn-danger btn-xs" type="button" id="clear_dist_reps">Clear labels/dists.</button>');
                        }
                    } else {
                        $("#atomClicked").text("");
                        clicktrue = true;
                        stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                        stage.getRepresentationsByName(lbl_name1).setVisibility(false);
                    }
                 }
            } );

        }
        
        function res_to_atom(o,d_info){
            var d_all=d_info.split(":");
            var res=d_all[0];
            var chain=d_all[1];
            var atmn=d_all[2];
            var res_sele =  new NGL.Selection( res+":"+chain );
            //console.log(res_sele)
            //console.log(atmn);
            var mypos="";
            o.structure.eachAtom(function(a){
                if (a.atomname == atmn){
                    mypos=a.index;
                }
            },res_sele);
            //console.log(mypos);
            //console.log("------");
            return(mypos)
        }
        
        function createReps(){
            parent.passInfoToIframe();

            var results = parent.results;
            var cp = results["cp"];
            var high_pre=results["high_pre"];
            var layers_li = results["layers_li"];
            //var traj =results["traj"];
            var nonGPCR =results["nonGPCR"];
            var int_res_li =results["int_res_li"];
            var int_res_li_ch =results["int_res_li_ch"];
            var dist_groups_li=results["dist_groups_li"];
            var receptorsel = results["receptorsel"]; 
            var bs_info= results["bs_info"]; 
            var hbonds= results["hbondarray"];
            var sbonds_atoms= results["sbondarray"];
            var all_resids=results["allresidshb"];
            var all_resids_inter=results["allresidshbInt"];
            var all_resids_sb=results["allresidssb"];
            var hbonds_inter=results["hb_inter"];
            var sasa_resids=results["all_resids_sasa"];
            var cons_pos = parent.pd; //[!!!]
            var dist_within_li=parent.dist_of;
            var  pdA= high_pre["A"];
            var  pdB= high_pre["B"];
            var  pdC= high_pre["C"];
            var  pdF= high_pre["F"];
            

            /*for (e in receptorsel){
                console.log(receptorsel[e]);
            };*/
            //for (e in cons_pos){console.log(cons_pos[e])};

            
            var o=stage.getComponentsByName("my_comp").list[0];
            var saveRepLi=[];
            o.eachRepresentation(function(rep, comp){
                if (clickedRepLi.indexOf(rep.name) > -1){
                    saveRepLi.push(rep);
                }
            });
            
            o.clearRepresentations();
            for (lname in clickedLabData){
                var lsele=clickedLabData[lname];
                o.addRepresentation( "label", {
                    sele: lsele,
                    color: "#cccccc", scale: 1.7, labelType: "qualified name" ,fontWeight: "normal" , name:lname } );
            }
            for (dname in clickedDistData){
                var apair=clickedDistData[dname];
                o.addRepresentation( "distance", { atomPair: apair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dname} );
            }

            /*//o.clearRepresentations();
            
            o.eachRepresentation(function(rep, comp){
                if (clickedRepLi.indexOf(rep.name) == -1){
                    //rep.clearRepresentations();
                    //rep.removeRepresentation();
                    //rep.stage.tasks.clear(),
                    rep.repr.clear();
                    rep.setVisibility(false);

                }
            }); */
            //o.updateRepresentations();
            //console.log(o);
            $("#buttons").html("");
            o.setSelection( "*" );
          
            
            
            if (receptorsel.length > 0){
                o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: receptorsel } );
            } 
            
            if (nonGPCR.length > 0){
                for (ng in nonGPCR){
                    chains_s = nonGPCR[ng];
                    nonGPCR_sel = "protein and ("+ fromChainLiToNGL(chains_s) + ")";
                    o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: nonGPCR_sel } );
                }
            }
            if (cp.length > 0){
                var all_cp="";
                for (comp in cp){
                    all_cp += (cp[comp] + " or ");
                }
                all_cp = all_cp.slice(0, -3);
                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: all_cp, radius: 0.30 } );            
            }
            if (cons_pos == "y"){
                var pd_all = [pdA,pdB,pdC,pdF];
                var color_list = ["#00d8ff","#ff8500","#ccff00","#ff00d2"]; // A, B, C, F
                for (ind in pd_all) {
                    class_li=pd_all[ind];
                    if (typeof class_li == "object"){
                        if (class_li.length > 0){
                            var cons_pos_ok = class_li.join(" OR ");
                            o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele: "protein and ("+ cons_pos_ok +")" } );
                                                   
                        }
                    }
                }  
            }            
            
            if (layers_li.length > 0){
                for (lN in layers_li){
                    var layer_all = layers_li[lN];
                    var sel = layer_all[0];
                    var rep = layer_all[1];
                    var color = layer_all[2];
                    var scheme = layer_all[3];
                    o.addRepresentation( rep, {  colorValue: color, /*radius: "0.210" ,*/ sele: sel , colorScheme: scheme } ); 
                }
            }
            
            if (bs_info.length > 0){
                var bs_info_li=bs_info.split("-");
                var recept =bs_info_li[0];
                var ligli=bs_info_li[1].split(",");
                var bsnum =0;
                for (liN = 0; liN < ligli.length; liN++){
                    var lig = ligli[liN];
                    var result = selWithinComponent(o,[recept , "2.5" ,lig ]);
                    var sele = result[0];
                    var sele2 = result[1];
                    BSRepName="BS"+bsnum.toString();
                    o.addRepresentation( "licorice", { colorValue:"#6fffc9", radius: "0.210", sele: recept+" and "+ sele.toSeleString(), name:BSRepName } );
                    o.addRepresentation( "licorice", { colorValue:"#6fffc9",opacity:0.5 , radius: "0.210", sele: recept+" and "+ sele2.toSeleString() , name:BSRepName+"_2"} );
                    bsnum+=1;
                }
                
            }

            if (dist_within_li.length > 0){
                for (wth_n in dist_within_li){
                    var dist_comp=  dist_within_li[wth_n].split("-");
                    var show = dist_comp[0];
                    var ligSele=dist_comp[2];
                    var restriction="";
                    var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                    if (show_sup != "NONE"){
                        o.addRepresentation( "licorice", { colorValue:"#dcffae", radius: "0.210", sele: ligSele, name:"sel_within_0" } );
                        restriction="not ("+ligSele+") and ";
                    }   
                    var result=selWithinComponent(o,dist_comp);
                    var sele = result[0];
                    var sele2 = result[1];
                    WthRepName="sel"+ligSele;
                    o.addRepresentation( "licorice", { colorValue:"#ff7575", radius: "0.210", sele: show+" and "+restriction + sele.toSeleString(), name:WthRepName } );
                    o.addRepresentation( "licorice", { colorValue:"#ff7575",opacity:0.5 , radius: "0.210", sele: show+" and "+restriction + sele2.toSeleString() , name:WthRepName+"2"} );
                }

            }
            if ( ! mytraj){
                $("#toiframe").find("#trajRangeDiv").css("visibility","hidden");
            }
            
            /*if( traj.length > 0) {
                traj_li=traj;
                //var playing = false;
                var traj_html="<div style='width:586px;height:30px;overflow: auto;'>";
                for (t in traj_li_all) {
                    var mytraj=traj_li_all[t];
                    if (traj_li.indexOf(mytraj) > -1){
                        traj_html+="<button style='margin:1px' type='button' class='btn btn-success btn-xs traj_btn' id='playerButton"+t+"'><span style='vertical-align:0px' class='glyphicon glyphicon-play'></span> "+mytraj.match(/(\w*)(\.\w*)$/)[1]+"</button>"; 
                    }
                }
                traj_html+="</div>";
                $("#buttons").html(traj_html);
                trajButtons(o,dist_within_li);
            } else {
                $("#toiframe").find("#trajRangeDiv").css("visibility","hidden");
            }*/
            if (dist_groups_li.length>0){
                var cd_id=0;
                var plot_colors=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"]; 
                for (distgN in dist_groups_li){
                    var dist_group=dist_groups_li[distgN];
                    var dist_pair_li=dist_group.split(",");
                    for (pair_n in dist_pair_li){
                        var d_from_to_str = dist_pair_li[pair_n];
                        if (typeof d_from_to_str == "string"){
                            var d_from_to = d_from_to_str.split("-");
                            var d_from = d_from_to[0];
                            var d_to = d_from_to[1];
                            if (d_from_to_str.indexOf(":") > -1){
                                d_from=res_to_atom(o,d_from);
                                d_to=res_to_atom(o,d_to);
                            } 
                            var comp_dist_name="comp_dist_"+cd_id.toString();
                           // o.addRepresentation( "label", {sele: Number(d_from), scale: 1.7, labelType: "serial"  } );
                            o.addRepresentation( "distance", { atomPair: [[Number(d_from),Number(d_to)]] , colorValue: plot_colors[pair_n], colorScheme:"uniform", labelColor: plot_colors[pair_n] ,fontWeight: "normal" ,name : comp_dist_name } );
                            //compDistsLi.push(comp_dist_name);
                            cd_id +=1;
                        }
                    }
                }
            }

            if (sasa_resids.length > 0) {
                if (typeof(sasa_resids)=='string') {
                    resids='not water';
                }else{
                    var resids= 'protein and';
                    resids=resids+' ('+sasa_resids.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                }
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
            }

            if (hbonds.length > 0){
                var resids= 'protein and';
                resids=resids+' ('+all_resids.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                o.addRepresentation( "distance", { atomPair: hbonds , colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
            }

            if (hbonds_inter.length > 0){
                var resids='not water and';
                resids=resids+' ('+all_resids_inter.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                o.addRepresentation( "distance", { atomPair: hbonds_inter, colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
            }

            if (sbonds_atoms.length > 0){
                var resids='protein and ';
                resids=resids + '( '+ all_resids_sb.join(' or ') + ')';
                o.addRepresentation( "distance", { atomPair: sbonds_atoms , colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
            }

            if (int_res_li.length > 0){
                var final_sele=[];
                for (pos_info_n in int_res_li){
                    var pos_info = int_res_li[pos_info_n];
                    var pos = pos_info[0]+":"+pos_info[1];
                    final_sele.push(pos);
                    var label = pos_info[2];
                    var res_sele =  new NGL.Selection( pos );
                    var label_pos="";
                    o.structure.eachAtom(function(a){
                        if (a.atomname == "CA"){
                            label_pos=a.index;
                        }
                    },res_sele);
                    o.addRepresentation("label", {labelType: "text", labelText:  { label_pos : label}});
                }
                final_sele=final_sele.join(" , ");
                o.addRepresentation( "licorice", {  radius: "0.210", sele: final_sele , colorValue: "#8e74ff" } );// colorValue: "#00d215"

            }
            
            if (int_res_li_ch.length > 0){
                var final_sele=[];
                for (pos_info_n in int_res_li_ch){
                    var pos_info = int_res_li_ch[pos_info_n];
                    var pos = pos_info[0]+":"+pos_info[1];
                    final_sele.push(pos);
                    var label = pos_info[2];
                    var res_sele =  new NGL.Selection( pos );
                    var label_pos="";
                    o.structure.eachAtom(function(a){
                        if (a.atomname == "CA"){
                            label_pos=a.index;
                        }
                    },res_sele);
                    o.addRepresentation("label", {labelType: "text", labelText:  { label_pos : label}});
                }
                final_sele=final_sele.join(" , ");
                o.addRepresentation( "licorice", {  radius: "0.300", sele: final_sele , colorValue:"#f2e14e"/*"#461bff"*/ } );// colorValue: "#00d215"

            }

            //o.centerView();
        }
/////////// Set variables:
            var struc=$(".str_file", window.parent.document).data("struc_file");
            var traj_li_all = [];
            var  path= "/mdsrv/file/_DB/";
            var  traj_path= "_DB/";
            $(".traj_element",window.parent.document).each(function(){
                traj_li_all[traj_li_all.length]=$(this).data("tpath");
            });
            var trajComp, player, ori ;
            var clickedRep={};
            var clickedRepLi=[];
            var clickedDistData={};
            var clickedLabData={};
            //var compDistsLi=[];
            var clickedDist={};
            var stepsize = 3;
            var mytraj=$("#selectedTraj" , window.parent.document).data("tpath");
            if (struc) {
                stage.loadFile( path + struc , {visible: true}).then( function( o ){
                        o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: "protein" } );
                        o.setName("my_comp");
                    if( traj_li_all.length > 0 ) {
                        for (t=0 ; t < traj_li_all.length ; t++){
                            o.addTrajectory( traj_path + traj_li_all[t] );                        
                        }
                        trajComp = stage.getComponentsByName("my_comp").list[0].trajList[0]; 
                        var patt = new RegExp("/(.*)$");
                        var res = patt.exec(traj_li_all[0]);
                        var mytraj_nm=res[1];
                        $("#last_played").text(mytraj_nm);
                        //traj_li=[mytraj];
                        //$("#buttons").html("<div style='width:586px;height:30px;overflow: auto;'><button style='margin:1px' type='button' class='btn btn-success btn-xs traj_btn' id='playerButton0'><span style='vertical-align:0px' class='glyphicon glyphicon-play'></span> "+mytraj.match(/(\w*)(\.\w*)$/)[1])+'</button></div>'; 
                    }
                    $(".traj_element" , window.parent.document).click(function(){
                        mytraj=$(this).data("tpath");
                        traj_id=traj_li_all.indexOf(mytraj);
                        $(".traj_btn").attr("id","playerButton"+traj_id.toString());
                        if (player && $(".traj_btn").hasClass("active")){
                            player.pause();
                            $(".traj_btn").removeClass("active");
                            $(".traj_btn").children().attr("class","glyphicon glyphicon-play");
                        }
                    });
                    trajButtons(o);
                    createReps();
                    stage.centerView("protein");
                    ori= stage.getOrientation();

                    $("#clearAll", window.parent.document).click(function(){
                        createReps();
                    });
                    
                    
                    $("#selectionDiv", window.parent.document).on("click" , function(){
                        createReps();
                    });

                    //selChange();      

                    clickDists();


                });
////////////SETTINGS:
                $("#trajRange").change(function(){
                    /*var btn_traj_Bid=$(".traj_btn").attr("id");
                    var tPatt = /\d*$/g;
                    var btn_traj_id = tPatt.exec(btn_traj_Bid);
                    var patt = new RegExp("/(.*)$");
                    var res = patt.exec(traj_li_all[btn_traj_id]);
                    var mytraj_nm=res[1];
                    $("#last_played").text(mytraj_nm); 
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];                
                    $("#trajRange").attr("max",trajComp.trajectory.numframes);
                    var toframe=$(".ui-slider-handle").attr("aria-valuenow");
                    trajComp.setFrame(toframe);*/
                    if (trajComp){
                        numfr=trajComp.trajectory.numframes;
                        if ($("#trajRange").attr("max") != numfr){
                            $("#trajRange").attr("max",numfr);
                        }
                        var toframe=$(".ui-slider-handle").attr("aria-valuenow"); 
                        trajComp.setFrame(toframe);
                    }
                });
                $("#screenshot", window.parent.document).click(function(){
                    stage.makeImage( {
                        factor: 5,
                        antialias: true,
                        trim: false,
                        transparent: false
                    } ).then( function( blob ){
                        NGL.download( blob, "screenshot.png" );
                    } );
                });
                //$(".imp_btn2", window.parent.document).click
                $(".dist_btw", window.parent.document).on("click" , ".imp_btn2" ,function(){
                
                    allClickedDists=[];
                    for (k in clickedDist){
                        allClickedDists.push(clickedDist[k]);
                    }
                    parent.clickedDistToAnalysis(allClickedDists);
                });
                
                $("#background", window.parent.document).click(function(){
                    if ($(this).hasClass("light")){
                        stage.setParameters( { backgroundColor: "black" } );
                        $(this).removeClass("light");
                        $(this).addClass("dark");
                        $(this).attr("title","Light background");
                    }else if ($(this).hasClass("dark")){
                        stage.setParameters( { backgroundColor: "white" } );
                        $(this).removeClass("dark");
                        $(this).addClass("light");
                        $(this).attr("title","Dark background");
                    }
                });
                
                /*$(".bckg_theme", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).siblings(".bckg_theme").removeClass("active");
                        $(this).addClass("active");
                        if ($(this).attr("id")=="bckg_light"){
                            stage.setParameters( { backgroundColor: "white" } );
                        } else {
                            stage.setParameters( { backgroundColor: "black" } );
                        }
                    }
                });*/
                $("#center", window.parent.document).click(function(){
                    //stage.setOrientation([[-1.504730224609375, 2.6254119873046875, 1.9448356628417969], [-1.504730224609375, 2.6254119873046875, -117.27891736575096], [0, 1, 0]])
                    stage.centerView();
                });
                $("#restartPos", window.parent.document).click(function(){
                    stage.setOrientation(ori);
                });
                
                $(".projectionOP", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).addClass("active");
                        $(this).siblings(".projectionOP").removeClass("active");
                        if ($(this).attr("id") == "projOrtho"){
                            stage.setParameters( { cameraType: "orthographic"} );
                        } else {
                            stage.setParameters( { cameraType: "perspective"} );
                        }
                    }
                });
                $(".spinSet", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).addClass("active");
                        $(this).siblings(".spinSet").removeClass("active");
                        if ($(this).attr("id") == "spinOn"){
                            stage.setSpin( [ 0, 1, 0 ], 0.01 );
                        } else {
                            stage.setSpin( null );
                        }
                    }
                });
                $("#trajStep", window.parent.document).on("change" , function(){
                    var tajstep = $(this).val();
                    if (tajstep){
                        tajstep = Number(tajstep);
                        var pos = Math.abs(tajstep)
                        var rounded= Math.round(pos);
                        if (rounded <= 0){
                            var rounded = 1;
                        } 
                        if (tajstep != rounded){
                            tajstep = rounded;
                            $(this).val(tajstep);
                        }
                    } else {
                        tajstep=3;
                    }
                    if (player && $(".traj_btn").hasClass("active")){
                        player.pause();
                        $(".traj_btn").removeClass("active");
                        $(".traj_btn").children().attr("class","glyphicon glyphicon-play");
                    }
                    stepsize = tajstep;
                });
                
            }
        });
        });
    </script>
    <div id="toiframe" style="width:590px">
        <div id="viewport" style="width:590px; height:370px;"></div>
        <div style="height:80px">
            <div id="buttons" style="width:586px;margin-top:36px;margin-left:2px"><!-- 30+36+10 =~ 80 -->
            </div>
            <div id="clear_dists_btn" style="margin-left:3px;height:10px;margin-top:65px">
            </div>
        </div>
        <div id="trajRangeDiv" style="position:absolute;width:586px;height:30px;margin-top:215px;margin-left:2px;visibility:hidden">
            <p style="margin-right:18px;font-size:12px;color:#B8B8B8" class="pull-right" id="last_played"></p>
            <div style="font-size: 17px;float: left;padding:0;border:none;width:20px;background-color:transparent;margin:10px 0 0 5px;cursor:pointer" class="traj_btn" id=playerButton0><span class="glyphicon glyphicon-play" style="color:#808080"></div>

          <input title="Frame" id="trajRange" type="range" name="points" id="points" value="0" min="0" max="100">
        </div>
        <div style="width:586px;height:30px;margin-top:260px;margin-left:2px;">
            <div id="atomClicked" style="color:grey;float:left;margin-right:4px;"></div>
            <div id="atomInfo" style="color:green;"></div>
        </div>
    </div>
</body>
</html>
