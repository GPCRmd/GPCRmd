<!DOCTYPE html>
<html lang="en">
<head>
    <title>MDsrv/NGL - embedded</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="icon" href="mdsrv/webapp/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="mdsrv/webapp/css/font-awesome.min.css" />
    <link rel="stylesheet" href="mdsrv/webapp/css/main.css" />
    <link rel="subresource" href="mdsrv/webapp/css/light.css" />
    <link rel="subresource" href="mdsrv/webapp/css/dark.css" />
</head>
<body >
    <!-- NGL -->
    <script src="mdsrv/webapp/js/ngl.js"></script>

    <!-- UI -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="mdsrv/webapp/js/lib/signals.min.js"></script>
    <script src="mdsrv/webapp/js/lib/tether.min.js"></script>
    <script src="mdsrv/webapp/js/lib/colorpicker.min.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.extra.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.ngl.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.helper.js"></script>
    <script src="mdsrv/webapp/js/gui.js"></script>

    <!-- MDSRV -->
    <script src="mdsrv/webapp/js/mdsrv.js"></script>

    <script>
        NGL.cssDirectory = "mdsrv/webapp/css/";
        NGL.documentationUrl = "http://arose.github.io/ngl/api/";

        // Datasources
        NGL.DatasourceRegistry.add(
            "file", new MdsrvDatasource( window.location.origin + "/mdsrv/" )
        );
        NGL.DatasourceRegistry.listing = NGL.DatasourceRegistry.get( "file" );
        NGL.DatasourceRegistry.trajectory = NGL.DatasourceRegistry.get( "file" );
        document.addEventListener( "DOMContentLoaded", function(){
            stage = new NGL.Stage( "viewport" );

////////////////// Functions
        function click_unclick(class_name, some_clicked){
            $(class_name).click(function(){
                pos_class=$(this).attr("class");
                if(pos_class.indexOf("active") > -1){
//                    alert("inactivate");
//                    $(this).removeClass("active");
                    $(this).attr("class","btn btn-success btn-xs traj_btn");
                    some_clicked=false;
                } else if (! some_clicked){
                    //$(this).addClass("active");
                    $(this).attr("class","btn btn-danger btn-xs traj_btn active"); 
                    some_clicked=true;
                }
            });
        }

/////////// URL variables:
            //var load = NGL.getQuery( "load" );
                   var  struc= NGL.getQuery("struc");
                   var  rc= NGL.getQuery("rc");
                   var  sel= NGL.getQuery("sel");
                   var  sel_method= NGL.getQuery("sh");
                   var  cons_pos= NGL.getQuery("pd");
                   var  pdA= NGL.getQuery("la");
                   var  pdB= NGL.getQuery("lb");
                   var  pdC= NGL.getQuery("lc");
                   var  pdF= NGL.getQuery("lf");
                   var  cp= NGL.getQuery("cp");
                   var  path= "/mdsrv/file/_DB/";
                   var  traj_path= "_DB/";
                   var traj = NGL.getQuery( "traj" );
                   var  dist_within= NGL.getQuery("wth");
                   var  show_dist= NGL.getQuery("sd");
                   var  comp_dist= NGL.getQuery("di");
                   var  nonGPCR= NGL.getQuery("ng");
                   var  onlyChains= NGL.getQuery("och");


                    var rc_sel = "";
                    var all_cp = "";
                    if (rc=="y" || ! nonGPCR){
                        rc_sel = "protein";
                        if (cp) {
                            rc_sel="protein or ";
                        }
                    }
                    if (cp){
                        var cp_li = decodeURIComponent(cp.replace(/\+/g, " ")).split(",");
                        for (comp in cp_li){
                            all_cp += (cp_li[comp] + " or ");
                        }
                        all_cp = all_cp.slice(0, -3);
                    }

                    /*var cart_scheme ="sstruc";
                    if (sel_method=="high" || cons_pos=="y"){
                        cart_scheme = "uniform";
                    }*/
                    var visibility=true;
                    if (rc=="n" && ! cp && nonGPCR){
                        visibility = false;
                    }

                    var sele_final = "";
                    if (sel && sel_method=="sel"){
	               var sel_deco=decodeURIComponent(sel.replace(/\+/g, " "));
                       sele_final = "("+rc_sel + all_cp + ") and ("+ sel_deco +")" ;
                    } else{
                       sele_final = rc_sel + all_cp;
                    }
                  
                    function fromChainLiToNGL(nonGPCR){ 
                        var nonGPCR_li=nonGPCR.split(",");
                        var nonGPCR_mod="";
                        for (chain_n in nonGPCR_li){
                            nonGPCR_mod+=":"+nonGPCR_li[chain_n]+" , ";
                        }
                        nonGPCR_mod=nonGPCR_mod.slice(0,-3);
                        return nonGPCR_mod
                    }

                    var substr_nonGPCR="";

                    if (nonGPCR){
                        var nonGPCR_mod = fromChainLiToNGL(nonGPCR);
                        substr_nonGPCR=" and not ("+ nonGPCR_mod+")";
                    }

                    if (struc) {
			    stage.loadFile( path + struc , {sele: sele_final, visible: visibility}).then( function( o ){
				stage.setOrientation([[-133.5657750896191,-72.54646915024105,3.7714955141361095],[-0.06193670847497234,0.062245585853203875,-0.9961372049999252],[-0.9979991912841797,-0.38649940490722656,-3.1299991607666016],[0,0,0]]);
                                o.setName("my_comp");
                                if (rc=="y"){
                                    o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein"+substr_nonGPCR } );
                                    /*if ((sel_method =="high" && sel) || cons_pos =="y" || dist_within ) {
                                        o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: "protein"+substr_nonGPCR } );
                                     }else{
                                        o.addRepresentation( "cartoon", { colorScheme: "sstruc", sele: "protein" +substr_nonGPCR } );
                                     }*/
                                 } else {
                                    if (onlyChains){ //When we don't have receptor but have other prots
                                        var nonGPCR_add = fromChainLiToNGL(onlyChains);
                                        var add_nonGPCR=" and ("+ nonGPCR_add+")";
                                        o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein"+ add_nonGPCR } );
                                    }
                                    /* if ((sel_method =="high" && sel) || cons_pos =="y" || dist_within ) {
                                        o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: "protein"+add_nonGPCR } );
                                     }else{
                                        o.addRepresentation( "cartoon", { colorScheme: "sstruc", sele: "protein" +add_nonGPCR } );
                                     }*/

                                 }
                                if (cp){
                                    o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: all_cp, radius: 0.30 } )
                                }

                                if (cons_pos == "y"){
                                    var pd_all = [pdA,pdB,pdC,pdF];
                                    var color_list = ["#00d8ff","#ff8500","#ccff00","#ff00d2"] // A, B, C, F

   				    if (sel ){
				        var sel_deco=decodeURIComponent(sel.replace(/\+/g, " "));
                                        if (sel_method == "high"){
					    o.addRepresentation( "licorice", {  colorValue: "#00d215", radius: "0.210", sele: sel_deco  } ); 
                                            for (ind in pd_all) {
                                                class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                                if (class_li){
                                                    var cons_pos_ok = class_li.replace(/,/g," OR ")
					            o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele: cons_pos_ok  } ); 
                                                }
                                            }   

                                        } else {
                                            /*if (rc=="y"){
                                                o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: sel_deco });
                                            }*/

                                            for (ind in pd_all) {
                                                class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                                if (class_li){
                                                    var cons_pos_ok = class_li.replace(/,/g," OR ")
					            o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele:  cons_pos_ok  } );
                                                }
                                            }   
				            //o.setSelection( sel_deco );
                                        }
				     } else {
                                         for (ind in pd_all) {
                                             class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                             if (class_li){
                                                 var cons_pos_ok = class_li.replace(/,/g," OR ")
					         o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele:cons_pos_ok  } );
                                             }
                                         }   

                                        /*if (rc=="y"){
                                            o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: "protein" } );
                                        }*/
                                     }

                                } else {
   				    if (sel ){
				        var sel_deco=decodeURIComponent(sel.replace(/\+/g, " "));
                                        if (sel_method == "high"){
					    o.addRepresentation( "licorice", {  colorValue: "#00d215", radius: "0.210", sele: sel_deco  } );
                                     /*   } else {
				            //o.setSelection( sel_deco );
                                        */
                                        }
				     }
                                 }
                                if (dist_within){
                                    var dist_within_li = decodeURIComponent(dist_within.replace(/\+/g, " ")).split(",");
                                    for (wth_n in dist_within_li){
                                        var dist_comp=  dist_within_li[wth_n].split("-");
                                        var radius=Number(dist_comp[0]);
                                        var ligSele =dist_comp[1];
                                        var restriction="";
                                        if (ligSele.indexOf("protein and") > -1){
                                            restriction="not "+ligSele.slice(12)+" and ";
                                        }
                                        var sele=o.structure.getAtomSetWithinSelection( new NGL.Selection( ligSele ), radius ).toSeleString();
                                        var center=o.structure.atomCenter( new NGL.Selection( ligSele ) );
                                        var spacefillRepr = o.addRepresentation( "licorice", { colorValue:"#ff7575", radius: "0.210", sele: "protein and "+restriction + sele } );
                                    }
                                }

/////////////////////////////////////////////////////////////

                                if( traj ) {
                                    var traj_str = decodeURIComponent(traj.replace(/\+/g, " "));
                                    var traj_li=traj_str.split(",")
                                    //var playing = false;
                                    var some_clicked=false;
                                    for (t in traj_li) {
                                        o.addTrajectory( traj_path + traj_li[t] );
                                        //$("#buttons").append("<button id='playerButton"+t+"'>"+traj_li[t].match(/(\w*)(\.\w*)$/)[1]);
                                        $("#buttons").append("<button style='margin:1px' type='button' class='btn btn-success btn-xs traj_btn' id='playerButton"+t+"'><span style='vertical-align:0px' class='glyphicon glyphicon-play'></span> "+traj_li[t].match(/(\w*)(\.\w*)$/)[1]);
                                    }
                                    $(".traj_btn").click( function(){
                                        var btn_traj_id=$(this).attr("id").slice(-1);                                        
                                        var trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                                        var player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                                        pos_class=$(this).attr("class");
                                        if(pos_class.indexOf("active") > -1){
                                            $(this).attr("class","btn btn-success btn-xs traj_btn");
                                            $(this).children().attr("class","glyphicon glyphicon-play");
                                            player.play();
                                            player.pause();
                                            some_clicked=false;
                                        } else if (! some_clicked){
                                            player.play();
                                            $(this).attr("class","btn btn-danger btn-xs traj_btn active"); 
                                            $(this).children().attr("class","glyphicon glyphicon-pause");
                                            some_clicked=true;
                                        }
                                    });
                                    //some_clicked=click_unclick(".traj_btn", some_clicked);
                                }
                                if (show_dist =="y"){
                                    if (comp_dist){ 
                                        var plot_colors=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"]; 
                                        var dist_pairs  = decodeURIComponent(comp_dist.replace(/\+/g, " "));
                                        var dist_pair_li=dist_pairs.split("a");
                                        for (pair_n in dist_pair_li){
                                            var d_from_to = dist_pair_li[pair_n].split("-");
                                            var d_from = d_from_to[0];
                                            var d_to = d_from_to[1];
                                           // o.addRepresentation( "label", {sele: Number(d_from), scale: 1.7, labelType: "serial"  } );
                                            o.addRepresentation( "distance", { atomPair: [[Number(d_from),Number(d_to)]] , colorValue: plot_colors[pair_n], colorScheme:"uniform", labelColor: plot_colors[pair_n] ,fontWeight: "normal" } );
                                        }
                                    }
                                    var hovrep;
                                    stage.signals.hovered.add( function( d ){
                                    if (d.atom){
                                        var hatom = d.atom;
                                        var info="["+hatom.resname.toString()+"]"+hatom.resno.toString()+":"+hatom.chainname+"."+hatom.atomname+" (atom ind:"+hatom.serial+")";
                                        $("#atomInfo").text(info);
                                    } /*else {
                                        $("#atomInfo").text("");
                                    }*/
                                $("#viewport").mousemove(function(){$("#atomInfo").text("")});
                                })
                                    var clicktrue = true;
                                    var atom1 , atom2 , res2 , res2, myrepr;
                                    stage.signals.clicked.add( function( d ){
                                       // hovrep.repr.clear()
                                        if (clicktrue){
                                            if (d.atom){
                                                myrepr = o.addRepresentation( "label", {
                                                    sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                                                    color: "#ffffff", scale: 1.7, labelType: "qualified name",fontWeight: "normal"  } );
                                                atom1 = d.atom.serial.toString();
                                                //res1 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
 
                                                clicktrue = false;
                                            }
                                        }else{
                                            if (d.atom){
                                                atom2 = d.atom.serial.toString();
                                                //res2 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
                                                clicktrue = true;
                                                if (atom1 != atom2){
                                                    o.addRepresentation( "label", {
                                                        sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                                                        color: "#ffffff", scale: 1.7, labelType: "qualified name" ,fontWeight: "normal" } );
                                                    var atomPair = [[ Number(atom1), Number(atom2) ]];
                                                    o.addRepresentation( "distance", { atomPair: atomPair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal"} );
                                                }
                                            } else {
                                                clicktrue = true;
                                                myrepr.repr.clear()
                                                //o.removeRepresentation("1stlab");
                                            }
                                        };
                                    } );

                                } 
                                o.centerView();

				} );
                    }
		

/*            stage.loadFile( "/mdsrv/file/ExampleData/default/md.gro", { asTrajectory: true } )
            .then(function( o){
                o.addRepresentation( "cartoon", { sele: "protein" } );
                o.addTrajectory("ExampleData/default/md.xtc");
                o.centerView();
            } );*/
        } );
    </script>
    <div style="width:540px">
        <div id="viewport" style="width:540px; height:370px;"></div>
        <div id="buttons" style="width:536px;height:30px;overflow: auto;margin-top:36px;margin-left:2px">
            <!--<button id="playerButton">play/pause</button>-->
        </div>
        <div id="atomInfo" style="width:536px;height:30px;margin-top:335px;margin-left:2px;color:green"></div>
    </div>
</body>
</html>
