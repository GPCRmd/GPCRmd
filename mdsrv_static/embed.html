<!DOCTYPE html>
<html lang="en">
<head>
    <title>MDsrv/NGL - embedded</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"><!-- test -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="icon" href="mdsrv/webapp/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="mdsrv/webapp/css/font-awesome.min.css" />
    <link rel="stylesheet" href="mdsrv/webapp/css/main.css" />
    <link rel="subresource" href="mdsrv/webapp/css/light.css" />
    <link rel="subresource" href="mdsrv/webapp/css/dark.css" />
    <style>
      .popover {
        background-color: rgba(242, 242, 242, 0.75);
      }
        
    </style>

</head>
<body >
    <!-- NGL -->
    <script src="mdsrv/webapp/js/ngl.js"></script>

    <!-- UI -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script><!-- test -->
    <script src="mdsrv/webapp/js/lib/signals.min.js"></script>
    <script src="mdsrv/webapp/js/lib/tether.min.js"></script>
    <script src="mdsrv/webapp/js/lib/colorpicker.min.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.extra.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.ngl.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.helper.js"></script>
    <script src="mdsrv/webapp/js/gui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <!-- MDSRV -->
    <!--<script src="mdsrv/webapp/js/mdsrv.js"></script>-->
    <script>
        NGL.cssDirectory = "mdsrv/webapp/css/";
        NGL.MDsrvdocumentationUrl = "http://arose.github.io/mdsrv";

        // Datasources
        NGL.DatasourceRegistry.add(
            "file", new NGL.MdsrvDatasource( window.location.origin + "/mdsrv/" )
        );
        NGL.DatasourceRegistry.listing = NGL.DatasourceRegistry.get( "file" );
        NGL.DatasourceRegistry.trajectory = NGL.DatasourceRegistry.get( "file" );
        document.addEventListener( "DOMContentLoaded", function(){
        
            //stage = new NGL.Stage( "viewport" );

////////////////// Functions
        $(document).ready(function(){
                
        document.domain=document.domain;
        //stage.setParameters( { backgroundColor: "white" /*, cameraType:"orthographic"*/} );


//        window.setFrameNGL = function(fr_num) {
//            var btn_traj_Bid =$(".traj_btn").attr("id");
//            var tPatt = /\d*$/g;
//            var btn_traj_id = tPatt.exec(btn_traj_Bid);
//            trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
//            if (trajComp){
//                var fr_now=trajComp.trajectory.currentFrame;
//                if (fr_num != fr_now){
//                    trajComp.setFrame(fr_num);
//                }
//            }
//        }  


        function atomFromPosSel(o,posSel){
            var res_sele =  new NGL.Selection( posSel );
            var atom_pos="";
            o.structure.eachAtom(function(a){
                if (a.atomname == "CA"){
                    atom_pos=a.index;
                }
            },res_sele);
            return(atom_pos)
        }
        
        function selWithinComponent(o,show,radius,ligSele){
            var radius=Number(radius);
            var sele=o.structure.getAtomSetWithinSelection( new NGL.Selection( ligSele ), radius );
            //var center=o.structure.atomCenter( new NGL.Selection( ligSele ) );
            var sele2 = o.structure.getAtomSetWithinGroup( sele );
            return([sele, sele2]);
        }

        function updateRepsFrameChanged(o,stage,trajComp,bs_info,dist_within_li, water_dist){
            $("#selectionDiv", window.parent.document).on("click" , function(){
                parent.passinfoToPlayTraj();
                bs_info = parent.bs_info;
                dist_within_li=parent.dist_of;  
                water_dist=parent.water_dist;
            });
            $(".traj_btn").click( function(){//[!]Is this necessary?
                parent.passinfoToPlayTraj();
                bs_info = parent.bs_info;
                dist_within_li=parent.dist_of;  
                water_dist=parent.water_dist;  

            });
            $("#trajRange").change(function(){//[!]Is this necessary?
                parent.passinfoToPlayTraj();
                bs_info = parent.bs_info;
                dist_within_li=parent.dist_of; 
                water_dist=parent.water_dist; 
            });
            trajComp.signals.frameChanged.add(function(){
                var fnum=trajComp.trajectory.currentFrame;
                if (fnum != -1){
                    if (trajchange){
                        parent.emptyFPsels();
                        trajchange=false;
                    }
                    var fpSelInt= parent.updateFlarePlotFrame(fnum);
                    $("#trajRange").val(fnum);
                    $("#trajRange").slider("refresh");
                    $("#traj_time_val").html((fnum*delta).toFixed(2));
                    traj_fnum[traj_lastPlayedID]=fnum;
                    //setSelTemp=[];//
                    /////////
                    if (! $.isEmptyObject(fpSelInt)){ 
                        var uplinksli=[];
                        var uplinkres="";
                        for (posfrom in fpSelInt){
                            var atom_from=atomFromPosSel(o,posfrom);
                            var postoLi=fpSelInt[posfrom];
                            uplinkres+=(posfrom + " or ");
                            for (posn=0 ; posn < postoLi.length ; posn++){
                                var posto=postoLi[posn];
                                uplinkres+=(posto + " or ");
                                var atom_to=atomFromPosSel(o,posto);
                                uplinksli.push([atom_from,atom_to])
                            }
                        }
                        var previousFPintReps=stage.getRepresentationsByName('FP int');//.list.length;
                        if (previousFPintReps.list.length > 0){
                            previousFPintReps.setParameters({atomPair: uplinksli});
                            stage.getRepresentationsByName('FP res').setSelection( uplinkres.slice(0, -4));
                        } else {
                            o.addRepresentation( "distance", { atomPair: uplinksli, colorValue: "#000000", colorScheme:"uniform", labelVisible:false   ,fontWeight: "normal" ,name : 'FP int' } );            
                            o.addRepresentation( "licorice", { colorValue:"#43E19C", radius: "0.210", sele: uplinkres.slice(0, -4) , name:"FP res" } );
                        }
                        //setSelTemp.push(uplinkres.slice(0, -4));
                    } else if (stage.getRepresentationsByName('FP int').list.length > 0){
                        //var aa=stage.getRepresentationsByName('FP res').list[0]//.repr.removeRepresentation();
                        o.removeRepresentation(stage.getRepresentationsByName('FP res').list[0]);
                        o.removeRepresentation(stage.getRepresentationsByName('FP int').list[0]);
                    }
                    
                    /////////
                    if (bs_info.length > 0){
                        var bs_info_li=bs_info.split("-");
                        var recept =bs_info_li[0];
                        var ligli=bs_info_li[1].split(",");
                        var bsnum =0;
                        for (liN = 0; liN < ligli.length; liN++){
                            var lig = ligli[liN];
                            if (! isNaN(parseInt(lig))){
                                lig="["+lig+"]";
                            }
                            var result = selWithinComponent(o,recept , "2.5" ,lig );
                            var sele = result[0];
                            var sele2 = result[1];
                            BSRepName="BS"+bsnum.toString();
                            //stage.getRepresentationsByName(BSRepName).setSelection(recept+" and "+sele.toSeleString());
                            stage.getRepresentationsByName(BSRepName+"_2").setSelection(recept+" and "+ sele2.toSeleString());
                            bsnum+=1;
                            //setSelTemp.push(recept+" and "+ sele2.toSeleString());
                        }
                    }
                    if (dist_within_li.length > 0){
                        for (wth_n=0 ; wth_n < dist_within_li.length ; wth_n++){
                            var dist_comp=  dist_within_li[wth_n].split("-");
                            var show=dist_comp[0];
                            if (! isNaN(parseInt(show))){
                                show="["+show+"]";
                            }
                            var ligSele=dist_comp[2];
                            if (! isNaN(parseInt(ligSele))){
                                ligSele="["+ligSele+"]";
                            }
                            var selectionTest = new NGL.Selection( ligSele ).selection[ "error" ];
                            if (!selectionTest){
                                var restriction="";
                                var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                                if (show_sup != "NONE"){
                                    restriction="not ("+ligSele+") and ";
                                } 
                                var result=selWithinComponent(o,show,dist_comp[1],ligSele);
                                var sele = result[0];
                                var sele2 = result[1];
                                WthRepName="sel"+dist_comp[2];
                                stage.getRepresentationsByName(WthRepName).setSelection(show+" and "+restriction + sele.toSeleString());
                                //stage.getRepresentationsByName(WthRepName+"2").setSelection(show+" and "+restriction + sele2.toSeleString());
                                //setSelTemp.push(show+" and "+restriction + sele2.toSeleString());
                            }
                        }
                    }

                    if (typeof(water_dist)=='number'){ //the ERRORS here?? select for this specific frames
                        var sele=o.structure.getAtomSetWithinSelection(new NGL.Selection("protein"), water_dist);
                        // console.log(water_sele_tostring)
                        atoms_within = sele.toSeleString();
                        water_sele = "water and ("+ atoms_within+")";
                        water_sele2 = "TIP3 and ("+ atoms_within+")";
                        stage.getRepresentationsByName("waterselection").setSelection(water_sele);
                        stage.getRepresentationsByName("waterselection2").setSelection(water_sele2);


                        
                    }
                }
            });
        }
        
        function setTrajRangeMax(){
            var btn_traj_Bid =$(".traj_btn").attr("id");
            var tPatt = /\d*$/g;
            var btn_traj_id = tPatt.exec(btn_traj_Bid);
            trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
            numfr=trajComp.trajectory._frameCount;
            if ( numfr && ($("#trajRange").attr("max") != numfr)){
                $("#trajRange").attr("max",numfr);
            }

        }

        function trajButtons(o){
            $(".ui-slider").css({"margin-left":"25px"});
            $(".ui-slider-handle").css({"height":"15px","width":"15px","border-radius":"100%","margin-top":"-7px","margin-left":"0"});
            $(".ui-slider-track").css({"height":"5px","margin-top":"7px"});
            $(".ui-slider-input").css({"font-size":"10px","padding":"2px","margin-top":"2px","margin-left":"6px"});
            $("#toiframe").find("#trajRangeDiv").css("visibility","visible");
            parent.passinfoToPlayTraj();
            var bs_info = parent.bs_info;
            var dist_within_li=parent.dist_of; 
            var water_dist=parent.water_dist; 

            $(".traj_btn").click( function(){
                var btn_traj_Bid=$(this).attr("id");
                var tPatt = /\d*$/g;
                var btn_traj_id = tPatt.exec(btn_traj_Bid);
                var isact = $(this).hasClass("active");
                //var pos_class=$(this).attr("class");
                if(isact){
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                    player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                    player.interpolateType=trajIntType;
                    player.step=stepsize;
                    player.timeout=trajtimeout;
                    $(this).removeClass("active");
                    $(this).children().attr("class","glyphicon glyphicon-play");
                    player.play();
                    player.pause();
                    //var lastfr=trajComp.trajectory.currentFrame;
                    //traj_fnum[traj_lastPlayedID]=lastfr+stepsize;
                } else {
                    trajComp = stage.getComponentsByName("my_comp").list[0].trajList[btn_traj_id];
                    //$("#trajRange").attr("max",trajComp.trajectory.numframes);
                    player = new NGL.TrajectoryPlayer(trajComp.trajectory);
                    player.interpolateType=trajIntType;
                    player.step=stepsize;
                    player.timeout=trajtimeout;
                    player.play();
                    $(this).addClass("active");
                    $(this).siblings().removeClass("active");
                    $(this).children().attr("class","glyphicon glyphicon-pause");
                    /*var patt = new RegExp("/(.*)$");
                    var res = patt.exec(traj_li_all[btn_traj_id]);
                    var mytraj_nm=res[1];
                    $("#last_played").text(mytraj_nm);*/

                }
                numfr=trajComp.trajectory._frameCount;
                if ($("#trajRange").attr("max") != numfr){
                    $("#trajRange").attr("max",numfr);
                }
            });
            $("#trajRange").change(function(){
                var toframe=$(".ui-slider-handle").attr("aria-valuenow"); 
                if (toframe=="NaN"){
                    toframe=$(this).val()
                }
                if (toframe){ 
                    if (trajComp){
                        numfr=trajComp.trajectory._frameCount;
                        if ($("#trajRange").attr("max") != numfr){
                            //$("#trajRange").attr("max",numfr);
                            setTrajRangeMax();
                        }
                        trajComp.setFrame(toframe); //[!]
                    }
                }
            });

            var allTrajCompli=stage.getComponentsByName("my_comp").list[0].trajList;
            for (tcN=0; tcN< allTrajCompli.length;tcN++){
                updateRepsFrameChanged(o,stage,allTrajCompli[tcN],bs_info,dist_within_li, water_dist);
            }

            
            $("#trajRangeDiv").on("mousedown" , ".ui-slider-handle" , function(){
                setTrajRangeMax();
            })
            
            $("#trajRangeDiv").on("click" , ".ui-slider-track" , function(){
                setTrajRangeMax();
            })

            $(document.body).bind('changeframeNGL', function(e, frame_num) {
                if (trajComp){
                    numfr=trajComp.trajectory._frameCount;
                    if ($("#trajRange").attr("max") != numfr){
                        $("#trajRange").attr("max",numfr);
                    }
                    trajComp.setFrame(frame_num);
                }
            });

        }

        function fromChainLiToNGL(nonGPCR){ 
            var nonGPCR_li=nonGPCR.split(",");
            var nonGPCR_mod="";
            for (chain_n =0 ; chain_n < nonGPCR_li.length ; chain_n++){
                nonGPCR_mod+=":"+nonGPCR_li[chain_n]+" , ";
            }
            nonGPCR_mod=nonGPCR_mod.slice(0,-3);
            return nonGPCR_mod;
        }
        
        function clearDists(clicktrue,lbl_name1){
            if (! clicktrue && lbl_name1){
                clicktrue = true;
                stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                stage.getRepresentationsByName(lbl_name1).setVisibility(false);
            }
            for (repN=0 ;repN < clickedRepLi.length ; repN++){
                var repNm =clickedRepLi[repN];
                if (typeof repNm =="string"){
                    var rep_to_rv=stage.getRepresentationsByName(repNm);
                    rep_to_rv.list[0].repr.clear();
                    rep_to_rv.setVisibility(false);
                }
            }
            $("#clear_dists_btn").html("");
            $("#varinfo_par" , window.parent.document).html("");
            clickedRep={};
            clickedRepLi=[];
            clickedDistData={};
            clickedLabData={};
            clickedDist={};
            clicktrue = true;
            return(clicktrue);
        }
        
        function hoverStruc(){
            // create new tooltip
            var tooltip = document.createElement('div')
            Object.assign(tooltip.style, {
              display: 'none',
              position: 'fixed',
              zIndex: 10,
              pointerEvents: 'none',
              backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
              color: 'lightgrey',
              padding: '8px',
              fontFamily: 'sans-serif'
            })
            document.body.appendChild(tooltip)
            // remove default hoverPick mouse action
            stage.mouseControls.remove('hoverPick')
            // listen to `hovered` signal to move tooltip around and change its text
            var o=stage.getComponentsByName("my_comp").list[0];
            stage.signals.hovered.add( function( d ){
                if (d && (d.atom)){
                    var hatom = d.atom;
                    var res_sel=hatom.resno.toString()+":"+hatom.chainname;
                    var gnum=""
                    if (res_sel in parent.pdb_gpcrdb){
                        gnum=parent.pdb_gpcrdb[res_sel]+" ";
                    }
                    var info_label=gnum+hatom.resname.toString()+res_sel+"."+hatom.atomname
                    var info=info_label+" (atom ind: "+hatom.index+")";
                    $("#atomInfo").text(info);
                    var mp = d.mouse.position
                    tooltip.innerText = info_label;
                    tooltip.style.bottom = window.innerHeight - mp.y + 3 + 'px'
                    tooltip.style.left = mp.x + 3 + 'px'
                    tooltip.style.display = 'block'
                    
                } else {
                    tooltip.style.display = 'none';
                    $("#viewport").mousemove(function(){$("#atomInfo").text("")});
                }
            });
            
        }
        
        function clickDists(d,o,clicktrue,atom1 , atom2 , res2 , myrepr,lbl_id,dist_id,lbl_name1, lbl_name2, dist_name ,labsele1 , labsele2 ){
            if (clicktrue){
                if (d && d.atom){
                    var res_sel=d.atom.resno.toString()+":"+d.atom.chainname;
                    var gnum=""
                    if (res_sel in parent.pdb_gpcrdb){
                        gnum=parent.pdb_gpcrdb[res_sel]+" ";
                    }
                    var info_label=gnum+d.atom.resname.toString()+res_sel+"."+d.atom.atomname;
                    var info=info_label+" (atom ind: "+d.atom.index+") - ";
                    $("#atomClicked").text(info);
                    lbl_name1="label_"+lbl_id.toString();
                    lbl_id+=1;
                    labsele1=d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname;
                    labeltext_d1={};
                    labeltext_d1[d.atom.index]=info_label;
                    myrepr = o.addRepresentation( "label", {
                        sele: labsele1,
                        backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
                        color: 'lightgrey',
                        padding: '20px',
                        backgroundOpacity:0.5,
                        backgroundMargin: 1,
                        showBackground: true,
                        scale: 1.7, labelType: "text", labelText:labeltext_d1,fontWeight: "normal", name :lbl_name1 } );
                    atom1 = d.atom.index.toString();
                    clicktrue = false;
                }else {
                    $("#atomClicked").text("");
                }
            }else{
                if (d && d.atom){
                    var res_sel=d.atom.resno.toString()+":"+d.atom.chainname;
                    var gnum=""
                    if (res_sel in parent.pdb_gpcrdb){
                        gnum=parent.pdb_gpcrdb[res_sel]+" ";
                    }
                    var info_label=gnum+d.atom.resname.toString()+res_sel+"."+d.atom.atomname;
                    var info=info_label+" (atom ind: "+d.atom.index+") - ";
                    $("#atomClicked").text(info);                                            
                    atom2 = d.atom.index.toString();
                    //res2 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
                    clicktrue = true;
                    if (atom1 != atom2){
                        lbl_name2="label_"+lbl_id.toString();
                        lbl_id+=1;
                        dist_name="dist_"+dist_id.toString();
                        clickedDist[dist_name]=[atom1,atom2];
                        dist_id+=1;
                        var add1=[lbl_name1, lbl_name2 , dist_name];
                        var add2 = [lbl_name1, lbl_name2 , dist_name];
                        if (! clickedRep[atom1]){
                            clickedRep[atom1]=[];
                        }
                        if (! clickedRep[atom2]){
                            clickedRep[atom2]=[];
                        }
                        for (an =0 ; an < add1.length ; an++){
                            var repNm=add1[an];
                            clickedRep[atom1][clickedRep[atom1].length]=repNm;
                            if (!(repNm in clickedRepLi)){
                                clickedRepLi.push(repNm);
                            }
                        }
                        for (an =0 ; an < add2.length ; an++){
                            clickedRep[atom2][clickedRep[atom2].length]=add2[an];
                        }
                        labeltext_d2={};
                        labeltext_d2[d.atom.index]=info_label;
                        labsele2=d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname;
                        o.addRepresentation( "label", {
                            sele: labsele2,
                            backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
                            color: 'lightgrey',
                            padding: '20px',
                            backgroundOpacity:0.5,
                            backgroundMargin: 1,
                            showBackground: true,
                            scale: 1.7, labelType: "text", labelText:labeltext_d2 ,fontWeight: "normal" , name:lbl_name2 } );
                        var atomPair = [[ Number(atom1), Number(atom2) ]];
                        o.addRepresentation( "distance", { atomPair: atomPair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dist_name} );
                        clickedDistData[dist_name]=atomPair;
                        clickedLabData[lbl_name1]={"sele":labsele1,"text":labeltext_d1};
                        clickedLabData[lbl_name2]={"sele":labsele2,"text":labeltext_d2};

                    } else {
                        if (atom1 in clickedRep){
                            var toRv=clickedRep[atom1];
                            for (rvN=0 ; rvN < toRv.length ; rvN++){
                                var repName=toRv[rvN];
                                stage.getRepresentationsByName(repName).list[0].repr.clear();
                                stage.getRepresentationsByName(repName).setVisibility(false);
                                if (repName.substr(0, 4)=="dist"){
                                    if (repName in clickedDist){
                                        delete clickedDist[repName];
                                    }
                                    if (repName in clickedDistData){
                                        delete clickedDistData[repName];
                                    }
                                } else {
                                    if (repName in clickedLabData){
                                        delete clickedLabData[repName];
                                    }
                                }
                                var rvIndex = clickedRepLi.indexOf(repName);
                                if (rvIndex > -1){
                                    clickedRepLi.splice(rvIndex, 1);
                                }
                            }
                            if (clickedRepLi.length ==0){
                                $("#clear_dists_btn").html("");
                            }
                            
                            stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                            stage.getRepresentationsByName(lbl_name1).setVisibility(false);
                            delete clickedRep[atom1];
                        } else {
                            if (! clickedRep[atom1]){
                                clickedRep[atom1]=[];
                            }
                            clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;
                            if (!(lbl_name1 in clickedRepLi)){
                                clickedRepLi.push(lbl_name1);
                            }
                            clickedLabData[lbl_name1]={"sele":labsele1,"text":labeltext_d1};//labsele1;[!]
                        }
                    }
                    if (clickedRepLi.length > 0){
                        $("#clear_dists_btn").html('<button class="btn btn-danger btn-xs" type="button" id="clear_dist_reps" style="min-width:150px;text-align:left;font-weight:bold">Clear labels/dists.</button>');
                    }
                } else {
                    $("#atomClicked").text("");
                    clicktrue = true;
                    stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                    stage.getRepresentationsByName(lbl_name1).setVisibility(false);
                }
            };
            return {
                clicktrue:clicktrue,
                atom1:atom1 , 
                atom2:atom2 , 
                res2:res2, 
                myrepr:myrepr,
                lbl_id:lbl_id,
                dist_id:dist_id,
                lbl_name1:lbl_name1,
                lbl_name2: lbl_name2,
                dist_name:dist_name,
                labsele1:labsele1,
                labsele2:labsele2
            };
        
        };
        
        function createDivAtStrClick(d, divid, myhtml, isparent) {
            var mouse_pos=d.canvasPosition;
            var x_pos= mouse_pos["x"];
            var y_pos=mouse_pos["y"]
            var max_h_s=$("#viewport").css("height");
            var max_h=Number(max_h_s.replace("px",""))
            var y_pos_mod=max_h - y_pos 
            if (isparent){
                var y_corr=120
                var x_corr=30
                myhtml=myhtml.replace(/\*\*x_pos\*\*/,x_pos);
                myhtml=myhtml.replace(/\*\*y_pos\*\*/,y_pos_mod+120);
                $(divid, window.parent.document).html(myhtml);          
            } else {
                myhtml=myhtml.replace(/\*\*x_pos\*\*/,x_pos);
                myhtml=myhtml.replace(/\*\*y_pos\*\*/,y_pos_mod);                
                $(divid).html(myhtml);          
            }
        }
        
        function clickVars(d){
            if (d && d.atom){
            }
            if (d && d.atom && d.atom.isProtein()){
                var pdb_pos=d.atom.resno.toString()+":"+d.atom.chainname
                if (pdb_pos in pdb_vars){
                    var resname=d.atom.resname.toString()
                    var var_info=pdb_vars[pdb_pos]
                    //Define info in the div
                    var var_pos=  resname.substr(0,1)+resname.substr(1).toLowerCase()+" "+var_info.gnum+" ("+pdb_pos+")";
                    var table_rows="";
                    var vars_pos_d=var_info.vars;
                    for (fromto in vars_pos_d){
                        var fromto_sp=fromto.split(",");
                        var from=fromto_sp[0];
                        var to=fromto_sp[1];
                        var vars_pos_li=vars_pos_d[fromto];
                        var var_exp_len=vars_pos_li.length;
                        var var_rows="";
                        for (var vlN=0; vlN<vars_pos_li.length;vlN++){
                            var consequence=vars_pos_li[vlN].consequence;
                            var allele_freq=vars_pos_li[vlN].allele_freq;
                            var exac_id=vars_pos_li[vlN].exac_id;
                            var var_exp_fromto="";
                            if (vlN == 0){
                                var rowspan="";
                                if (var_exp_len >1){
                                    rowspan="rowspan="+ var_exp_len.toString();
                                }
                                var_exp_fromto="<td "+rowspan+" style='border-color:#808080'>"+from+" <span style='font-size:8px' class='glyphicon glyphicon-arrow-right'></span> "+to+"\
                                                </td>"
                            } 
                            var_rows+="<tr>"+var_exp_fromto+"\
                                             <td style='border-color:#808080'>"+consequence+"</td>\
                                             <td style='border-color:#808080'>"+allele_freq+"</td>\
                                             <td style='border-color:#808080'><a href=\"http://exac.broadinstitute.org/variant/"+exac_id+"\" target=\"_blank\"><span style='padding-bottom:2px;width:25px;color: #80aaff' class=\"glyphicon glyphicon-book\"></span></a></td>\
                                           </tr>";
                        }
                        table_rows+=var_rows
                    }

                    //Define info in the div
                    var myhtml="<div id='added_html_click' style='background-color:rgba(38, 38, 38, 0.75);border: 1px solid #666666;z-index: 1;position:absolute;overflow:auto;max-width:250px;max-height:200px; border-radius:4px;left:**x_pos**px;top:**y_pos**px'>\
                    <span class='glyphicon glyphicon-remove close_var_mut' style='position:absolute;top:5px;right:5px;font-size:10px;color:#a6a6a6;cursor: pointer;'></span>\
                      <table class='table table-condensed' style='color:white;font-size:12px;margin:0;text-align:center'>\
                        <thead>\
                          <tr>\
                            <th style='text-align:center;border-color:#808080' colspan=4>"+var_pos+"</th>\
                          </tr>\
                          <tr>\
                            <th style='text-align:center;border-color:#808080' >Variant</th>\
                            <th style='text-align:center;border-color:#808080' >Type</th>\
                            <th style='text-align:center;border-color:#808080' ><button  style=\"padding:0;color:white;font-weight:bold\" class=\"btn-link showtooltip\" data-toggle=\"tooltip\" title=\"EXAC allele frequencies (allele count/allele number)\">Freq</button>\
                            <th style='text-align:center;border-color:#808080' >Ref</th>\
                          </tr>\
                        </thead>\
                        <tbody>\
                        "+table_rows+"\
                        </tbody>\
                      </table>\
                    </div>";

                    createDivAtStrClick(d,"#varinfo_par",myhtml,true);
                }                 
                var res_sel=d.atom.resno.toString()+":"+d.atom.chainname;
                var gnum=""
                if (res_sel in parent.pdb_gpcrdb){
                    gnum=parent.pdb_gpcrdb[res_sel]+" ";
                }
                var info=gnum+d.atom.resname.toString()+res_sel+"."+d.atom.atomname+" (atom ind: "+d.atom.index+") - ";
                $("#atomClicked").text(info);
            }else {
                $("#atomClicked").text("");
            }
        }
        
       
        function clickMuts(d){
            if (d && d.atom && d.atom.isProtein()){
                var pdb_pos=d.atom.resno.toString()+":"+d.atom.chainname
                if (pdb_pos in pdb_muts){
                    var mut_info=pdb_muts[pdb_pos]
                    var resname=d.atom.resname.toString()
                    //Define info in the div
                    var mut_pos=  resname.substr(0,1)+resname.substr(1).toLowerCase()+" "+mut_info.gnum+" ("+pdb_pos+")";
                    var table_rows="";
                    var muts_pos_d=mut_info.vars;
                    for (fromto in muts_pos_d){
                        var fromto_sp=fromto.split(",");
                        var from=fromto_sp[0];
                        var to=fromto_sp[1];
                        var muts_pos_li=muts_pos_d[fromto];
                        var mut_exp_len=muts_pos_li.length;
                        var mut_rows="";
                        for (var vlN=0; vlN<muts_pos_li.length;vlN++){
                            var fchange=muts_pos_li[vlN].fchange;
                            var qual=muts_pos_li[vlN].qual;
                            var stud_lig=muts_pos_li[vlN].lig;
                            var exp=muts_pos_li[vlN].exp;
                            var unit=muts_pos_li[vlN].unit;
                            var measure=muts_pos_li[vlN].measure;
                            if (!fchange){
                                if (qual){
                                    fchange=qual;
                                } else if (!stud_lig) {
                                    fchange="N/A"
                                }
                            }
                            if (!stud_lig){
                                stud_lig="-";
                            }
                            if (!exp){
                                exp="-";
                            }
                            if (measure.length>0 && unit.length>0){
                                tooltip_or_not="<button  style=\"padding:0;color: #80aaff\" class=\"btn-link showtooltip\" data-toggle=\"tooltip\" title=\"Measure:"+measure+"</br>Unit:"+unit+"\">"+fchange+"</button>";
                            } else{
                                tooltip_or_not=fchange;
                            }

                            var mut_exp_fromto=""
                            if (vlN==0){
                                var rowspan="";
                                if (mut_exp_len >1){
                                    rowspan="rowspan="+ mut_exp_len.toString();
                                }
                                mut_exp_fromto="<td "+rowspan+" style='border-color:#808080;padding:4'>"+from+" <span style='font-size:8px' class='glyphicon glyphicon-arrow-right'></span> "+to+"\
                                                </td>"
                            }
                            mut_rows+="<tr>"+mut_exp_fromto+"\
                                            <td style='border-color:#808080;padding:4'>"+tooltip_or_not+"</td>\
                                            <td style='border-color:#808080;padding:4'>"+exp+"</td>\
                                            <td style='border-color:#808080;padding:4'>"+stud_lig+"</td>\
                                            <td style='border-color:#808080;padding:4'><a href=\"https://www.ncbi.nlm.nih.gov/pubmed/"+muts_pos_li[vlN].pub_ref+"\" target=\"_blank\"><span class=\"glyphicon glyphicon-book\" style=\"width:35px;color: #80aaff\"></span></a></td>\
                                         </tr>";

                        };
                        table_rows+=mut_rows;
                        
                    }

                    var myhtml="<div id='added_html_click' style='background-color:rgba(38, 38, 38, 0.75);border: 1px solid #666666;z-index: 1; position:absolute; border-radius:4px;overflow:auto;max-height:200px; left:**x_pos**px;top:**y_pos**px'>\
                    <span class='glyphicon glyphicon-remove close_var_mut' style='position:absolute;top:5px;right:5px;font-size:10px;color:#a6a6a6;cursor: pointer;'></span>\
                      <table class='table table-condensed' style='color:white;font-size:12px;margin:0;max-width:400px;text-align:center'>\
                        <thead>\
                          <tr>\
                            <th style='text-align:center;border-color:#808080;padding:4' colspan=5 >"+mut_pos+"</th>\
                          </tr>\
                          <tr>\
                            <th style=\"text-align:center;border-color:#808080;padding:4\">Mutation</th>\
                            <th style=\"text-align:center;border-color:#808080;padding:4\">Fold change</th>\
                            <th style=\"text-align:center;border-color:#808080;padding:4\">Exp. type</th>\
                            <th style=\"text-align:center;border-color:#808080;padding:4\">Ligand</th>\
                            <th style=\"text-align:center;border-color:#808080;padding:4\">Ref</th>\
                          </tr>\
                        </thead>\
                        <tbody>\
                        "+table_rows+"\
                        </tbody>\
                      </table>\
                    </div>";
                    createDivAtStrClick(d,"#varinfo_par",myhtml,true);
                }
                var res_sel=d.atom.resno.toString()+":"+d.atom.chainname;
                var gnum=""
                if (res_sel in parent.pdb_gpcrdb){
                    gnum=parent.pdb_gpcrdb[res_sel]+" ";
                }
                var info=gnum+resname+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.index+") - ";
                $("#atomClicked").text(info);
            }else {
                $("#atomClicked").text("");
            }
        }
        
        
        function clickStruc(){
            var clicktrue = true;
            $("#selectionDiv", window.parent.document).click(function(){
                if (! clicktrue && lbl_name1){
                    clicktrue = true;
                }
            });
            $("#clear_dists_btn").on("click","#clear_dist_reps",function(){
                clicktrue=clearDists(clicktrue,lbl_name1);
            });
            $("#clearAll", window.parent.document).click(function(){
                clicktrue=clearDists(clicktrue,lbl_name1);
            });  
            $(".onclickshow", window.parent.document).click(function(){
                clicktrue=clearDists(clicktrue,lbl_name1);
            });            
            var o=stage.getComponentsByName("my_comp").list[0];
            //Initialize variables necessary for distances
            var atom1 , atom2 , res2 , myrepr;
            var lbl_id=0;
            var dist_id=0;
            var lbl_name1, lbl_name2, dist_name ,labsele1 , labsele2 ;
            //Obtain data for variants and mutations
            stage.signals.clicked.add( function( d ){
                if (onclickshow=="dists"){
                    distvars=clickDists(d, o,clicktrue,atom1 , atom2 , res2 , myrepr,lbl_id,dist_id,lbl_name1, lbl_name2, dist_name ,labsele1 , labsele2 );
                    clicktrue=distvars.clicktrue
                    atom1=distvars.atom1
                    atom2=distvars.atom2
                    res2=distvars.res2
                    myrepr=distvars.myrepr
                    lbl_id=distvars.lbl_id
                    dist_id=distvars.dist_id
                    lbl_name1=distvars.lbl_name1
                    lbl_name2=distvars.lbl_name2
                    dist_name=distvars.dist_name
                    labsele1=distvars.labsele1
                    labsele2=distvars.labsele2
                    
                } else if (onclickshow=="vars"){
                    clickVars(d);
                } else if (onclickshow=="muts"){
                    clickMuts(d);
                }

            } );

        }
        
        function res_to_atom(o,d_info){
            var d_all=d_info.split(":");
            var res=d_all[0];
            var chain=d_all[1];
            var atmn=d_all[2];
            var res_sele =  new NGL.Selection( res+":"+chain );
            var mypos="";
            o.structure.eachAtom(function(a){
                if (a.atomname == atmn){
                    mypos=a.index;
                }
            },res_sele);
            return(mypos)
        }

        /*function addToSel(o,selection,setSelDict){
            var selAtoms=o.structure.getAtomSet(new NGL.Selection( selection )).array();
            var exs=o.structure.getAtomSet(new NGL.Selection( selection ));
            exs.forEach( function(atom_index, loop_counter) {
                if (!(atom_index in setSelDict)){
                    setSelDict[atom_index] = true
                }
            });
            return(setSelDict)
        }*/

        function obtainSetSelTempAtms(o,setSelTemp,setSelStr){
            var setSelTempAtms="";
            if (setSelTemp.length > 0){
                //setSelTempAtms=o.structure.getAtomSet(new NGL.Selection( "("+setSelTemp.join(") or (") +")" )).toSeleString();
                setSelTempAtms="("+setSelTemp.join(") or (") +")";
                if (setSelStr){
                    setSelTempAtms=" or "+setSelTempAtms;
                }
            }
            return setSelTempAtms;
        }


        function applySele (value) {
          if (value) {
            struc=stage.getComponentsByName("my_comp").list[0];
            struc.autoView(value)
            var z = stage.viewer.camera.position.z
            var setval=99 - Math.abs(z / 10);
            stage.setFocus(setval)
            $("#EDmapzoom", window.parent.document).val(setval);
            $("#EDmapzoom_val", window.parent.document).html(setval.toFixed(0));
            
            //$("#EDmapzoom")
          }
        }

        function avoid_unload_H(o,hbonds,showH){            
            if (! showH){
                new_hbonds=[]
                for (a=0;a<hbonds.length;a++){
                    var atom_pair=[];
                    for (i=0;i<hbonds[a].length;i++){
                        var this_index=hbonds[a][i];
                        var seeltest = o.structure.getAtomProxy(this_index);
                        if (seeltest.element=="H"){
                            sel_atom=false;
                            seeltest.residue.eachAtom(function(myatom){
                                var myel=myatom.element;
                                if (myel=="O" || myel=="N"){
                                    if (sel_atom){
                                        if (Math.abs(this_index - myatom.index) < Math.abs(this_index - sel_atom)){
                                            sel_atom=myatom.index;    
                                        }
                                    } else {
                                        sel_atom=myatom.index;
                                    }
                                }
                            });
                            this_index= sel_atom;

                        }
                        atom_pair[atom_pair.length]=this_index;
                    }
                    new_hbonds[new_hbonds.length]=atom_pair
                    
                }
                hbonds= new_hbonds;
            }
            return hbonds;
        }

        
        function createReps(){
            parent.passInfoToIframe();

            var results = parent.results;
            var cp = results["cp"];
            var high_pre=results["high_pre"];
            var layers_li = results["layers_row_li"];
            //var traj =results["traj"];
            var nonGPCR =results["nonGPCR"];
            var int_res_li =results["int_res_li"];
            var int_res_li_ch =results["int_res_li_ch"];
            var dist_groups_li=results["dist_groups_li"];
            var receptorsel = results["receptorsel"]; 
            var bs_info= results["bs_info"]; 
            var water_dist=results["water_dist"];
            var water_check=results["water_check"];
            var polar_check=results["polar_check"];
            var waterbox = results["waterbox"];
            var hbonds= results["hbondarray"];
            var sbonds_atoms= results["sbondarray"];
            var all_resids=results["allresidshb"];
            //var all_resids_inter=results["allresidshbInt"];
            var all_resids_sb=results["allresidssb"];
            var hbonds_inter=results["hb_inter"];
            var sasa_resids=results["all_resids_sasa"];
            var fpSelInt = results["fpSelInt"];
            var cons_pos = parent.pd; //[!!!]
            var dist_within_li=parent.dist_of;
            var  pdA= high_pre["A"];
            var  pdB= high_pre["B"];
            var  pdC= high_pre["C"];
            var  pdF= high_pre["F"];
            var  pdcolors=high_pre["colors"];
            var  pdrep=high_pre["rep"];
            //var setSelDict={};
            var setSelLi=[];
            var setSelTemp=[];
            var showH = false;
            showH =results["showH"];
            
            var o=stage.getComponentsByName("my_comp").list[0];
            var saveRepLi=[];
            o.eachRepresentation(function(rep, comp){
                if (clickedRepLi.indexOf(rep.name) > -1){
                    saveRepLi.push(rep);
                }
            });
            
            o.removeAllRepresentations();
            for (lname in clickedLabData){
                var lsele=clickedLabData[lname]["sele"];
                var ltext=clickedLabData[lname]["text"];
                o.addRepresentation( "label", {
                    sele: lsele,
                    backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
                    color: 'lightgrey',
                    padding: '20px',
                    backgroundOpacity:0.5,
                    backgroundMargin: 1,
                    showBackground: true,
                    scale: 1.7, labelType: "text", labelText:ltext ,fontWeight: "normal" , name:lname } );
            }
            for (dname in clickedDistData){
                var apair=clickedDistData[dname];
                o.addRepresentation( "distance", { atomPair: apair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dname} );
            }

            $("#buttons").html("");

       
            if (receptorsel.length > 0){
                if (bs_info.length > 0){
                    o.addRepresentation( "cartoon", { colorScheme:"uniform", colorValue: "#FFFFFF",  sele: receptorsel } );
                } else {
                    if (fpsegStr){
                        o.addRepresentation( "cartoon", { colorScheme: FPscheme,  sele: receptorsel } );
                    } else {
                        o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: receptorsel } );
                    }
                                    }
                //setSelDict=addToSel(o,receptorsel,setSelDict);
                setSelLi.push(receptorsel);

            } 
            
            if (nonGPCR.length > 0){
                for (ng=0 ; ng < nonGPCR.length ; ng++){
                    chains_s = nonGPCR[ng];
                    nonGPCR_sel = "protein and ("+ fromChainLiToNGL(chains_s) + ")";
                    o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: nonGPCR_sel } );
                    //setSelDict=addToSel(o,nonGPCR_sel,setSelDict);
                    setSelLi.push(nonGPCR_sel);
                }
            }
            if (cp.length > 0){
                var comptype_dict={
                    "lg":[],
                    "lp":[],
                    "i":[],
                    "w":[],
                    "t":[],
                    "o":[]
                }
                var all_cp_li=[];
                for (comp=0 ; comp < cp.length ; comp++){
                    var mycompinfo=cp[comp].split("_");
                    var mycomp=mycompinfo[0];
                    var mycompType=mycompinfo[1];
                    if (! isNaN(parseInt(mycomp))){
                        mycomp="["+mycomp+"]";
                    }
                    all_cp_li[all_cp_li.length]=mycomp;
                    comptype_dict[mycompType].push(mycomp);
                }
                var all_cp = all_cp_li.join(" or ");
                //o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: all_cp, radius: 0.30 } );
                setSelLi.push(all_cp);
                for (comp_key in comptype_dict){
                    var comptype_sel=comptype_dict[comp_key];
                    if (comptype_sel.length > 0){
                        var comp_sel=comptype_sel.join(" or ");
                        if (comp_key == "lg"){
                            if (bs_info.length > 0){
                                o.addRepresentation( "spacefill", { colorValue: "#f8d5b1", colorScheme: "element", visible: true, sele: comp_sel } );
                            } else {
                                o.addRepresentation( "spacefill", { colorScheme: "element", visible: true, sele: comp_sel } );
                            }
                        }
                        else if (comp_key == "i"){
                            o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel, radius: 0.30 , colorValue: "#aeff42"} );
                        }
                        else if (comp_key == "w") {
                            o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel, radius: 0.30 } );
                        }
                        else if (comp_key == "t") {
                            if (fpsegStr){
                                o.addRepresentation( "licorice", { colorScheme: FPscheme, visible: true, sele: comp_sel } );
                            } else {
                                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel } );
                            }
                        }
                        else  {
                            o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel } );
                        }
                    }
                }
            }
            if (cons_pos == "y"){
                var pd_all = [pdA,pdB,pdC,pdF];
                //var color_list = ["#00d8ff","#ff8500","#ccff00","#ff00d2"]; // A, B, C, F
                for (ind =0 ; ind < pd_all.length ; ind++){
                    class_li=pd_all[ind];
                    if (typeof class_li == "object"){
                        if (class_li.length > 0){
                            for (cN=0;cN<class_li.length;cN++){
                                var mypos=class_li[cN].replace(" ","");
                                var mycolor=pdcolors[mypos];
                                o.addRepresentation( pdrep, {  colorValue: mycolor, colorScheme:"uniform", sele: "protein and "+ mypos } );
                            }
                            
                            var cons_pos_ok = class_li.join(" OR ");
                            setSelLi.push("protein and ("+ cons_pos_ok +")");
                                                   
                        }
                    }
                }  
            }            
            
            if (layers_li.length > 0){
                var selAll=[]
                for (lN = 0; lN < layers_li.length; lN++) {
                    var layer_all = layers_li[lN];
                    var sel = layer_all[0];
                    var rep = layer_all[1];
                    var color = layer_all[2];
                    var scheme = layer_all[3];
                    var selectionTest = new NGL.Selection( sel ).selection[ "error" ];
                    if (!selectionTest){
                        if (scheme=="FPscheme"){
                            if (rep=="line"){
                                o.addRepresentation( rep, { linewidth: 6,  colorValue: color, /*radius: "0.210" ,*/ sele: sel , colorScheme: FPscheme,  } ); 
                            } else {
                                o.addRepresentation( rep, {  colorValue: color, /*radius: "0.210" ,*/ sele: sel , colorScheme: FPscheme } ); 
                            }
                        } else {
                            if (rep=="line"){
                                o.addRepresentation( rep, { linewidth: 6,  colorValue: color, /*radius: "0.210" ,*/ sele: sel , colorScheme: scheme } ); 
                            } else {
                                o.addRepresentation( rep, {  colorValue: color, /*radius: "0.210" ,*/ sele: sel , colorScheme: scheme } ); 
                            }
                        }
                        selAll.push(sel);
                    } else {
                        var rownum=layer_all[4];
                        var to_add_inside='Invalid selection.';
                        var to_add='<div class="alert alert-danger row" style = "margin-bottom:10px" ><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><span class="error_text">'+to_add_inside+'</span></div>';
                        if (rownum.startsWith("ti")){ //atom selection section
                            var textRowsel=$("#"+rownum,window.parent.document);
                            textRowsel.find(".ti_alert_ngl").html(to_add);
                            textRowsel.find("input").css("border-color","#A94442");
                            
                        } else { //sequence selection section
                            var seqRowsel=$("#"+rownum,window.parent.document);
                            seqRowsel.find(".si_alert_ngl").html(to_add);
                            seqRowsel.find("input").css("border-color","#A94442");
                        }
                    }
                }
                selAllStr="("+selAll.join(") or (")+")";
                //setSelDict=addToSel(o,selAllStr,setSelDict);  
                setSelLi.push(selAllStr);
            }
            
            if (bs_info.length > 0){
                var bs_info_li=bs_info.split("-");
                var recept =bs_info_li[0];
                var ligli=bs_info_li[1].split(",");
                var bsnum =0;
                for (liN = 0; liN < ligli.length; liN++){
                    var lig = ligli[liN];
                    if (! isNaN(parseInt(lig))){
                        lig="["+lig+"]";
                    }
                    var result = selWithinComponent(o,recept , "2.5" ,lig );
                    var sele = result[0];
                    var sele2 = result[1];
                    BSRepName="BS"+bsnum.toString();
                    //o.addRepresentation( "licorice", { colorValue:"#6fffc9", radius: "0.210", sele: recept+" and "+ sele.toSeleString(), name:BSRepName } );
                    //o.addRepresentation( "licorice", { colorValue:"#6fffc9",opacity:0.5 , radius: "0.210", sele: recept+" and "+ sele2.toSeleString() , name:BSRepName+"_2"} );
                    o.addRepresentation( "licorice", { colorValue:"#b6a476", radius: "0.210", sele: recept+" and "+ sele2.toSeleString() , name:BSRepName+"_2"} );
                    bsnum+=1;
                    //setSelDict=addToSel(o,recept+" and "+ sele2.toSeleString(),setSelDict);
                    setSelTemp.push(recept);
                }
                
            }

            if (dist_within_li.length > 0){
                for (wth_n = 0; wth_n < dist_within_li.length; wth_n++) {
                    var dist_comp=  dist_within_li[wth_n].split("-");
                    var show = dist_comp[0];
                    if (! isNaN(parseInt(show))){
                        show="["+show+"]";
                    }
                    var ligSele=dist_comp[2];
                    if (! isNaN(parseInt(ligSele))){
                        ligSele="["+ligSele+"]";
                    }
                    
                    var selectionTest = new NGL.Selection( ligSele ).selection[ "error" ];
                    if (!selectionTest){
                        var restriction="";
                        var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                        if (show_sup != "NONE"){
                            o.addRepresentation( "licorice", { colorValue:"#dcffae", radius: "0.210", sele: ligSele, name:"sel_within_0" } );
                            restriction="not ("+ligSele+") and ";
                            //setSelDict=addToSel(o,ligSele,setSelDict);
                            setSelTemp.push(ligSele);
                        }   
                        var result=selWithinComponent(o,show,dist_comp[1],ligSele);
                        var sele = result[0];
                        var sele2 = result[1];
                        WthRepName="sel"+ligSele;
                        o.addRepresentation( "licorice", { colorValue:"#ff7575", radius: "0.210", sele: show+" and "+restriction + sele.toSeleString(), name:WthRepName } );
                        //o.addRepresentation( "licorice", { colorValue:"#ff7575",opacity:0.5 , radius: "0.210", sele: show+" and "+restriction + sele2.toSeleString() , name:WthRepName+"2"} );
                        //setSelDict=addToSel(o,show+" and "+restriction + sele2.toSeleString(),setSelDict);
                        setSelTemp.push(show);
                    }else {
                        var rowid=dist_comp[3];
                        parent.NGL_addErrorToInput("#"+rowid);

                    }
                    
                }

            }

            if (water_check == true){
                console.log("waterdist " + water_dist)
                setSelTemp.push("water");
                setSelLi.push("water");
                var sele=o.structure.getAtomSetWithinSelection(new NGL.Selection("protein"), water_dist);
                // console.log(water_sele_tostring)
                atoms_within = sele.toSeleString();
                water_sele = "water and ("+ atoms_within+")";
                // water_sele2 ="TIP3 and (" + atoms_within+")";
                o.addRepresentation("ball+stick", {name:"waterselection", sele: water_sele}); 
                // o.addRepresentation("ball+stick", {name:"waterselection2", sele: water_sele2}); 


            }



            if (onclickshow=="muts"){
                var pos_li=Object.keys(pdb_muts);
                var sel=".CA and ("+pos_li.join(" or ")+")";
                o.addRepresentation( "spacefill", { colorValue:"#0079ff", sele: sel, scale:0.35} );
            } else if (onclickshow=="vars"){
                var pos_li=Object.keys(pdb_vars);
                var sel=".CA and ("+pos_li.join(" or ")+")";
                o.addRepresentation( "spacefill", { colorValue:"#0079ff", sele: sel, scale:0.35} );
            }

            if ( ! mytraj){
                $("#toiframe").find("#trajRangeDiv").css("visibility","hidden");
            }
            

            if (dist_groups_li.length>0){
                var cd_id=0;
                var plot_colors=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"]; 
                for (distgN = 0; distgN < dist_groups_li.length; distgN++) {
                    var dist_group=dist_groups_li[distgN];
                    var dist_pair_li=dist_group.split(",");
                    for (pair_n = 0; pair_n < dist_pair_li.length; pair_n++) {
                        var d_from_to_str = dist_pair_li[pair_n];
                        if (typeof d_from_to_str == "string"){
                            var d_from_to = d_from_to_str.split("-");
                            var d_from = d_from_to[0];
                            var d_to = d_from_to[1];
                            if (d_from_to_str.indexOf(":") > -1){
                                d_from=res_to_atom(o,d_from);
                                d_to=res_to_atom(o,d_to);
                            } 
                            var comp_dist_name="comp_dist_"+cd_id.toString();
                           // o.addRepresentation( "label", {sele: Number(d_from), scale: 1.7, labelType: "serial"  } );
                            o.addRepresentation( "distance", { atomPair: [[Number(d_from),Number(d_to)]] , colorValue: plot_colors[pair_n], colorScheme:"uniform", labelColor: plot_colors[pair_n] ,fontWeight: "normal" ,name : comp_dist_name } );
                            //compDistsLi.push(comp_dist_name);
                            cd_id +=1;
                        }
                    }
                }
            }

            if (sasa_resids.length > 0) {
                if (typeof(sasa_resids)=='string') {
                    resids='not water';
                }else{
                    var resids= 'protein and';
                    resids=resids+' ('+sasa_resids.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                }
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
                //setSelDict=addToSel(o,resids,setSelDict);
                setSelLi.push(resids);
            }

            if (hbonds.length > 0){
                var resids= 'protein and';
                hbonds=avoid_unload_H(o,hbonds,showH);
                resids=resids+' ('+all_resids.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                o.addRepresentation( "distance", { atomPair: hbonds , colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
                //setSelDict=addToSel(o,resids,setSelDict);
                setSelLi.push(resids);
            }

            if (hbonds_inter.length > 0){
                hbonds_inter=avoid_unload_H(o,hbonds_inter,showH);
                //var resids='not water and';
                //resids=resids+' ('+all_resids_inter.join(' or ') + ' )'; //not only proteins! lipids also have hbonds

                var res_sel_li=[];
                for (a=0;a<hbonds_inter.length;a++){
                    for (i=0;i<hbonds_inter[a].length;i++){
                        var resatomindex=Number(hbonds_inter[a][i]);
                        var myresidue=o.structure.getAtomProxy(resatomindex).residue;
                        //var isprot = myresidue.isProtein();
                        var mychain=myresidue.chainname;
                        var myres = myresidue.resno;
                        res_sel_li[res_sel_li.length]=myres+":"+mychain;
                    }
                }
                var res_sel=res_sel_li.join(" or ");

                o.addRepresentation( "distance", { atomPair: hbonds_inter, colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                o.addRepresentation( "licorice", {  radius: "0.210", sele: res_sel , colorValue: "#8e74ff" } );
                setSelLi.push(res_sel);
            }

            if (sbonds_atoms.length > 0){
                sbonds_atoms=avoid_unload_H(o,sbonds_atoms,showH);
                var resids='protein and ';
                resids=resids + '( '+ all_resids_sb.join(' or ') + ')';
                o.addRepresentation( "distance", { atomPair: sbonds_atoms , colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
                //setSelDict=addToSel(o,resids,setSelDict);
                setSelLi.push(resids);
            }

            if (int_res_li.length > 0){
                var final_sele=[];
                for (pos_info_n = 0; pos_info_n < int_res_li.length; pos_info_n++) {
                    var pos_info = int_res_li[pos_info_n];
                    var pos = pos_info[0]+":"+pos_info[1];
                    final_sele.push(pos);
                    var label = pos_info[2];
                    var res_sele =  new NGL.Selection( pos );
                    var label_pos="";
                    o.structure.eachAtom(function(a){
                        if (a.atomname == "CA"){
                            label_pos=a.index;
                        }
                    },res_sele);
                    labeltext_dd={};
                    labeltext_dd[label_pos]=label;
                    var aa= o.addRepresentation("label", {labelType: "text", labelText:labeltext_dd ,
                        backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
                        color: 'lightgrey',
                        padding: '40px',
                        backgroundOpacity:0.5,
                        backgroundMargin: 1,
                        showBackground: true,
                        sele:".CA and "+pos,
                        xOffset:0.5,
                        yOffset:0.5,
                        zOffset:0.5
                    });
                }
                final_sele=final_sele.join(" , ");
                o.addRepresentation( "licorice", {  radius: "0.210", sele: final_sele , colorValue: "#8e74ff" } );// colorValue: "#00d215"
                //setSelDict=addToSel(o,final_sele,setSelDict);
                setSelLi.push(final_sele);

            }
            
            if (int_res_li_ch.length > 0){
                var final_sele=[];
                for (pos_info_n = 0; pos_info_n < int_res_li_ch.length; pos_info_n++) {
                    var pos_info = int_res_li_ch[pos_info_n];
                    var pos = pos_info[0]+":"+pos_info[1];
                    final_sele.push(pos);
                    var label = pos_info[2];
                    var res_sele =  new NGL.Selection( pos );
                    var label_pos="";
                    o.structure.eachAtom(function(a){
                        if (a.atomname == "CA"){
                            label_pos=a.index;
                        }
                    },res_sele);
                    labeltext_dd2={};
                    labeltext_dd2[label_pos]=label;
                    o.addRepresentation("label", {labelType: "text", labelText:labeltext_dd2 ,
                        backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
                        color: 'lightgrey',
                        padding: '40px',
                        backgroundOpacity:0.5,
                        backgroundMargin: 1,
                        showBackground: true,
                        sele:".CA and "+pos,
                        xOffset:1,
                        yOffset:1,
                        zOffset:1
                    });

                }
                final_sele=final_sele.join(" , ");
                o.addRepresentation( "spacefill", {   sele: final_sele , colorValue:"#8e74ff"/*"#461bff"*/ } );// colorValue: "#00d215"
                //setSelDict=addToSel(o,final_sele,setSelDict);
                setSelLi.push(final_sele);

            }

            if (! $.isEmptyObject(fpSelInt)){
                var linksli=[];
                var linkres="";
                for (posfrom in fpSelInt){
                    var atom_from=atomFromPosSel(o,posfrom);
                    var postoLi=fpSelInt[posfrom];
                    linkres+= (posfrom + " or ");
                    for (posn=0 ; posn < postoLi.length ; posn++){
                        var posto=postoLi[posn];
                        
                        var atom_to=atomFromPosSel(o,posto);
                        linksli.push([atom_from,atom_to])
                        linkres += (posto +" or ");
                    }
                }
                var linkresOk=linkres.slice(0, -4);
                o.addRepresentation( "distance", { atomPair: linksli, colorValue: "#000000", colorScheme:"uniform", labelVisible:false   ,fontWeight: "normal" ,name : 'FP int' } );            
                o.addRepresentation( "licorice", { colorValue:"#43E19C", radius: "0.210", sele: linkresOk , name:"FP res" } );
                //setSelDict=addToSel(o,linkresOk,setSelDict);

            }  

            // if ($(".PolarDisplay", window.parent.document).is(':checked')) {
            if (polar_check == true){
            polar_residues="Asp or Cys or Gly or Glu or His or Lys or Arg or Asn or Gln or Ser or Thr or Tyr"
            o.addRepresentation("licorice", {name:"polar_res",visible:true, sele:polar_residues})
            setSelTemp.push(polar_residues)
            }



            if ($("#FPdisplay",window.parent.document).hasClass("active")){
                if ($("g.node.toggledNode", window.parent.document).length >0){
                    setSelTemp.push("protein");
                } 
            } 
            
                       
            setSelStr="";
            if (setSelLi.length > 0){
                setSelStr="("+setSelLi.join(") or (")+")";
            }
            var setSelTempAtms=obtainSetSelTempAtms(o,setSelTemp,setSelStr)
            var setSelAll=setSelStr+setSelTempAtms;
            
            if ((! showH) &&  setSelAll.length > 0){
                setSelAll="not _h and ("+setSelAll+")"
            }
            
            var setSelFIN="";
            if (setSelAll.length > 0){
                setSelFIN=o.structure.getAtomSet(new NGL.Selection( setSelAll )).toSeleString();
            }

            var framenum=traj_fnum[traj_lastPlayedID];
            o.setSelection(setSelFIN);
            if (trajComp){
                trajComp.setFrame(framenum);
            }




        }
        

        function set_ngl_size(cont_w , cont_w_in ,cont_h_num ){

           var cont_h=(cont_h_num).toString() +"px";
           var cont_h_viewport=(cont_h_num-30).toString() +"px";
           var cont_h_range=(cont_h_num-222).toString() +"px";
           var cont_h_info=(cont_h_num-167).toString() +"px";
           $("#toiframe").css({"width":cont_w , "height" : cont_h});
           $("#viewport").css({"width": cont_w , "height" : cont_h_viewport });
           $("#buttons").css("width", cont_w_in);
           $("#trajRangeDiv").css({"width" : cont_w_in  , "margin-top" : cont_h_range });
           $("#infoPannel").css({"width" : cont_w_in , "margin-top" :cont_h_info });
        }

/////////Functions for ED map  


        window.checkNGLSel = function(sel_str) {
          var selection = new NGL.Selection(sel_str)
          return !selection.selection[ "error" ]
        }

        function updateEDmapSel(){
            parent.passInfoToIframe_ED();
            var results_ED = parent.results_ED;
            var loadEd=results_ED["loadEd"];
            var ed_sel=results_ED["ed_sel"];

            var ed2fofc=stage.getComponentsByName("EDmap_comp_2fofc").list[0];
            var edfofc=stage.getComponentsByName("EDmap_comp_fofc").list[0];
            //ed2fofc.removeAllRepresentations();
            //edfofc.removeAllRepresentations();
            if (loadEd){
                applySele(ed_sel);
                ed2fofc.setVisibility(true);
                edfofc.setVisibility(true);
            } else {
               ed2fofc.setVisibility(false);
               edfofc.setVisibility(false);
               stage.setFocus(0);
               $("#EDmapzoom", window.parent.document).val(0);
               $("#EDmapzoom_val", window.parent.document).html(0);
            }
        }

        function show_hide_map(is_checked,mapchanged){
            if (mapchanged=="2fofc"){
                stage.getRepresentationsByName("2fofc").setVisibility(is_checked);
            }else{
                stage.getRepresentationsByName("fofcpos").setVisibility(is_checked);
                stage.getRepresentationsByName("fofcneg").setVisibility(is_checked);
            }
        }

        function change_EDmap_style(v,mapsel,chtype){
            if (chtype=="general"){
                if (v === "contour") {
                  p = {
                    contour: true,
                    flatShaded: false,
                    opacity: 1,
                    metalness: 0,
                    wireframe: false
                  }
                } else if (v === "wireframe") {
                  p = {
                    contour: false,
                    flatShaded: false,
                    opacity: 1,
                    metalness: 0,
                    wireframe: true
                  }
                } else if (v === "smooth") {
                  p = {
                    contour: false,
                    flatShaded: false,
                    opacity: 0.5,
                    metalness: 0,
                    wireframe: false
                  }
                } else if (v === "flat") {
                  p = {
                    contour: false,
                    flatShaded: true,
                    opacity: 0.5,
                    metalness: 0.2,
                    wireframe: false
                  }
              }
            } else if (chtype=="color"){
              p = {
                colorValue:v
              }
            } else if (chtype=="isolevel"){
                p={isolevel:v}
            } else if (chtype=="mapsize"){
                p={boxSize:parseInt(v)}
            }
            if (mapsel=="2fofc"){
                stage.getRepresentationsByName("2fofc").setParameters(p);
            }else if (mapsel=="fofc"){
                stage.getRepresentationsByName("fofcpos").setParameters(p);
                stage.getRepresentationsByName("fofcneg").setParameters(p);
            }else if (mapsel=="fofcpos"){
                stage.getRepresentationsByName("fofcpos").setParameters(p);
            }else if (mapsel=="fofcneg"){
                stage.getRepresentationsByName("fofcneg").setParameters(p);
            }
            //stage.getRepresentationsByName("surface").setParameters(p)
        }

/////////Functions for Water Map
        function change_watermap_style(val,mapname, slider_val ){
            if (val == 'smooth'){
                p = {
                    contour: false,
                    flatShaded: false,
                    opacity: 0.4,
                    metalness: 0,
                    wireframe: false
                }
            }else if (val == 'contour'){
                p = {
                    contour: true,
                    flatShaded: false,
                    opacity: 0.4,
                    metalness: 0,
                    wireframe: false                    
                }
            }else if (val == 'wireframe'){
                p = {
                    contour: false,
                    flatShaded: false,
                    opacity: 0.4,
                    metalness: 0,
                    wireframe: true                    
                }
            }else if (val == 'flat'){
                p = {
                    contour: false,
                    flatShaded: true,
                    opacity: 0.4,
                    metalness: 0,
                    wireframe: false

                }

            }


            if (val == 'isolevel'){
                p = {
                    isolevel: Number(slider_val)
                }

            }
            if (val == 'transparency'){
                p = {
                    opacity: Number(slider_val)
                }
            }
            if (val == 'smoothness'){
                p = {
                    smooth: Number(slider_val)
                }

            }
            stage.getRepresentationsByName("occupancy").setParameters(p);   //we change all the maps, so that if trajectory is changed, the same settings are applied 

        }

        function show_hide_watermap(is_checked, mapname,stage){
            ///This function 
            stage.getComponentsByName(mapname).setVisibility(is_checked);
            console.log(is_checked + mapname)
            
            return(stage)


            
        }

        function show_polar_res(is_checked){
            var o=stage.getComponentsByName("my_comp").list[0]; //"my comp is the name of the pdb structure loaded on NGL " //////  Place this to CreateReps. 
            // polar_residues="Asp or Cys or Gly or Glu or His or Lys or Arg or Asn or Gln or Ser or Thr or Tyr" ////// 
            // o.addRepresentation("licorice", {name:"polar_res",visible:false, sele:polar_residues}) ////// 
            stage.getRepresentationsByName("polar_res").setVisibility(is_checked)
            console.log(stage.getRepresentationsByName("polar_res").setVisibility(is_checked))
            
        }

        function obtain_transmat_for_traj(){
            var edselSel=$("#edSel", window.parent.document);
            var trajmat_dict=edselSel.data("trajmat_dict");
            if (trajmat_dict){
                var traj_id=$("#selectedTraj", window.parent.document).find("#selectedTraj_id").text();
                var mat_info=trajmat_dict[traj_id];
                return mat_info;
            } else {
                return false
            }
        }

        function realign_EDmap(){        
            var mat_info=obtain_transmat_for_traj();
            if (mat_info){            
                var r_angl=mat_info[0];
                var transl=mat_info[1];

                var ed2fofc=stage.getComponentsByName("EDmap_comp_2fofc").list[0];
                var edfofc=stage.getComponentsByName("EDmap_comp_fofc").list[0];
                ed2fofc.setRotation( r_angl)
                ed2fofc.setPosition(transl)
                edfofc.setRotation( r_angl)
                edfofc.setPosition(transl)
            }
        }


//END functions.
//START main
/////////// Set variables: ///////////////////////////////////////////////////////////////
            var struc=$(".str_file", window.parent.document).data("struc_file");
            var delta=Number($(".str_file", window.parent.document).data("delta"));
            var traj_li_all = [];
            var traj_fnum = {};
            var traj_lastPlayedID=0;
            var  path= "/mdsrv/file/_DB/";
            var  traj_path= "_DB/";
            $(".traj_element",window.parent.document).each(function(i,el){
                traj_li_all[traj_li_all.length]=$(this).data("tpath");
                traj_fnum[i]=0;
            });
            var trajComp, player, ori ;
            var clickedRep={};
            var clickedRepLi=[];
            var clickedDistData={};
            var clickedLabData={};
            //var compDistsLi=[];
            var clickedDist={};
            var stepsize = 3;
            var trajtimeout=50;
            var mytraj=$("#selectedTraj" , window.parent.document).data("tpath");
            //var setSelDict={};
            var setSelLi=[];
            var setSelStr="protein";
            var trajchange=false;
            var trajIntType="";
            var onclickshow="dists";
            var pdb_muts= $("#view_screen", window.parent.document).data("pdb_muts");
            var pdb_vars= $("#view_screen", window.parent.document).data("pdb_vars");
            //var gpcrSelExp= parent.gpcr_selection()
            //!
            //var fpsegStr=$("#fpdiv" , window.parent.document).data("fpseg_li");
            
            var fpsegStr , FPscheme;
            
//        var popOverSettings = {
//            placement: 'auto right',
//            trigger:"click",
//            container: 'body',
//            html: true,
//            selector: '.showpopover', //Sepcify the selector here
//            viewport: '#viewport',
//            content: function () {
//                return $('#popover-content').html();
//            }
//        }
//
//        $('body').popover(popOverSettings);   
//        $('body').tooltip({
//            selector: '.showtooltip',
//            trigger:"hover",
//            html:true,
//        });   
        //$('[data-toggle="popover"]').popover(); 

        $(document.body).bind('createNGL', function(e, cont_w , cont_w_in , cont_h_num) {
            set_ngl_size(cont_w , cont_w_in , cont_h_num);
            
            stage = new NGL.Stage( "viewport" );
            stage.setParameters( { backgroundColor: "white" /*, cameraType:"orthographic"*/} );
            window.addEventListener( "resize", function( event ){
                stage.handleResize();
            }, false );
            fpsegStr=parent.fpsegStr;
            if (fpsegStr){
                fpsegStr=fpsegStr.replace("+"," or ");
                var fpsegli=fpsegStr.split(",");
                var fpcolors=[];
                var helix_colors =["#78C5D5","#5FB0BF","#459BA8","#5FAF88","#79C268","#9FCD58","#C5D747","#DDD742","#F5D63D","#F3B138","#F18C32","#ED7A6A","#E868A1","#D466A4","#BF63A6"];
                for (segN=0; segN<fpsegli.length ;segN++ ){
                    var segsel=fpsegli[segN];
                    if (segsel){
                        fpcolors.push([helix_colors[segN] , "protein and ("+ segsel +")" ]);
                    }
                }
                FPscheme = NGL.ColormakerRegistry.addSelectionScheme( fpcolors, "FPscheme" );                
            }
            
            if (struc) {
                stage.loadFile( path + struc , {visible: true}).then( function( o ){
                        o.setSelection("protein");
                        if (fpsegStr){
                            o.addRepresentation( "cartoon", { colorScheme: FPscheme,  sele: "protein" } );
                        } else {
                            o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: "protein" } );
                        }
                        o.setName("my_comp");
                        //$("#loading", window.parent.document).html("");
                    if( traj_li_all.length > 0 ) {
                        for (t=0 ; t < traj_li_all.length ; t++){
                            o.addTrajectory( traj_path + traj_li_all[t] );
                        }
                        trajComp = stage.getComponentsByName("my_comp").list[0].trajList[0]; 
                        var tral_split=traj_li_all[0].split("/");
                        var traj_filenm=tral_split[tral_split.length -1];
                        var traj_db_id=traj_filenm.split("_")[0];
                        var mytraj_nm="Traj. id: "+traj_db_id;
                        $("#last_played").text(mytraj_nm);
                        //$("#trajRange").attr("max",trajComp.trajectory._frameCount);
                        //traj_li=[mytraj];
                        //$("#buttons").html("<div style='width:586px;height:30px;overflow: auto;'><button style='margin:1px' type='button' class='btn btn-success btn-xs traj_btn' id='playerButton0'><span style='vertical-align:0px' class='glyphicon glyphicon-play'></span> "+mytraj.match(/(\w*)(\.\w*)$/)[1])+'</button></div>'; 
                    }
                    $(".traj_element" , window.parent.document).click(function(){
                        mytraj=$(this).data("tpath");
                        traj_id=traj_li_all.indexOf(mytraj);
                        $(".traj_btn").attr("id","playerButton"+traj_id.toString());
                        if (player && $(".traj_btn").hasClass("active")){
                            player.pause();
                            $(".traj_btn").removeClass("active");
                            $(".traj_btn").children().attr("class","glyphicon glyphicon-play");
                        }
                        traj_lastPlayedID=traj_id;
                        var trajchange_f=parent.changeTrajFlarePlot(this,traj_fnum[traj_id]);
                        trajComp = stage.getComponentsByName("my_comp").list[0].trajList[traj_id];
                        trajchange=trajchange_f;
                        trajComp.setFrame(traj_fnum[traj_id]);
                        //$("#selectionDiv" , window.parent.document).trigger("click");                        
                        $("#trajRange").attr("max",trajComp.trajectory._frameCount);
                        var tral_split=traj_li_all[traj_id].split("/");
                        var traj_filenm=tral_split[tral_split.length -1];
                        var traj_db_id=traj_filenm.split("_")[0];
                        var mytraj_nm="Traj. id: "+traj_db_id;
                        $("#last_played").text(mytraj_nm);

                        realign_EDmap()

                        //WATERMAP CODE 
                        var selected_traj=$(this).attr("id").replace("traj_id_", "");
                        var watermap_checked= $(".WaterDisplay", window.parent.document).is(":checked")  
                        
                        if (watermap_checked){
                            var hide_list=[]
                            for (var i = 0; i <trajnames_list.length; i++){
                                if (trajnames_list[i].includes(selected_traj)){
                                    var selected_filename=trajnames_list[i]
                                    var watermap_loaded= stage.getComponentsByName(selected_filename)
                                    //
                                    if($.isEmptyObject(watermap_loaded) == false){   
                                    var watermap=watermap_loaded.list[0]
                                    watermap.setVisibility(true)

                                    }else{
                                        console.log("the map is not loaded")
                                    }
                                    //
                    
                                }else{
                                    var hide=trajnames_list[i]
                                    hide_list.push(hide)
                                    // stage.getComponentsByName(hide).list[0].setVisibility[false]
                                }
                            }
                            console.log('we check the selected_filename that will be set to visibility true' + selected_filename)
                            // var test=stage.getComponentsByName(selected_filename).list[0]
                            // test.setVisibility(true)
                            console.log(hide_list)

                            for (var j=0; j<hide_list.length; j++){
                                var hide_name=hide_list[j]
                                var hide_map=stage.getComponentsByName(hide_name).list[0]
                                hide_map.setVisibility(false)

                            }

                        }

                    });
                    trajButtons(o);


                    /*var m = new NGL.Matrix4().fromArray([1,0,0,0,
                                                         0,0,-1,0,
                                                         0,1,0,0,
                                                         0,0,0,1]);
                    o.setTransform(m);*/
                    stage.autoView();
                    ori= stage.viewerControls.getOrientation();
                    $("#selectionDiv", window.parent.document).on("click" , function(){
                        createReps();
                    });

                    //selChange();      
                    
                    hoverStruc();
                    clickStruc();
                    
                    createReps()


                });


                // this part is after stage.load. 
                var dict_occupancy=$("#analysis_watermap", window.parent.document).data("occupancy_data")
                var pattern="/protwis/sites/files/"  //replace this when Ismael gives permission

                var traj_list_md=[]
                $(".traj_element",window.parent.document).each(function(){
                    var trajfileid=$(this).data("tpath").match(/[0-9]{5,25}/g);
                    if (trajfileid){
                        traj_list_md[traj_list_md.length]=trajfileid.toString();   //matches the trajid of all the trajectories loaded in the server 
                    }
                });


                // loop over dictionary with trajid and filepath, change path with serverpath and load the maps  load all the maps in one time 
                if (dict_occupancy){
                    var trajnames_list=[]      //["10350_occupancy_31.dx", "10351_occupancy_31.dx", "10356_occupancy_31.dx"] to create this list with trajfilenames, these are coupled to the stage.loadFile 
                    for (var traj_key in dict_occupancy){
                        if (traj_list_md.includes(traj_key)){  //This is to check if the trajectories in dict and on server are equal

                            var trajPath=dict_occupancy[traj_key].replace(pattern, path)  //change this when Ismael gives permission 
                            var trajName=trajPath.match(/[A-Za-z0-9]+_occupancy_[0-9]+.dx/g).toString()
                            trajnames_list.push(trajName)

                            stage.loadFile(trajPath, {visible:false}).then(function(watermap){
                                watermap.addRepresentation("surface", {
                                    name: "occupancy",
                                    color: "#7baedb", 
                                    isolevelType: "value",
                                    isolevel: 0.3,

                                    // contour: false,
                                    flatShaded: false,
                                    opacity: 0.5,
                                    metalness: 0,
                                    wireframe: false,
                                    smooth: 0,
                                    linewidth:0.1,

                                });

                                // watermap.addRepresentation("slice", {
                                // name:"slice",
                                // dimension: "x",
                                // })

                            });                           


                        };     
                    };



                    // ACTION with Jquery select button. check which map is selected from dropdown. 
                    $(".WaterDisplay", window.parent.document).on("change", function(){
                        var is_checked=$(this).is(":checked");
                        var slice_checked=$(".SliceDisplay", window.parent.document).is(":checked");
                        var selected_traj=$("#selectedTraj_id", window.parent.document).html().match(/[0-9]*/).toString()   //matches trajectory id. 
                        for (var i = 0; i < trajnames_list.length; i++){
                            if (trajnames_list[i].includes(selected_traj)){
                                var selected_filename=trajnames_list[i]
                            }
                        }

                        stage = show_hide_watermap(is_checked,selected_filename, stage)
                    })


                    $("#WatermapType", window.parent.document).on("click",function(){
                        var v=$(this).val()
                        var selected_traj=$("#selectedTraj_id", window.parent.document).html().match(/[0-9]*/).toString()   //matches trajectory id.
                        
                        for (var i = 0; i < trajnames_list.length; i++){
                            if (trajnames_list[i].includes(selected_traj)){
                                var selected_filename=trajnames_list[i]
                            }
                        }
                        change_watermap_style(v, selected_filename)


                    })

                    $(".slider_volmap", window.parent.document).on('input',function(){
                        var slider_val=$(this).val();

                        var selected_traj=$("#selectedTraj_id", window.parent.document).html().match(/[0-9]*/).toString()   //matches trajectory id.
                        
                        for (var i = 0; i < trajnames_list.length; i++){
                            if (trajnames_list[i].includes(selected_traj)){
                                var selected_filename=trajnames_list[i]
                            }
                        }
                        var slidetest=$(this).parent().siblings(".slider_val").html(slider_val);
                        var v=$(this).data("valtype");
                        change_watermap_style(v, selected_filename, slider_val)

                    })



                    // $(".PolarDisplay", window.parent.document).on("click", function(){
                    //     var is_checked=$(this).is(":checked");
                    //     // console.log(is_checked)

                    //     var selected_traj=$("#selectedTraj", window.parent.document).html().match(/[0-9]*/).toString()   //matches trajectory id. 
                    //     for (var i = 0; i < trajnames_list.length; i++){
                    //         if (trajnames_list[i].includes(selected_traj)){
                    //             var selected_filename=trajnames_list[i]
                    //         }
                    //     }
                    //     show_polar_res(is_checked)
                    // })

                    $(".SliceDisplay", window.parent.document).on("click", function(){
                        var is_checked=$(this).is(":checked");
                        var water_check= $(".WaterDisplay", window.parent.document).is(":checked"); //check if slicedisplay checkbox is checked 
                        var selected_traj=$("#selectedTraj", window.parent.document).html().match(/[0-9]*/).toString()   //matches trajectory id. 
                        for (var i = 0; i < trajnames_list.length; i++){
                            if (trajnames_list[i].includes(selected_traj)){
                                var selected_filename=trajnames_list[i]
                            }
                        }
                        stage = show_hide_slice(is_checked,water_check, selected_filename, stage)

                    })


                }; 
 

                var pdbid=$("#pdbid", window.parent.document).text();
                if (pdbid.indexOf(".")>-1){
                    var pdbid_spl=pdbid.split(".");
                    pdbid=pdbid_spl[0]
                }

                var mat_info=obtain_transmat_for_traj();
                var r_angl=mat_info[0];
                var transl=mat_info[1];

                if (pdbid && r_angl && transl){
                    var edmapUrl = "https://edmaps.rcsb.org/maps/";
                    stage.loadFile(edmapUrl + pdbid.toLowerCase() + "_2fofc.dsn6", {visible: false}).then(function(edc){
                        edc.setName("EDmap_comp_2fofc");
                        edc.setRotation( r_angl);
                        edc.setPosition(transl);
                        edc.addRepresentation("surface", {
                          name:"2fofc",
                          contour: true,
                          color: "skyblue",
                          isolevel: 1.5,

                          flatShaded: false,
                          opacity: 1,
                          metalness: 0,
                          wireframe: false
                        })

                    })
                    stage.loadFile(edmapUrl + pdbid.toLowerCase() + "_fofc.dsn6", {visible: false}).then(function(edc){
                        edc.setName("EDmap_comp_fofc");
                        edc.setRotation( r_angl)
                        edc.setPosition(transl)


                        edc.addRepresentation("surface", {
                          name:"fofcpos",
                          color: "mediumseagreen",
                          isolevel: 3,
                          //boxSize: 10,
                          contour: true,
                          flatShaded: false,
                          opacity: 1,
                          metalness: 0,
                          wireframe: false
                        })
                        edc.addRepresentation("surface", {
                          name:"fofcneg",
                          color: "tomato",
                          isolevel: 3,
                          negateIsolevel: true,
                          //boxSize: 10,
                          contour: true,
                          flatShaded: false,
                          opacity: 1,
                          metalness: 0,
                          wireframe: false

                        })

                    })

                    $("#EDselectionDiv", window.parent.document).on("click" , function(){
                        updateEDmapSel();
                    });
                    $(".EDmapStype", window.parent.document).on('change' ,function(){
                        var v=$(this).val()
                        var mapsel=$(this).data("map");
                        change_EDmap_style(v,mapsel,"general");
                    });
                    $(".EDdisplay", window.parent.document).on("change" , function(){
                        var is_checked=$(this).is(":checked");
                        var mapchanged=$(this).val();
                        show_hide_map(is_checked,mapchanged);

                    });
                    $(".EDcolsect", window.parent.document).on('change',".EDcolorFree" ,function(){
                        if ($(this).parent().hasClass("has-error")){
                            var color ="#FFFFFF"
                        } else {
                            var color=$(this).val();
                        }
                        var mapsel=$(this).parents(".EDcolsect").data("map");
                        change_EDmap_style(color,mapsel,"color");
                    });

                    $(".EDselcolvar", window.parent.document).on("click" , function(){
                        var color=$(this).attr("data-color");
                        var mapsel=$(this).parents(".EDcolsect").data("map");
                        change_EDmap_style(color,mapsel,"color");
                    });

                    $(".edslider", window.parent.document).on('input',function(){
                        var slider_val=$(this).val();
                        $(this).parent().siblings(".slider_val").html(slider_val);
                        var mapsel=$(this).data("map");
                        var valtype=$(this).data("valtype");
                        if (valtype=="zoom"){
                            var loadEd = parent.results_ED["loadEd"];        
                            if (loadEd){
                                stage.setFocus(slider_val);
                            }
                        }else {
                            change_EDmap_style(slider_val,mapsel,valtype);
                        }
                    })
    



                }
////////////SETTINGS:

                $("#screenshot", window.parent.document).click(function(){
                    stage.makeImage( {
                        factor: 5,
                        antialias: true,
                        trim: false,
                        transparent: false
                    } ).then( function( blob ){
                        NGL.download( blob, "screenshot.png" );
                    } );
                });
                //$(".imp_btn2", window.parent.document).click
                $(".dist_btw", window.parent.document).on("click" , ".imp_btn2" ,function(){
                
                    allClickedDists=[];
                    for (k in clickedDist){
                        allClickedDists.push(clickedDist[k]);
                    }
                    $(".imp_btn2", window.parent.document).closest(".dist_pair").find(".has-error").removeClass("has-error")
                    parent.clickedDistToAnalysis(allClickedDists);
                });
                
                $("#background", window.parent.document).click(function(){
                    if ($(this).hasClass("light")){
                        stage.setParameters( { backgroundColor: "black" } );
                        $(this).removeClass("light");
                        $(this).addClass("dark");
                        $(this).attr("title","Light background");
                    }else if ($(this).hasClass("dark")){
                        stage.setParameters( { backgroundColor: "white" } );
                        $(this).removeClass("dark");
                        $(this).addClass("light");
                        $(this).attr("title","Dark background");
                    }
                });
                
                /*$(".bckg_theme", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).siblings(".bckg_theme").removeClass("active");
                        $(this).addClass("active");
                        if ($(this).attr("id")=="bckg_light"){
                            stage.setParameters( { backgroundColor: "white" } );
                        } else {
                            stage.setParameters( { backgroundColor: "black" } );
                        }
                    }
                });*/
                $("#center", window.parent.document).click(function(){
                    //stage.setOrientation([[-1.504730224609375, 2.6254119873046875, 1.9448356628417969], [-1.504730224609375, 2.6254119873046875, -117.27891736575096], [0, 1, 0]])
                    stage.autoView(1000);
                });
                $("#restartPos", window.parent.document).click(function(){
                    stage.animationControls.orient(ori);
                });
                
                $(".projectionOP", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).addClass("active");
                        $(this).siblings(".projectionOP").removeClass("active");
                        if ($(this).attr("id") == "projOrtho"){
                            stage.setParameters( { cameraType: "orthographic"} );
                        } else {
                            stage.setParameters( { cameraType: "perspective"} );
                        }
                    }
                });
                $(".spinSet", window.parent.document).click(function(){
                    if (! $(this).hasClass("active")){
                        $(this).addClass("active");
                        $(this).siblings(".spinSet").removeClass("active");
                        if ($(this).attr("id") == "spinOn"){
                            stage.setSpin( [ 0, 1, 0 ], 0.01 );
                        } else {
                            stage.setSpin( null );
                        }
                    }
                });
                $("#trajStep", window.parent.document).on("change" , function(){
                    var tajstep = $(this).val();
                    if (tajstep){
                        tajstep = Number(tajstep);
                        var pos = Math.abs(tajstep)
                        var rounded= Math.round(pos);
                        if (rounded <= 0){
                            var rounded = 1;
                        } 
                        if (tajstep != rounded){
                            tajstep = rounded;
                            $(this).val(tajstep);
                        }
                    } else {
                        tajstep=3;
                    }
                    if (player && $(".traj_btn").hasClass("active")){
                        player.pause();
                        $(".traj_btn").removeClass("active");
                        $(".traj_btn").children().attr("class","glyphicon glyphicon-play");
                        //var lastfr=trajComp.trajectory.currentFrame;
                        //traj_fnum[traj_lastPlayedID]=lastfr;
                    }
                    stepsize = tajstep;
                });
                
                $("#trajTimeOut", window.parent.document).on("change" , function(){
                    var timeout = $(this).val();
                    if (timeout){
                        timeout = Number(timeout);
                        var pos = Math.abs(timeout);
                        var rounded= Math.round(pos);
                        if (rounded <= 0){
                            var rounded = 1;
                        } 
                        if (timeout != rounded){
                            timeout = rounded;
                            $(this).val(timeout);
                        }
                    } else {
                        timeout=50;
                    }
                    if (player && $(".traj_btn").hasClass("active")){
                        player.pause();
                        $(".traj_btn").removeClass("active");
                        $(".traj_btn").children().attr("class","glyphicon glyphicon-play");
                        //var lastfr=trajComp.trajectory.currentFrame;
                        //traj_fnum[traj_lastPlayedID]=lastfr+stepsize;
                    }
                    trajtimeout = timeout;
                });
                
                $("#trajIntType", window.parent.document).on("change" , function(){
                    var intType=$(this).val();
                    if (player && $(".traj_btn").hasClass("active")){
                        player.pause();
                        $(".traj_btn").removeClass("active");
                        $(".traj_btn").children().attr("class","glyphicon glyphicon-play");
                        //var lastfr=trajComp.trajectory.currentFrame;
                        //traj_fnum[traj_lastPlayedID]=lastfr+stepsize;
                    }
                    trajIntType=intType;
                })
                
                $("#viewport").on("mousedown" , function(){
                    $("#varinfo_par" , window.parent.document).html("");
                    //$('.popover').popover("hide");                    
                });
                
                $(".onclickshow" , window.parent.document).click(function(){
                    if (! $(this).hasClass("is_active")){
                        $(this).css("background-color","#FFF7F7").addClass("is_active");
                        $(this).siblings().css("background-color","#FFFFFF").removeClass("is_active");
                        if ($(this).text().indexOf("Distances") > -1){
                            $("#onclickbtntext", window.parent.document).text("dists.")
                            onclickshow="dists";
                        } else if ($(this).text().indexOf("Variants") > -1) {
                            $("#onclickbtntext", window.parent.document).text("vars.")
                            onclickshow="vars";
                        }else {
                            $("#onclickbtntext", window.parent.document).text("muts.")
                            onclickshow="muts";
                        }
                    };
                    $("#selectionDiv" , window.parent.document).trigger("click");
                });
                
                
            }
        });

        
        
        var myStopVar = setInterval(callParent, 1000);
        function callParent(){
            parent.$('body').trigger('iframeSet');
        }
        
        $(document.body).bind('iframeSetOk', function(e) {
            clearInterval(myStopVar);
        });
        
        });
        });
    </script>

    <div id="toiframe" style="width:620px;height:445px">
        <div id="viewport" style="width:620px; height:420px;"></div><!--395 -> 445 -->
        <div style="height:80px">
            <div id="buttons" style="width:616px;margin-top:36px;margin-left:2px"><!-- 30+36+10 =~ 80 -->
            </div>
            <div id="clear_dists_btn" style="margin-left:3px;height:10px;margin-top:95px;">
            </div>
        </div>
        <div id="trajRangeDiv" style="position:absolute;width:616px;height:30px;margin-top:265px;margin-left:2px;visibility:hidden">
            <p style="margin-right:18px;font-size:12px;color:#B8B8B8" class="pull-right" id="last_played"></p>
            <div style="font-size: 17px;float: left;padding:0;border:none;width:20px;background-color:transparent;margin:10px 0 0 5px;cursor:pointer" class="traj_btn" id=playerButton0><span class="glyphicon glyphicon-play" style="color:#808080"></div>

          <input title="Frame" id="trajRange" type="range" name="points" id="points" value="0" min="0" max="100">
          
          <p style="margin-right:18px;font-size:12px;color:#B8B8B8;margin-top:-17px" class="pull-right" id="traj_time"><span id="traj_time_val">0</span>ns</p>
        </div>
        <span id="varinfo"></span>
        <div id="infoPannel" style="width:616px;height:30px;margin-top:425;margin-left:2px;">
            <div id="atomClicked" style="color:grey;float:left;margin-right:4px;"></div>
            <div id="atomInfo" style="color:green;"></div>
        </div>
    </div>
</body>
</html>
