<!DOCTYPE html>
<html lang="en">
<head>
    <title>NGL/MDsrv</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link rel="icon" href="mdsrv/webapp/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="mdsrv/webapp/css/font-awesome.min.css" />
    <link rel="stylesheet" href="mdsrv/webapp/css/main.css" />
    <link rel="subresource" href="mdsrv/webapp/css/light.css" />
    <link rel="subresource" href="mdsrv/webapp/css/dark.css" />
</head>
<body>
    <!-- NGL -->
    <script src="mdsrv/webapp/js/ngl.js"></script>

    <!-- UI -->
    <script src="mdsrv/webapp/js/lib/signals.min.js"></script>
    <script src="mdsrv/webapp/js/lib/tether.min.js"></script>
    <script src="mdsrv/webapp/js/lib/colorpicker.min.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.extra.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.ngl.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.helper.js"></script>
    <script src="mdsrv/webapp/js/gui.js"></script>

    <!-- MDSRV -->
    <script src="mdsrv/webapp/js/mdsrv.js"></script>

    <script>
        NGL.cssDirectory = "mdsrv/webapp/css/";
        NGL.documentationUrl = "http://arose.github.io/ngl/api/";

        // Datasources
        NGL.DatasourceRegistry.add(
            "file", new MdsrvDatasource( window.location.origin + "/mdsrv/" )
        );
        NGL.DatasourceRegistry.listing = NGL.DatasourceRegistry.get( "file" );
        NGL.DatasourceRegistry.trajectory = NGL.DatasourceRegistry.get( "file" );
        document.addEventListener( "DOMContentLoaded", function(){
            stage = new NGL.Stage();
            NGL.StageWidget( stage );
        stage.setParameters( { backgroundColor: "white" } );
        stage.parameters.cameraType="orthographic";
//////////////

        function selWithinComponent(o,dist_comp){
            var show = dist_comp[0];
            var radius=Number(dist_comp[1]);
            var ligSele =dist_comp[2];
            var sele=o.structure.getAtomSetWithinSelection( new NGL.Selection( ligSele ), radius );
            //var center=o.structure.atomCenter( new NGL.Selection( ligSele ) );
            var sele2 = o.structure.getAtomSetWithinGroup( sele );
            return([sele, sele2])
        }

        function clickDists(o){
            var clicktrue = true;
            var atom1 , atom2 , res2 , res2, myrepr;
            var lbl_id=0;
            var dist_id=0;
            var clickedRep={};
            var lbl_name1, lbl_name2, dist_name;
            stage.signals.clicked.add( function( d ){
               // hovrep.repr.clear()
                if (clicktrue){
                    if (d.atom){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.serial+") - ";
                        lbl_name1="label_"+lbl_id.toString();
                        lbl_id+=1;
                        myrepr = o.addRepresentation( "label", {
                            sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                            color: "#cccccc", scale: 1.7, labelType: "qualified name",fontWeight: "normal", name :lbl_name1  } );
                        atom1 = d.atom.serial.toString();
                        /*if (! clickedRep[atom1]){
                            clickedRep[atom1]=[];
                        }
                        clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;*/
                        clicktrue = false;
                    }
                }else{
                    if (d.atom){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.serial+") - ";
                        atom2 = d.atom.serial.toString();
                        //res2 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
                        clicktrue = true;
                        if (atom1 != atom2){
                            lbl_name2="label_"+lbl_id.toString();
                            lbl_id+=1;
                            dist_name="dist_"+dist_id.toString();
                            dist_id+=1;
                            var add1=[lbl_name1, lbl_name2 , dist_name];
                            var add2 = [lbl_name1, lbl_name2 , dist_name];
                            if (! clickedRep[atom1]){
                                clickedRep[atom1]=[];
                            }
                            if (! clickedRep[atom2]){
                                clickedRep[atom2]=[];
                            }
                            for (an = 0; an < add1.length;an++) {
                                clickedRep[atom1][clickedRep[atom1].length]=add1[an]
                            }
                            for (an = 0; an < add2.length;an++) {
                                clickedRep[atom2][clickedRep[atom2].length]=add2[an]
                            }
                            o.addRepresentation( "label", {
                                sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                                color: "#cccccc", scale: 1.7, labelType: "qualified name" ,fontWeight: "normal" , name:lbl_name2 } );
                            var atomPair = [[ Number(atom1), Number(atom2) ]];
                            o.addRepresentation( "distance", { atomPair: atomPair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dist_name} );

                        } else {
                            if (atom1 in clickedRep){
                                var toRv=clickedRep[atom1];
                                for (rvN = 0; rvN < toRv.length;rvN++) {
                                    var repName=toRv[rvN];
                                    stage.getRepresentationsByName(repName).list[0].repr.clear();
                                }
                                stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                                delete clickedRep[atom1];
                            } else {
                                if (! clickedRep[atom1]){
                                    clickedRep[atom1]=[];
                                }
                                clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;
                            }
                        }
                    } else {
                        clicktrue = true;
                        stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                        //lbl_id -=1;
                    }
                }
            } );
        }

///////////////
            var struc =s_path=t_path =traj = rc= sel=sel_method=cons_pos= pdA=pdb=pdC=pdF=cp=dist_within=cons_comp=nonGPCR=onlyChains= int_res_s=dist_groups_s="";
            var struc = NGL.getQuery( "struc" );
            var s_path = "file://_DB/";// MAYBE I WILL NEED TO CHANE THIS
            var t_path = "file://_DB/";// MAYBE I WILL NEED TO CHANE THIS
            var traj = NGL.getQuery( "traj" );
            var  rc= NGL.getQuery("rc");
            var  sel= NGL.getQuery("sel");
            var  sel_method= NGL.getQuery("sh");
            var  cons_pos= NGL.getQuery("pd");
            var  pdA= NGL.getQuery("la");
            var  pdB= NGL.getQuery("lb");
            var  pdC= NGL.getQuery("lc");
            var  pdF= NGL.getQuery("lf");
            var  cp= NGL.getQuery("cp");
            var  dist_within= NGL.getQuery("wth");
            var  cons_comp=NGL.getQuery("cc");
            var  nonGPCR= NGL.getQuery("ng");
            var  onlyChains= NGL.getQuery("och");
            var int_res_s=NGL.getQuery("in");
            var dist_groups_s=NGL.getQuery("dc");

            var rc_sel = "";
            var all_cp = "";
            var all_conscp="";

            if (rc=="y" || ! nonGPCR){
                rc_sel = "protein";
                if (cp || cons_comp) {
                    rc_sel="protein or ";
                }
             }
             


             /*var va = "test";             
             for (v in va){ 
                console.log(v);
                console.log(va[v]);
             };*/
             
             var cp_li=[];
             if (cp){
                 cp_li = decodeURIComponent(cp.replace(/\+/g, " ")).split(",");
                 for (comp = 0; comp < cp_li.length; comp++){
                     all_cp += (cp_li[comp] + " or ");
                 }
                 all_cp = all_cp.slice(0, -3);
             }

             if (cons_comp){
                 var cons_cp_li = decodeURIComponent(cons_comp.replace(/\+/g, " ")).split(",");
                 if (cp_li.length > 0){
                     var cons_comp_p=[];
                     for (compN = 0; compN < cons_cp_li.length; compN++) {
                         var mycomp =cons_cp_li[compN];
                         if (cp_li.indexOf(mycomp)==-1){
                             cons_comp_p[cons_comp_p.length]=mycomp;
                         }
                     }
                     if (cons_comp_p.length >0){
                         all_conscp=" or ";
                         for (compN = 0; compN < cons_comp_p.length; compN++) {
                             all_conscp += (cons_comp_p[compN] + " or ");
                         }
                         all_conscp = all_conscp.slice(0, -3);
                     }
                 } else {
                     for (compN = 0; compN < cons_cp_li.length; compN++){
                         all_conscp += (cons_cp_li[compN] + " or ");
                     }
                     all_conscp = all_conscp.slice(0, -3);
                 }
             }

             var visibility=true;
             if (rc=="n" && ! cp && nonGPCR && ! cons_comp){
                 visibility = false;
             }

             var sele_final = "";
             if (sel && sel_method=="sel"){
                 var sel_deco=decodeURIComponent(sel.replace(/\+/g, " "));
                 sele_final = "("+rc_sel + all_cp +all_conscp +") and ("+ sel_deco +")" ;
             } else{
                 sele_final = rc_sel + all_cp+all_conscp;
             }
             function fromChainLiToNGL(nonGPCR){ 
                 var nonGPCR_li=nonGPCR.split(",");
                 var nonGPCR_mod="";
                 for (chain_n = 0; chain_n < nonGPCR_li.length; chain_n++) {
                     nonGPCR_mod+=":"+nonGPCR_li[chain_n]+" , ";
                 }
                 nonGPCR_mod=nonGPCR_mod.slice(0,-3);
                 return nonGPCR_mod
             }

             var substr_nonGPCR="";
             if (nonGPCR){
                 var nonGPCR_mod = fromChainLiToNGL(nonGPCR);
                 substr_nonGPCR=" and not ("+ nonGPCR_mod+")";
             }
                  
                    if (struc) {
                        stage.loadFile( s_path + struc, {sele: sele_final, visible: visibility}  ).then( function( o ){
                        //stage.setOrientation([[-133.5657750896191,-72.54646915024105,3.7714955141361095],[-0.06193670847497234,0.062245585853203875,-0.9961372049999252],[-0.9979991912841797,-0.38649940490722656,-3.1299991607666016],[0,0,0]]);
                                o.setName("my_comp");
                                var aa=2515;
                                if (rc=="y"){
                                    o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein"+substr_nonGPCR } );
                                    /*if ((sel_method =="high" && sel) || cons_pos =="y" || dist_within ) {
                                        o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: "protein"+substr_nonGPCR } );
                                     }else{
                                        o.addRepresentation( "cartoon", { colorScheme: "sstruc", sele: "protein" +substr_nonGPCR } );
                                     }*/
                                } else {
                                    if (onlyChains){ //When we don't have receptor but have other prots
                                        var nonGPCR_add = fromChainLiToNGL(onlyChains);
                                        var add_nonGPCR=" and ("+ nonGPCR_add+")";
                                        o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Pastel1",  sele: "protein"+ add_nonGPCR } );
                                    }
                                     /*if ((sel_method =="high" && sel) || cons_pos =="y" || dist_within ) {
                                        o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: "protein"+add_nonGPCR } );
                                     }else{
                                        o.addRepresentation( "cartoon", { colorScheme: "sstruc", sele: "protein" +add_nonGPCR } );
                                     }*/

                                 }
     //    o.addRepresentation( "distance", { atomPair: [[4500,4600]] , colorValue: "#3366cc", colorScheme:"uniform", labelColor: "#7da8ff" } );
  //       o.addRepresentation( "distance", { atomPair: [[4598, 4502]] , colorValue: "#3366cc", colorScheme:"uniform", labelColor: "white" } );
                                if (cp){
                                    o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: all_cp, radius: 0.30 } )
                                }
                                if (cons_pos == "y"){
                                    var pre_pd_all=[pdA,pdB,pdC,pdF];
                                    var pd_all = [];
                                    for (elN = 0; elN < pre_pd_all.length; elN++) {
                                        var class_poss=pre_pd_all[elN];
                                        if (class_poss){
                                            pd_all[pd_all.length]=class_poss
                                        }
                                    }
                                    var color_list = ["#00d8ff","#ff8500","#ccff00","#ff00d2"] // A, B, C, F

                                    if (sel ){
                                        var sel_deco=decodeURIComponent(sel.replace(/\+/g, " "));
                                        if (sel_method == "high"){
                                            o.addRepresentation( "licorice", {  colorValue: "#00d215", radius: "0.210", sele: sel_deco  } ); 
                                            for (ind = 0; ind < pd_all.length; ind++) {
                                                class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                                if (class_li){
                                                    var cons_pos_ok = class_li.replace(/,/g," OR ")
                                                    o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele:"protein and ("+ cons_pos_ok +")"  } ); 
                                                }
                                            }   

                                        } else {
                                            /*if (rc=="y"){
                                                o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: sel_deco });
                                            }*/

                                            for (ind = 0; ind < pd_all.length; ind++) {
                                                class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                                if (class_li){
                                                    var cons_pos_ok = class_li.replace(/,/g," OR ")
                                                    o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele:  "protein and ("+ cons_pos_ok +")"  } );
                                                }
                                            }   
                                            //o.setSelection( sel_deco );
                                        }
                                     } else {
                                         for (ind = 0; ind < pd_all.length; ind++) {
                                             class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                             if (class_li){
                                                 var cons_pos_ok = class_li.replace(/,/g," OR ")
                                                 o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele: "protein and ("+ cons_pos_ok +")" } );
                                             }
                                         }   



////////////////////////////////////////////////
                                        /*if (rc=="y"){
                                            o.addRepresentation( "cartoon", { colorScheme: "uniform", colorValue:"#ffccf5",  sele: "protein" } );
                                        }*/
                                     }

                                } else {
                                    if (sel ){
                                        var sel_deco=decodeURIComponent(sel.replace(/\+/g, " "));
                                        if (sel_method == "high"){
                                            o.addRepresentation( "licorice", {  colorValue: "#00d215", radius: "0.210", sele: sel_deco  } );
                                     /*   } else {
                                              //o.setSelection( sel_deco );
                                        */
                                        }
                                     }
                                 }
                                if( traj ) {
                                    var traj_str = decodeURIComponent(traj.replace(/\+/g, " "));
                                    var traj_li=traj_str.split(",")
                                    for (t = 0; t < traj_li.length; t++) {
                                        o.addTrajectory( t_path + traj_li[t] );
                                    }
                                }
                                if (dist_within){
                                    var dist_within_li = decodeURIComponent(dist_within.replace(/\+/g, " ")).split(",");
                                    for (wth_n = 0; wth_n < dist_within_li.length; wth_n++) {
                                        var dist_comp=  dist_within_li[wth_n].split("-");
                                        var ligSele=dist_comp[2];
                                        var show =dist_comp[0];
                                        var WthRepName="sel"+ligSele;
///////////////
                                        var restriction="";
                                        var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                                        if (show_sup != "NONE"){
                                            o.addRepresentation( "licorice", { colorValue:"#dcffae", radius: "0.210", sele: ligSele, name:WthRepName+"0" } );
                                            restriction="not ("+ligSele+") and ";
                                        }               
///////////////
                                        var result=selWithinComponent(o,dist_comp);
                                        var sele = result[0];
                                        var sele2 = result[1];
                                        o.addRepresentation( "licorice", { colorValue:"#ff7575", radius: "0.210", sele: show+" and "+restriction + sele.toSeleString(), name:WthRepName } );
                                        o.addRepresentation( "licorice", { colorValue:"#ff7575",opacity:0.5 , radius: "0.210", sele: show+" and "+restriction + sele2.toSeleString() , name:WthRepName+"2"} );
                                    }
                                    var trajCompT=stage.getComponentsByName("my_comp").list[0].trajList;
                                    for (trajN = 0; trajN < trajCompT.length; trajN++) {
                                        trajCompT[trajN].signals.frameChanged.add(function(){
                                            for (wth_n = 0; wth_n < dist_within_li.length; wth_n++) {
                                                var dist_comp=  dist_within_li[wth_n].split("-");
                                                var show =dist_comp[0];
                                                var ligSele=dist_comp[2];
                                                var WthRepName="sel"+ligSele;
///////////////
                                                var restriction="";
                                                var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                                                if (show_sup != "NONE"){
                                                    restriction="not ("+ligSele+") and ";
                                                }               
///////////////
                                                var result=selWithinComponent(o,dist_comp);
                                                var sele = result[0];
                                                var sele2 = result[1];
                                                stage.getRepresentationsByName(WthRepName).setSelection(show+" and "+restriction + sele.toSeleString());
                                                stage.getRepresentationsByName(WthRepName+"2").setSelection(show+" and "+restriction + sele2.toSeleString());
                                            }
                                        });
                                    }

                                }
                                if (dist_groups_s){
                                    dist_groups_s_deco=decodeURIComponent(dist_groups_s.replace(/\+/g, " "));
                                    dist_groups_li=dist_groups_s_deco.split(",");
                                    var cd_id=0;
                                    var plot_colors=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"]; 
                                    for (distgN = 0; distgN < dist_groups_li.length; distgN++) {
                                        var dist_group=dist_groups_li[distgN];
                                        var dist_pair_li=dist_group.split("a");
                                        for (pair_n = 0; pair_n < dist_pair_li.length; pair_n++) {
                                            var d_from_to_str = dist_pair_li[pair_n];
                                            if (typeof d_from_to_str == "string"){
                                                var d_from_to = d_from_to_str.split("-");
                                                var d_from = d_from_to[0];
                                                var d_to = d_from_to[1];
                                                var comp_dist_name="comp_dist_"+cd_id.toString();
                                               // o.addRepresentation( "label", {sele: Number(d_from), scale: 1.7, labelType: "serial"  } );
                                                o.addRepresentation( "distance", { atomPair: [[Number(d_from),Number(d_to)]] , colorValue: plot_colors[pair_n], colorScheme:"uniform", labelColor: plot_colors[pair_n] ,fontWeight: "normal" ,name : comp_dist_name } );
                                                //compDistsLi.push(comp_dist_name);
                                                cd_id +=1;
                                            }
                                        }
                                    }
                                }
                                if (int_res_s){
                                    var int_res_s_d =decodeURIComponent(int_res_s.replace(/\+/g, " "));
                                    var int_res_li = int_res_s_d.split(",");
                                    for (pos_info_n = 0; pos_info_n < int_res_li.length; pos_info_n++) {
                                        var pos_info_s = int_res_li[pos_info_n];
                                        var pos_info = pos_info_s.split("-");
                                        var pos = pos_info[0]+":"+pos_info[1];
                                        o.addRepresentation( "licorice", {  radius: "0.210", sele: pos , colorValue: "#8e74ff" } );
                                        var label = pos_info[2];
                                        var res_sele =  new NGL.Selection( pos );
                                        var label_pos="";
                                        o.structure.eachAtom(function(a){
                                            if (a.atomname == "CA"){
                                                label_pos=a.serial;
                                            }
                                        },res_sele)
                                        //o.addRepresentation("label", {labelType: "text", labelText:  { label_pos : label}});
                                    }

                                }
                                clickDists(o);
                                o.centerView("protein");
                          } );
                    }


        });

    </script>
</body>
</html>
