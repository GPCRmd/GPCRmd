<!DOCTYPE html>
<html lang="en">
<head>
    <title>NGL/MDsrv</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link rel="icon" href="mdsrv/webapp/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="mdsrv/webapp/css/font-awesome.min.css" />
    <link rel="stylesheet" href="mdsrv/webapp/css/main.css" />
    <link rel="subresource" href="mdsrv/webapp/css/light.css" />
    <link rel="subresource" href="mdsrv/webapp/css/dark.css" />
</head>
<body>
    <!-- NGL -->
    <script src="mdsrv/webapp/js/ngl.js"></script>

    <!-- UI -->
    <script src="mdsrv/webapp/js/lib/signals.min.js"></script>
    <script src="mdsrv/webapp/js/lib/tether.min.js"></script>
    <script src="mdsrv/webapp/js/lib/colorpicker.min.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.extra.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.ngl.js"></script>
    <script src="mdsrv/webapp/js/ui/ui.helper.js"></script>
    <script src="mdsrv/webapp/js/gui.js"></script>

    <!-- MDSRV -->
    <!--<script src="mdsrv/webapp/js/mdsrv.js"></script>-->

    <script>
        NGL.cssDirectory = "mdsrv/webapp/css/";
        NGL.MDsrvdocumentationUrl = "http://arose.github.io/mdsrv";
        NGL.documentationUrl = "http://arose.github.io/ngl/api/";

        // Datasources
        NGL.DatasourceRegistry.add(
            "file", new NGL.MdsrvDatasource( window.location.origin + "/mdsrv/" )
        );
        NGL.DatasourceRegistry.listing = NGL.DatasourceRegistry.get( "file" );
        NGL.DatasourceRegistry.trajectory = NGL.DatasourceRegistry.get( "file" );
        document.addEventListener( "DOMContentLoaded", function(){
            stage = new NGL.Stage();
            NGL.StageWidget( stage );
        stage.setParameters( { backgroundColor: "white" } );
        //stage.parameters.cameraType="orthographic";
//////////////

        function applySele (value) {
          if (value) {
            var edstruc=stage.getComponentsByName("my_comp").list[0];
            edstruc.autoView(value)
            var z = stage.viewer.camera.position.z
            var setval=99 - Math.abs(z / 10);
            stage.setFocus(setval)
            
            //$("#EDmapzoom")
          }
        }

        function listToMatrix(list, elementsPerSubArray) {
            var matrix = [], i, k;

            for (i = 0, k = -1; i < list.length; i++) {
                if (i % elementsPerSubArray === 0) {
                    k++;
                    matrix[k] = [];
                }

                matrix[k].push(list[i]);
            }

            return matrix;
        }


        function selWithinComponent(o,show,radius,ligSele){
            var radius=Number(radius);
            var sele=o.structure.getAtomSetWithinSelection( new NGL.Selection( ligSele ), radius );
            //var center=o.structure.atomCenter( new NGL.Selection( ligSele ) );
            var sele2 = o.structure.getAtomSetWithinGroup( sele );
            return([sele, sele2]);
        }

        function clickDists(o){
            var clicktrue = true;
            var atom1 , atom2 , res2 , res2, myrepr;
            var lbl_id=0;
            var dist_id=0;
            var clickedRep={};
            var lbl_name1, lbl_name2, dist_name;
            stage.signals.clicked.add( function( d ){
               // hovrep.repr.clear()
                if (clicktrue){
                    if (d && (d.atom)){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.index+") - ";
                        lbl_name1="label_"+lbl_id.toString();
                        lbl_id+=1;
                        myrepr = o.addRepresentation( "label", {
                            sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                            color: "#cccccc", scale: 1.7, labelType: "qualified name",fontWeight: "normal", name :lbl_name1  } );
                        atom1 = d.atom.index.toString();
                        /*if (! clickedRep[atom1]){
                            clickedRep[atom1]=[];
                        }
                        clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;*/
                        clicktrue = false;
                    }
                }else{
                    if (d && (d.atom)){
                        var info="["+d.atom.resname.toString()+"]"+d.atom.resno.toString()+":"+d.atom.chainname+"."+d.atom.atomname+" (atom ind: "+d.atom.index+") - ";
                        atom2 = d.atom.index.toString();
                        //res2 =d.atom.resno.toString()+"-"+d.atom.resno.toString()+':'+d.atom.chainname;
                        clicktrue = true;
                        if (atom1 != atom2){
                            lbl_name2="label_"+lbl_id.toString();
                            lbl_id+=1;
                            dist_name="dist_"+dist_id.toString();
                            dist_id+=1;
                            var add1=[lbl_name1, lbl_name2 , dist_name];
                            var add2 = [lbl_name1, lbl_name2 , dist_name];
                            if (! clickedRep[atom1]){
                                clickedRep[atom1]=[];
                            }
                            if (! clickedRep[atom2]){
                                clickedRep[atom2]=[];
                            }
                            for (an = 0; an < add1.length;an++) {
                                clickedRep[atom1][clickedRep[atom1].length]=add1[an];
                            }
                            for (an = 0; an < add2.length;an++) {
                                clickedRep[atom2][clickedRep[atom2].length]=add2[an];
                            }
                            o.addRepresentation( "label", {
                                sele: d.atom.resno.toString()+':'+d.atom.chainname+'.'+d.atom.atomname,
                                color: "#cccccc", scale: 1.7, labelType: "qualified name" ,fontWeight: "normal" , name:lbl_name2 } );
                            var atomPair = [[ Number(atom1), Number(atom2) ]];
                            o.addRepresentation( "distance", { atomPair: atomPair , colorValue: "#8bb0ff", colorScheme:"uniform", labelColor: "#7da8ff" ,fontWeight: "normal" , name : dist_name} );

                        } else {
                            if (atom1 in clickedRep){
                                var toRv=clickedRep[atom1];
                                for (rvN = 0; rvN < toRv.length;rvN++) {
                                    var repName=toRv[rvN];
                                    stage.getRepresentationsByName(repName).list[0].repr.clear();
                                }
                                stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                                delete clickedRep[atom1];
                            } else {
                                if (! clickedRep[atom1]){
                                    clickedRep[atom1]=[];
                                }
                                clickedRep[atom1][clickedRep[atom1].length]=lbl_name1;
                            }
                        }
                    } else {
                        clicktrue = true;
                        stage.getRepresentationsByName(lbl_name1).list[0].repr.clear();
                        //lbl_id -=1;
                    }
                }
            } );
        }


        function res_to_atom(o,d_info){
            var d_all=d_info.split(":");
            var res=d_all[0];
            var chain=d_all[1];
            var atmn=d_all[2];
            var res_sele =  new NGL.Selection( res+":"+chain );
            //console.log(res_sele)
            //console.log(atmn);
            var mypos="";
            o.structure.eachAtom(function(a){
                if (a.atomname == atmn){
                    mypos=a.index;
                }
            },res_sele);
            //console.log(mypos);
            //console.log("------");
            return(mypos)
        }
        


        function fromChainLiToNGL(nonGPCR){ 
            var nonGPCR_li=nonGPCR.split(",");
            var nonGPCR_mod="";
            for (chain_n = 0; chain_n < nonGPCR_li.length; chain_n++) {
                nonGPCR_mod+=":"+nonGPCR_li[chain_n]+" , ";
            }
            nonGPCR_mod=nonGPCR_mod.slice(0,-3);
            return nonGPCR_mod;
        }
        
        function modTooltip(){
            // create new tooltip
            var tooltip = document.createElement('div')
            Object.assign(tooltip.style, {
              display: 'none',
              position: 'fixed',
              zIndex: 10,
              pointerEvents: 'none',
              backgroundColor: 'rgba( 0, 0, 0, 0.6 )',
              color: 'lightgrey',
              padding: '8px',
              fontFamily: 'sans-serif'
            })
            document.body.appendChild(tooltip)
            // remove default hoverPick mouse action
            stage.mouseControls.remove('hoverPick')
            // listen to `hovered` signal to move tooltip around and change its text
            stage.signals.hovered.add( function( d ){
                if (d && (d.atom)){
                    var hatom = d.atom;
                    var info="["+hatom.resname.toString()+"]"+hatom.resno.toString()+":"+hatom.chainname+"."+hatom.atomname+" (atom ind: "+hatom.index+")";
                    var mp = d.mouse.position
                    tooltip.innerText = info;
                    tooltip.style.bottom = window.innerHeight - mp.y + 3 + 'px'
                    tooltip.style.left = mp.x + 3 + 'px'
                    tooltip.style.display = 'block'
                } else {
                    tooltip.style.display = 'none';
                }
            });
        }        
///////////////
            var struc = s_path =t_path =traj = layers_pre = cons_pos = pdA=pdb=pdC=pdF=cp=dist_within=cons_comp=nonGPCR= int_res_s = int_res_s_ch=dist_groups_s= receptorsel = bs_info = projection =fpsegStr="";
            var struc = NGL.getQuery( "struc" );
            var s_path = "file://_DB/";
            var t_path = "file://_DB/";
            var traj = NGL.getQuery( "traj" );
            var receptorsel = NGL.getQuery("rs");
            var layers_pre=NGL.getQuery("ly");
            var  cons_pos= NGL.getQuery("pd");
            var  pdA= NGL.getQuery("la");
            var  pdB= NGL.getQuery("lb");
            var  pdC= NGL.getQuery("lc");
            var  pdF= NGL.getQuery("lf");
            var  cp= NGL.getQuery("cp");
            var  dist_within= NGL.getQuery("wtn");
            var  dist_within_li_fin=[];
            var  cons_comp=NGL.getQuery("cc");
            var  nonGPCR= NGL.getQuery("ng");
            var int_res_s=NGL.getQuery("in");
            var int_res_s_ch=NGL.getQuery("ih");
            var dist_groups_s=NGL.getQuery("dc");
            var bs_info = NGL.getQuery("bs");
            var hbonds=NGL.getQuery("hb");
            var cbonds=hbonds;
            var atomssb=NGL.getQuery("sb");
            var catomssb=atomssb;
            var atomshb_inter=NGL.getQuery("ib");
            var catomshb_inter=atomshb_inter;
            var all_resids=NGL.getQuery("ar");
            var call_resids=all_resids
            var all_resids_sb=NGL.getQuery("as");
            var call_resids_sb=all_resids_sb;
            var all_resids_inter=NGL.getQuery("ai");
            var projection=NGL.getQuery("pj");
            var fpsegStr=NGL.getQuery("fp");
            var showH=NGL.getQuery("ha");
            var spin = NGL.getQuery("sp");
            var intType = NGL.getQuery("ti");
            var trajStep = NGL.getQuery("ts");
            var trajTimeOut = NGL.getQuery("tt");
            //ED map
            var ed_sel=NGL.getQuery("eds");
            var ed_display=NGL.getQuery("edd");
            var ed_color=NGL.getQuery("edc");
            var ed_iso=NGL.getQuery("edi");
            var ed_zoom=NGL.getQuery("edz");
            var r_angl=NGL.getQuery("edr");
            var transl=NGL.getQuery("edt");
            var pdbid=NGL.getQuery("pdb");

            
            var sel_li=[];
            var sel_prot=false;

            if (fpsegStr){
                fpsegStr=fpsegStr.replace("+"," or ");
                var fpsegli=fpsegStr.split(",");
                var fpcolors=[];
                var helix_colors =["#78C5D5","#5FB0BF","#459BA8","#5FAF88","#79C268","#9FCD58","#C5D747","#DDD742","#F5D63D","#F3B138","#F18C32","#ED7A6A","#E868A1","#D466A4","#BF63A6"];
                for (segN=0; segN<fpsegli.length ;segN++ ){
                    var segsel=fpsegli[segN];
                    if (segsel){
                        fpcolors.push([helix_colors[segN] , "protein and ("+ segsel +")" ]);
                    }
                }
                var FPscheme = NGL.ColormakerRegistry.addSelectionScheme( fpcolors, "FPscheme" );
                
            }

             /*var va = "test";             
             for (v in va){ 
                console.log(v);
                console.log(va[v]);
             };*/
                    if (struc) {

                        stage.loadFile( s_path + struc, {sele:"*", visible: true}  ).then( function( o ){  
                                o.setName("my_comp");
                                
            
                                /*if (showH == "f"){
                                    o.setSelection("not _h");
                                }*/
                                
                                if (receptorsel){
                                    var receptorsel_d=decodeURIComponent(receptorsel.replace(/\+/g, " "));
                                    if (bs_info){
                                        o.addRepresentation( "cartoon", { colorScheme:"uniform", colorValue: "#FFFFFF",  sele: receptorsel_d, name: "Receptor" } );
                                    } else {                                        
                                        if (fpsegStr){
                                            o.addRepresentation( "cartoon", { colorScheme: FPscheme, sele: receptorsel_d, name: "Receptor"} );
                                        } else {
                                            o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: receptorsel_d, name: "Receptor"} );
                                        }
                                    }
                                    sel_prot=true;
  
                                }

                                if (nonGPCR){
                                    var nonGPCR_d=decodeURIComponent(nonGPCR.replace(/\+/g, " "));
                                    var nonGPCR_l=nonGPCR_d.split("-");
                                    for (ng = 0; ng < nonGPCR_l.length; ng++){
                                        chains_s = nonGPCR_l[ng];
                                        nonGPCR_sel = "protein and ("+ fromChainLiToNGL(chains_s) + ")";
                                        o.addRepresentation( "cartoon", { colorScheme: "chainid", colorScale:"Set3",  sele: nonGPCR_sel } );
                                    }
                                    sel_prot=true;
                                }             
       
                                if (cp){
                                    var all_cp="";
                                    cp_li = decodeURIComponent(cp.replace(/\+/g, " ")).split(",");
                                    var comptype_dict={
                                        "lg":[],
                                        "lp":[],
                                        "i":[],
                                        "w":[],
                                        "o":[]
                                    }
                                    for (comp = 0; comp < cp_li.length; comp++){
                                        var mycompinfo=cp_li[comp].split("-");
                                        var mycomp=mycompinfo[0];
                                        var mycompType=mycompinfo[1];
                                        if (! isNaN(parseInt(mycomp))){
                                            mycomp="["+mycomp+"]";
                                        }
                                        if (mycomp.indexOf(" and ") > 0){
                                            mycomp="("+mycomp+")";
                                        }
                                        all_cp += (mycomp + " or ");
                                        sel_li.push(mycomp);
                                        comptype_dict[mycompType].push(mycomp);
                                    }
                                    all_cp = all_cp.slice(0, -3);
                                    //o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: all_cp, radius: 0.30 } );
                                    for (comp_key in comptype_dict){
                                        var comptype_sel=comptype_dict[comp_key];
                                        if (comptype_sel.length > 0){
                                            var comp_sel=comptype_sel.join(" or ");
                                            if (comp_key == "lg"){
                                                if (bs_info){
                                                    o.addRepresentation( "spacefill", { colorValue: "#f8d5b1", colorScheme: "element", visible: true, sele: comp_sel } );
                                                } else {
                                                    o.addRepresentation( "spacefill", { colorScheme: "element", visible: true, sele: comp_sel } );
                                                }
                                            }
                                            else if (comp_key == "i"){
                                                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel, radius: 0.30 , colorValue: "#aeff42" , name: "Ions"} );
                                            }
                                            else if (comp_key == "w") {
                                                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel, radius: 0.30, name: "Water" } );
                                            }
                                            else if ("lp") {
                                                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel , name: "Lipids"} );
                                            } else {
                                                o.addRepresentation( "licorice", { colorScheme: "element", visible: true, sele: comp_sel} );
                                            }
                                        }
                                    }
                                }
                                if (cons_pos == "y"){
                                    var pre_pd_all=[pdA,pdB,pdC,pdF];
                                    var pd_all = [];
                                    for (elN = 0; elN < pre_pd_all.length; elN++) {
                                        var class_poss=pre_pd_all[elN];
                                        if (class_poss){
                                            pd_all[pd_all.length]=class_poss;
                                        }
                                    }
                                    var color_list = ["#00d8ff","#ff8500","#ccff00","#ff00d2"]; // A, B, C, F
                                    for (ind = 0; ind < pd_all.length; ind++) {
                                         class_li=decodeURIComponent(pd_all[ind].replace(/\+/g, " "));
                                         if (class_li){
                                             var cons_pos_ok = class_li.replace(/,/g," OR ");
                                             o.addRepresentation( "licorice", {  colorValue: color_list[ind], radius: "0.210", sele:"protein and ("+ cons_pos_ok +")"  } ); 
                                         }
                                     } 
                                     sel_prot=true;
                                 }  
//////////////!                                    
                                 if (layers_pre){
                                     var layers_s = decodeURIComponent(layers_pre.replace(/\+/g, " "));
                                     var layers_li=layers_s.split("-;;-");
                                     for (lN = 0; lN < layers_li.length; lN++) {
                                         var layer_all = layers_li[lN].split("-,,-");
                                         var sel = layer_all[0];
                                         var rep = layer_all[1];
                                         var color = layer_all[2];
                                         var scheme = layer_all[3];
                                         var selectionTest = new NGL.Selection( sel ).selection[ "error" ];
                                         if (!selectionTest){
                                             if (rep == "ball stick"){
                                                rep="ball+stick";
                                             }
                                             if (scheme=="FPscheme"){
                                                 o.addRepresentation( rep, { /*radius: "0.210" ,*/ sele: sel , colorScheme:FPscheme } ); 
                                             } else {
                                                 o.addRepresentation( rep, {  colorValue: color, /*radius: "0.210" ,*/ sele: sel , colorScheme: scheme  } ); 
                                             }
                                             sel_li.push("("+sel+")");
                                         }
                                     }
                                 }
                                    
/////////////////!
                                if( traj ) {
                                    var traj_str = decodeURIComponent(traj.replace(/\+/g, " "));
                                    var traj_li=traj_str.split(",");
                                    var setIntType="";
                                    if (intType){
                                        if (intType == "s"){
                                            setIntType="spline";
                                        } else {
                                            setIntType="linear";
                                        }
                                    }
                                    var setTrajStep=3;
                                    if (trajStep){setTrajStep=Number(trajStep)}
                                    var setTrajTimeOut=50;
                                    if (trajTimeOut){setTrajTimeOut=Number(trajTimeOut)}
                                    
                                    for (t = 0; t < traj_li.length; t++) {
                                        o.addTrajectory( t_path + traj_li[t] , {defaultInterpolateType:setIntType , defaultStep:setTrajStep , defaultTimeout:setTrajTimeOut } );
                                    }
                                }

                                if (cbonds){
                                    var cbonds2=decodeURIComponent(cbonds.replace(/\+/g, " "));
                                    var all_resids=decodeURIComponent(call_resids.replace(/\+/g, " ")).split(',');
                                    cbonds2=cbonds2.split(',');
                                    var resids= 'protein and';
                                    for (i=0;i<cbonds2.length;i++){
                                        cbonds2[i]=Number(cbonds2[i]);
                                    }

                                    for (i=0;i<all_resids.length;i++){
                                        all_resids[i]=Number(all_resids[i]);
                                    }
                                    cbonds2=listToMatrix(cbonds2,2);
                                    resids=resids+' ('+all_resids.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                                    //cbonds2=[[Number(cbonds2[0]),Number(cbonds2[1])]];
                                    o.addRepresentation( "distance", { atomPair: cbonds2 , colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                                    o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
                                    sel_prot=true;
                                }

                                if (catomssb){
                                    all_resids_sb=decodeURIComponent(call_resids_sb.replace(/\+/g, " ")).split(',');
                                    var atomssb2=decodeURIComponent(catomssb.replace(/\+/g, " "));
                                    atomssb2=atomssb2.split(',');
                                    for (i=0;i<atomssb2.length;i++){
                                        atomssb2[i]=Number(atomssb2[i]);
                                    }

                                    for (i=0;i<all_resids_sb.length;i++){
                                        all_resids_sb[i]=Number(all_resids_sb[i]);
                                    }
                                    atomssb2=listToMatrix(atomssb2,2);
                                    var resids= 'protein and';
                                    resids=resids+' ('+all_resids_sb.join(' or ') + ' )'; //not only proteins! lipids also have SB
                                    //cbonds2=[[Number(cbonds2[0]),Number(cbonds2[1])]];
                                    o.addRepresentation( "distance", { atomPair:  atomssb2 , colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                                    o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
                                    sel_prot=true;
                                }
                                if (catomshb_inter){
                                    all_resids_inter=decodeURIComponent(all_resids_inter.replace(/\+/g, " ")).split(',');
                                    var atomssb_inter2=decodeURIComponent(catomshb_inter.replace(/\+/g, " "));
                                    atomssb_inter2=atomssb_inter2.split(',');
                                    for (i=0;i<atomssb_inter2.length;i++){
                                        atomssb_inter2[i]=Number(atomssb_inter2[i]);
                                    }

                                    for (i=0;i<all_resids_inter.length;i++){
                                        all_resids_inter[i]=all_resids_inter[i];
                                    }
                                    atomssb_inter2=listToMatrix( atomssb_inter2,2);
                                    var resids= 'not water and';
                                    resids=resids+' ('+all_resids_inter.join(' or ') + ' )'; //not only proteins! lipids also have hbonds
                                    o.addRepresentation( "distance", { atomPair:  atomssb_inter2, colorValue: "#e67300", colorScheme:"uniform", labelColor: "#994499" ,fontWeight: "normal" ,name : 'Hydrogen Bond' } );
                                    o.addRepresentation( "licorice", {  radius: "0.210", sele: resids , colorValue: "#8e74ff" } );
                                    sel_li.push(resids);
                                }


                                if (bs_info){
                                    var bs_info_li=bs_info.split("-");
                                    var recept =bs_info_li[0];
                                    var ligli=bs_info_li[1].split(",");
                                    var bsnum =0;
                                    for (liN=0; liN < ligli.length ; liN++){
                                        var lig = ligli[liN];
                                        if (! isNaN(parseInt(lig))){
                                            lig="["+lig+"]";
                                        }
                                        var result = selWithinComponent(o,recept , "2.5" ,lig );
                                        var sele = result[0];
                                        var sele2 = result[1];
                                        BSRepName="BS"+bsnum.toString();
                                        //o.addRepresentation( "licorice", { colorValue:"#6fffc9", radius: "0.210", sele: recept+" and "+ sele.toSeleString(), name:BSRepName } );
                                        //o.addRepresentation( "licorice", { colorValue:"#6fffc9",opacity:0.5 , radius: "0.210", sele: recept+" and "+ sele2.toSeleString() , name:BSRepName+"_2"} );
                                        //o.addRepresentation( "licorice", { colorValue:"#6fffc9",opacity:0.5 , radius: "0.210", sele: recept+" and "+ sele2.toSeleString() , name:BSRepName+"_2"} );
                                        o.addRepresentation( "licorice", { colorValue:"#b6a476", radius: "0.210", sele: recept+" and "+ sele2.toSeleString() , name:BSRepName+"_2"} );
                                        bsnum+=1;
                                    }
                                    sel_prot=true;
                                    
                                }
                                
                                if (dist_within){
                                    var dist_within_li = decodeURIComponent(dist_within.replace(/\+/g, " ")).split(",");
                                    for (wth_n = 0; wth_n < dist_within_li.length; wth_n++) {
                                        var dist_comp=  dist_within_li[wth_n].split("-");
                                        var ligSele=dist_comp[2];
                                        var show =dist_comp[0];
                                        if (! isNaN(parseInt(show))){
                                            show="["+show+"]";
                                        }
                                        if (! isNaN(parseInt(ligSele))){
                                            ligSele="["+ligSele+"]";
                                        }
                                        var selectionTest = new NGL.Selection( ligSele ).selection[ "error" ];
                                        if (!selectionTest){
                                            var WthRepName="sel"+ligSele;
                                            var restriction="";
                                            var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                                            if (show_sup != "NONE"){
                                                o.addRepresentation( "licorice", { colorValue:"#dcffae", radius: "0.210", sele: ligSele, name:WthRepName+"0" } );
                                                restriction="not ("+ligSele+") and ";
                                            }               
                                            var result=selWithinComponent(o,show,dist_comp[1],ligSele);
                                            var sele = result[0];
                                            var sele2 = result[1];
                                            o.addRepresentation( "licorice", { colorValue:"#ff7575", radius: "0.210", sele: show+" and "+restriction + sele.toSeleString(), name:WthRepName } );
                                            o.addRepresentation( "licorice", { colorValue:"#ff7575",opacity:0.5 , radius: "0.210", sele: show+" and "+restriction + sele2.toSeleString() , name:WthRepName+"2"} );
                                            if (show =="protein"){
                                                sel_prot=true;
                                            } else {
                                                sel_li.push(show);
                                            }  
                                            dist_within_li_fin.push(dist_within_li[wth_n])
                                        }                                
                                    }
                                }
                                if (dist_groups_s){
                                    dist_groups_s_deco=decodeURIComponent(dist_groups_s.replace(/\+/g, " "));
                                    dist_groups_li=dist_groups_s_deco.split(",");
                                    var cd_id=0;
                                    var plot_colors=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"]; 
                                    for (distgN = 0; distgN < dist_groups_li.length; distgN++) {
                                        var dist_group=dist_groups_li[distgN];
                                        var dist_pair_li=dist_group.split("a");
                                        for (pair_n = 0; pair_n < dist_pair_li.length; pair_n++) {
                                            var d_from_to_str = dist_pair_li[pair_n];
                                            if (typeof d_from_to_str == "string"){
                                                var d_from_to = d_from_to_str.split("-");
                                                var d_from = d_from_to[0];
                                                var d_to = d_from_to[1];
                                                if (d_from_to_str.indexOf(":") > -1){
                                                    d_from=res_to_atom(o,d_from);
                                                    d_to=res_to_atom(o,d_to);
                                                } 
                                                var comp_dist_name="comp_dist_"+cd_id.toString();
                                               // o.addRepresentation( "label", {sele: Number(d_from), scale: 1.7, labelType: "serial"  } );
                                                o.addRepresentation( "distance", { atomPair: [[Number(d_from),Number(d_to)]] , colorValue: plot_colors[cd_id], colorScheme:"uniform", labelColor: plot_colors[cd_id] ,fontWeight: "normal" ,name : comp_dist_name } );
                                                //compDistsLi.push(comp_dist_name);
                                                cd_id +=1;
                                            }
                                        }
                                    }
                                }
                                if (int_res_s){
                                    var int_res_s_d =decodeURIComponent(int_res_s.replace(/\+/g, " "));
                                    var int_res_li = int_res_s_d.split(",");
                                    var final_sele=[];
                                    for (pos_info_n = 0; pos_info_n < int_res_li.length; pos_info_n++) {
                                        var pos_info_s = int_res_li[pos_info_n];
                                        var pos_info = pos_info_s.split("-");
                                        var pos = pos_info[0]+":"+pos_info[1];
                                        final_sele.push(pos);
                                        var label = pos_info[2];
                                        var res_sele =  new NGL.Selection( pos );
                                        var label_pos="";
                                        o.structure.eachAtom(function(a){
                                            if (a.atomname == "CA"){
                                                label_pos=a.index;
                                            }
                                        },res_sele);
                                        //o.addRepresentation("label", {labelType: "text", labelText:  { label_pos : label}});
                                    }
                                    final_sele=final_sele.join(" , ");
                                    o.addRepresentation( "licorice", {  radius: "0.210", sele: final_sele , colorValue: "#8e74ff" } );
                                    sel_prot=true;

                                }
                                
                                if (int_res_s_ch){
                                    var int_res_s_d_ch =decodeURIComponent(int_res_s_ch.replace(/\+/g, " "));
                                    var int_res_li_ch = int_res_s_d_ch.split(",");
                                    var final_sele=[];
                                    for (pos_info_n = 0; pos_info_n < int_res_li_ch.length; pos_info_n++) {
                                        var pos_info_s = int_res_li_ch[pos_info_n];
                                        var pos_info = pos_info_s.split("-");
                                        var pos = pos_info[0]+":"+pos_info[1];
                                        final_sele.push(pos);
                                        var label = pos_info[2];
                                        var res_sele =  new NGL.Selection( pos );
                                        var label_pos="";
                                        o.structure.eachAtom(function(a){
                                            if (a.atomname == "CA"){
                                                label_pos=a.index;
                                            }
                                        },res_sele);
                                        //o.addRepresentation("label", {labelType: "text", labelText:  { label_pos : label}});
                                    }
                                    final_sele=final_sele.join(" , ");
                                    o.addRepresentation( "licorice", {  radius: "0.300", sele: final_sele , colorValue: "#f2e14e"/*"#461bff"*/ } );
                                    sel_prot=true;
                                }
                                
                                if (sel_prot){
                                    sel_li.push("protein");
                                }
                                var sel_s = sel_li.join(" or ");

                                if (showH == "f"){
                                    sel_s = "not _h and ("+sel_s+")";
                                }
                                o.setSelection(sel_s);
                                
                                
                                if (projection){
                                    stage.setParameters( { cameraType: "orthographic"} );
                                }
                                
                                clickDists(o);
                                o.autoView();
                                
                                if (spin){ stage.setSpin( [ 0, 1, 0 ], 0.01 ) }; 
                                
                                // When frame changes:
                                var trajCompT=stage.getComponentsByName("my_comp").list[0].trajList;
                                for (trajN = 0; trajN < trajCompT.length; trajN++) {
                                    trajCompT[trajN].signals.frameChanged.add(function(){
                                        if (bs_info){
                                            var bs_info_li=bs_info.split("-");
                                            var recept =bs_info_li[0];
                                            var ligli=bs_info_li[1].split(",");
                                            var bsnum =0;
                                            for (liN=0; liN < ligli.length ; liN++){
                                                var lig = ligli[liN];
                                                if (! isNaN(parseInt(lig))){
                                                    lig="["+lig+"]";
                                                }
                                                var result = selWithinComponent(o,recept , "2.5" ,lig );
                                                var sele = result[0];
                                                var sele2 = result[1];
                                                BSRepName="BS"+bsnum.toString();
                                              //  stage.getRepresentationsByName(BSRepName).setSelection(recept+" and "+sele.toSeleString());
                                                stage.getRepresentationsByName(BSRepName+"_2").setSelection(recept+" and "+ sele2.toSeleString());
                                                bsnum+=1;
                                            }
                                            
                                        }
                                        if (dist_within_li_fin.length > 0){
                                            for (wth_n = 0; wth_n < dist_within_li.length; wth_n++) {
                                                var dist_comp=  dist_within_li[wth_n].split("-");
                                                var show =dist_comp[0];
                                                var ligSele=dist_comp[2];
                                                if (! isNaN(parseInt(show))){
                                                    show="["+show+"]";
                                                }
                                                if (! isNaN(parseInt(ligSele))){
                                                    ligSele="["+ligSele+"]";
                                                }
                                                var WthRepName="sel"+ligSele;
                                                var restriction="";
                                                var show_sup=o.structure.getAtomSetWithinGroup( new NGL.Selection(show+" and "+ ligSele )).toSeleString();
                                                if (show_sup != "NONE"){
                                                    restriction="not ("+ligSele+") and ";
                                                }               
                                                var result=selWithinComponent(o,show,dist_comp[1],ligSele);
                                                var sele = result[0];
                                                var sele2 = result[1];
                                                stage.getRepresentationsByName(WthRepName).setSelection(show+" and "+restriction + sele.toSeleString());
                                                stage.getRepresentationsByName(WthRepName+"2").setSelection(show+" and "+restriction + sele2.toSeleString());
                                            }
                                        }
                                    });
                                }
                                // ED map
                                if (ed_sel && pdbid && r_angl && transl){
                                    ed_sel=decodeURIComponent(ed_sel.replace(/\+/g, " "));
                                    var ed2fofc_vis, edfofc_vis =true;
                                    if (ed_display){
                                        if (ed_display=="2"){
                                            edfofc_vis=false;
                                        } else if (ed_display=="f"){
                                            ed2fofc_vis=false;
                                        }
                                    } 
                                    var ed2fofc_col="#87ceeb";
                                    var edfofcPos_col="#3cb371";
                                    var edfofcNeg_col="#ff6347";
                                    if (ed_color){
                                        ed_color=decodeURIComponent(ed_color.replace(/\+/g, " "));
                                        var ed_color_l=ed_color.split(";");
                                        if (ed_color_l[0]){
                                            ed2fofc_col=ed_color_l[0];
                                        }
                                        if (ed_color_l[2]){
                                            edfofcPos_col=ed_color_l[2];
                                        }
                                        if (ed_color_l[3]){
                                            edfofcNeg_col=ed_color_l[3];
                                        }
                                    } 
                                    var ed2fofc_iso=1.5;
                                    var edfofc_iso=3;
                                    if (ed_iso){
                                        ed_iso_l=ed_iso.split(";");
                                        ed2fofc_iso=Number(ed_iso_l[0]);
                                        edfofc_iso=Number(ed_iso_l[1]);
                                    }
                                    r_angl=decodeURIComponent(r_angl.replace(/\+/g, " "));
                                    var r_angl_l=r_angl.split(";");
                                    for (eN = 0; eN < r_angl_l.length;eN++) {
                                        r_angl_l[eN]=Number(r_angl_l[eN])
                                    }
                                    transl=decodeURIComponent(transl.replace(/\+/g, " "));
                                    var transl_l=transl.split(";");
                                    for (eN = 0; eN < transl_l.length;eN++) {
                                        transl_l[eN]=Number(transl_l[eN])
                                    }
                                    ed_zoom=Number(ed_zoom);
                                    stage.setFocus(ed_zoom);

                                    var edmapUrl = "https://edmaps.rcsb.org/maps/";
                                    stage.loadFile(edmapUrl + pdbid.toLowerCase() + "_2fofc.dsn6", {visible: ed2fofc_vis}).then(function(edc){
                                        edc.setName("2fofc");
                                        edc.setRotation( r_angl_l);
                                        edc.setPosition(transl_l);

                                        edc.addRepresentation("surface", {
                                          name:"2fo-fc",
                                          contour: true,
                                          colorValue: ed2fofc_col,
                                          isolevel: ed2fofc_iso,
                                          flatShaded: false,
                                          opacity: 1,
                                          metalness: 0,
                                          wireframe: false


                                        })
                                    })
                                    stage.loadFile(edmapUrl + pdbid.toLowerCase() + "_fofc.dsn6", {visible: edfofc_vis}).then(function(edc){
                                        edc.setName("fofc");
                                        //edc.setRotation( r_angl)
                                        //edc.setPosition(transl)

                                        edc.setRotation( r_angl_l);
                                        edc.setPosition(transl_l);
                                        edc.addRepresentation("surface", {
                                          name:"fo-fc Positive",
                                          colorValue: edfofcPos_col,
                                          isolevel: edfofc_iso,
                                          contour: true,
                                          flatShaded: false,
                                          opacity: 1,
                                          metalness: 0,
                                          wireframe: false
                                        })
                                        edc.addRepresentation("surface", {
                                          name:"fo-fc Negative",
                                          colorValue: edfofcNeg_col,
                                          isolevel: edfofc_iso,
                                          negateIsolevel: true,
                                          contour: true,
                                          flatShaded: false,
                                          opacity: 1,
                                          metalness: 0,
                                          wireframe: false

                                        })
                                    })
                                    applySele(ed_sel)
                                }
                           } );
                    }






        });

    </script>
</body>
</html>
