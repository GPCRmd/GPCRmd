<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>Flare-plot</title>
  <link rel="stylesheet" type="text/css" href="../stylesheets/normalize.css" media="screen">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="../stylesheets/gpcr_demo.css" media="screen">
  <style type="text/css">

  </style>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="./parse.js"></script>
  <script type="text/javascript" src="pv.min.js"></script>
  <script type="text/javascript" src="./main_test.js"></script>
</head>
<body>

<section class="main-head">
  <h1 class="main-title">Flare-plot</h1>
  <p class="main-description">
    Here is a network of molecular interactions for 30000 frames from an MD
    simulation of the pain-related mu-opioid receptor. Click a label on the
    circle and the structure on the right will highlight the dynamic interactions.
  </p>
</section>

<section class="main-content">
  <div class="evoBundleChart">
    <div id="evobundlediv">

    </div>
    <!--<div class="tensionControl">Tension: <input style="" type="range" min="0" max="100" value="85" /></div>-->
    <div id="evocontrols">
      <span  id="controls"></span>
      <input id="timeRange" type="range" min="0" max="1000" value="0" />
      <span id="timeLabel">0</span>
    </div>

    <div class="buttonBox">
      <button class="summaryButton" type="button">
        Summarize
      </button>
      <button class="sortButton fr" type="button">
        Sort clustered tracks
      </button>
      <button class="sortWithoutButton fr" type="button">
        Sort tracks
      </button>
      <button class="trackButton fr" type="button">
        Tracks
      </button>
      <button class="switchButton fr" type="button">
        Switch cluster
      </button>
    </div>

  </div>

  <div id="pviewer" ></div>

</section>
</body>
</html>
<script type='text/javascript'>
  // override the default options with something less restrictive.
  var options = {
    width: 500,
    height: 800,
    antialias: true,
    quality : 'medium'
  };
  // insert the viewer under the Dom element with id 'gl'.
  var viewer = pv.Viewer(document.getElementById('pviewer'), options);
  var struc;


  function loadMOR() {
    // asynchronously load the PDB file for the dengue methyl transferase
    // from the server and display it in the viewer.
    //pv.io.fetchPdb('../pdb_files/tmp_dyn_0_33.pdb', function(structure) { //[!]Hardcoded    
    pv.io.fetchPdb('../pdb_files/tmp_dyn_0_27.pdb', function(structure) { //[!]Hardcoded
      struc = structure;
      
      //var test=structure.select({rnumRange : [38 , 70]});//[!]Add residue ranges of each chain
      //viewer.trace('protein', test,  { color: pv.color.uniform('red') });     
      
      viewer.trace('protein', structure, { color : color.ssSuccession() });
      var ligands = structure.select({ rnames : ['CLZ','YCM', '4VO', 'OLC', 'CLR', 'P04', 'P6G'] });//[!]Hardcoded
      viewer.ballsAndSticks('ligands', ligands);
      viewer.fitTo(structure);
      //var rotation = pv.viewpoint.principalAxes(viewer.all()[0]);
      //viewer.setRotation(rotation);
      viewer.setRotation([1,0,0,0,0,1,0,-1,0]);

      //viewer.autoZoom();

      //var randAtom = structure.atom('A.95.CA');
      //var options = { fontSize : 16, fontColor: '#aee', backgroundAlpha:0.8  };
      //var acount = 0;
      //struc.eachAtom(function(a){
      //  if(a.name()!="CA") return;
      //  viewer.label('label'+acount, a.residue().num(), a.pos(), options);
      //  acount++;
      //});

      //var cm = viewer.customMesh('interactions');
      //cm.addTube( structure.atom('A.95.CA').pos(), structure.atom('A.116.CA').pos(), 0.5, {cap:false, color:'black'});

      //viewer.rm('interaction');
      //cm.addTube( structure.atom('A.95.CA').pos(), structure.atom('A.116.CA').pos(), 0.5, {cap:false, color:'black'});


    });
  }
  // load the methyl transferase once the DOM has finished loading. That's
  // the earliest point the WebGL context is available.
  document.addEventListener('DOMContentLoaded', loadMOR);

    //d3.text("../json_files/tmp_trj_0_33_DOmt.json", function(rawtext){
  d3.text("../json_files/tmp_trj_0_27_DOwt.json", function(rawtext){
  //d3.text("../json_files/tmp_trj_0_27_opioidDEMOgpcrGNUM.json", function(rawtext){//[!]Hardcoded
    //load_dataset(rawtext);
    create_bundle(rawtext);
  });

    //[!] Added code to obtain nameToResiTable depending of the clustering specifid at main js.
    
    //Tomek din:
    //var nameToResiTable={'6x35': ['P.261', ''], '2x58': ['P.103', ''], '23x52': ['P.116', ''], '6x29': ['P.255', ''], '2x42': ['P.87', ''], '1x53': ['P.70', ''], '6x39': ['P.265', ''], '7x28': ['P.294', ''], '2x53': ['P.98', ''], '1x43': ['P.60', ''], '23x49': ['P.113', ''], '5x44': ['P.218', ''], '45x50': ['P.198', ''], '34x52': ['P.155', ''], '6x28': ['P.254', ''], '6x38': ['P.264', ''], '3x21': ['P.117', ''], '5x55': ['P.230', ''], '1x51': ['P.68', ''], '6x30': ['P.256', ''], '3x41': ['P.137', ''], '4x54': ['P.177', ''], '6x43': ['P.269', ''], '34x50': ['P.153', ''], '5x65': ['P.240', ''], '3x38': ['P.134', ''], '6x34': ['P.260', ''], '4x62': ['P.185', ''], '5x54': ['P.229', ''], '2x37': ['P.82', ''], '2x59': ['P.104', ''], '7x56': ['P.321', ''], '7x47': ['P.312', ''], '1x44': ['P.61', ''], '4x56': ['P.179', ''], '4x44': ['P.167', ''], '7x27': ['P.293', ''], '2x38': ['P.83', ''], '7x40': ['P.306', ''], '5x37': ['P.211', ''], '6x59': ['P.285', ''], '1x31': ['P.48', ''], '1x59': ['P.76', ''], '7x39': ['P.305', ''], '6x56': ['P.282', ''], '6x48': ['P.274', ''], '2x51': ['P.96', ''], '5x32': ['P.206', ''], '2x49': ['P.94', ''], '5x39': ['P.213', ''], '1x58': ['P.75', ''], '1x29': ['P.46', ''], '8x49': ['P.324', ''], '2x56': ['P.101', ''], '3x54': ['P.150', ''], '7x32': ['P.298', ''], '3x53': ['P.149', ''], '3x22': ['P.118', ''], '1x54': ['P.71', ''], '8x56': ['P.331', ''], '2x54': ['P.99', ''], '3x32': ['P.128', ''], '4x61': ['P.184', ''], '1x56': ['P.73', ''], '3x30': ['P.126', ''], '6x31': ['P.257', ''], '2x50': ['P.95', ''], '5x64': ['P.239', ''], '5x50': ['P.225', ''], '8x55': ['P.330', ''], '3x23': ['P.119', ''], '5x63': ['P.238', ''], '8x50': ['P.325', ''], '1x28': ['P.45', ''], '1x39': ['P.56', ''], '1x34': ['P.51', ''], '5x57': ['P.232', ''], '34x51': ['P.154', ''], '1x55': ['P.72', ''], '2x63': ['P.108', ''], '4x57': ['P.180', ''], '1x30': ['P.47', ''], '7x46': ['P.311', ''], '2x41': ['P.86', ''], '1x25': ['P.42', ''], '34x57': ['P.160', ''], '5x62': ['P.237', ''], '5x42': ['P.216', ''], '4x64': ['P.187', ''], '5x48': ['P.223', ''], '3x36': ['P.132', ''], '7x54': ['P.319', ''], '1x22': ['P.39', ''], '2x65': ['P.110', ''], '8x59': ['P.334', ''], '23x50': ['P.114', ''], '4x60': ['P.183', ''], '6x58': ['P.284', ''], '5x43': ['P.217', ''], '8x54': ['P.329', ''], '3x55': ['P.151', ''], '5x66': ['P.241', ''], '7x55': ['P.320', ''], '4x45': ['P.168', ''], '1x40': ['P.57', ''], '6x54': ['P.280', ''], '3x33': ['P.129', ''], '6x24': ['P.250', ''], '7x49': ['P.314', ''], '4x42': ['P.165', ''], '7x38': ['P.304', ''], '3x47': ['P.143', ''], '3x52': ['P.148', ''], '7x42': ['P.308', ''], '6x40': ['P.266', ''], '6x50': ['P.276', ''], '34x56': ['P.159', ''], '6x44': ['P.270', ''], '4x39': ['P.162', ''], '6x25': ['P.251', ''], '3x29': ['P.125', ''], '6x37': ['P.263', ''], '3x48': ['P.144', ''], '1x27': ['P.44', ''], '4x41': ['P.164', ''], '8x47': ['P.322', ''], '2x64': ['P.109', ''], '2x47': ['P.92', ''], '2x43': ['P.88', ''], '3x42': ['P.138', ''], '4x48': ['P.171', ''], '2x40': ['P.85', ''], '3x49': ['P.145', ''], '6x52': ['P.278', ''], '7x52': ['P.317', ''], '7x37': ['P.303', ''], '3x39': ['P.135', ''], '6x36': ['P.262', ''], '3x43': ['P.139', ''], '5x59': ['P.234', ''], '1x36': ['P.53', ''], '8x57': ['P.332', ''], '3x27': ['P.123', ''], '3x25': ['P.121', ''], '7x31': ['P.297', ''], '5x61': ['P.236', ''], '7x41': ['P.307', ''], '2x60': ['P.105', ''], '1x45': ['P.62', ''], '4x59': ['P.182', ''], '3x31': ['P.127', ''], '5x34': ['P.208', ''], '7x45': ['P.310', ''], '4x53': ['P.176', ''], '3x28': ['P.124', ''], '6x41': ['P.267', ''], '8x53': ['P.328', ''], '6x23': ['P.249', ''], '6x60': ['P.286', ''], '7x35': ['P.301', ''], '6x49': ['P.275', ''], '5x53': ['P.228', ''], '7x51': ['P.316', ''], '34x54': ['P.157', ''], '6x33': ['P.259', ''], '12x50': ['P.80', ''], '12x49': ['P.79', ''], '3x46': ['P.142', ''], '4x47': ['P.170', ''], '8x60': ['P.335', ''], '4x52': ['P.175', ''], '5x52': ['P.227', ''], '5x58': ['P.233', ''], '7x30': ['P.296', ''], '4x58': ['P.181', ''], '2x62': ['P.107', ''], '4x63': ['P.186', ''], '1x60': ['P.77', ''], '7x36': ['P.302', ''], '8x52': ['P.327', ''], '2x52': ['P.97', ''], '8x51': ['P.326', ''], '6x46': ['P.272', ''], '1x23': ['P.40', ''], '5x36': ['P.210', ''], '45x51': ['P.199', ''], '4x40': ['P.163', ''], '12x48': ['P.78', ''], '23x51': ['P.115', ''], '2x48': ['P.93', ''], '5x461': ['P.221', ''], '1x47': ['P.64', ''], '5x35': ['P.209', ''], '5x68': ['P.243', ''], '6x32': ['P.258', ''], '5x40': ['P.214', ''], '1x33': ['P.50', ''], '6x53': ['P.279', ''], '2x55': ['P.100', ''], '5x45': ['P.219', ''], '1x35': ['P.52', ''], '1x38': ['P.55', ''], '1x41': ['P.58', ''], '2x44': ['P.89', ''], '6x51': ['P.277', ''], '5x67': ['P.242', ''], '5x47': ['P.222', ''], '6x42': ['P.268', ''], '34x55': ['P.158', ''], '34x53': ['P.156', ''], '6x61': ['P.287', ''], '2x61': ['P.106', ''], '7x48': ['P.313', ''], '1x50': ['P.67', ''], '4x46': ['P.169', ''], '8x58': ['P.333', ''], '1x32': ['P.49', ''], '3x24': ['P.120', ''], '5x60': ['P.235', ''], '2x66': ['P.111', ''], '5x51': ['P.226', ''], '5x41': ['P.215', ''], '6x26': ['P.252', ''], '3x50': ['P.146', ''], '45x52': ['P.200', ''], '3x44': ['P.140', ''], '1x37': ['P.54', ''], '6x47': ['P.273', ''], '5x56': ['P.231', ''], '3x37': ['P.133', ''], '1x57': ['P.74', ''], '1x49': ['P.66', ''], '4x55': ['P.178', ''], '5x38': ['P.212', ''], '1x48': ['P.65', ''], '3x26': ['P.122', ''], '7x53': ['P.318', ''], '1x46': ['P.63', ''], '3x45': ['P.141', ''], '7x29': ['P.295', ''], '1x26': ['P.43', ''], '7x33': ['P.299', ''], '4x43': ['P.166', ''], '8x48': ['P.323', ''], '4x51': ['P.174', ''], '3x35': ['P.131', ''], '2x39': ['P.84', ''], '7x34': ['P.300', ''], '6x55': ['P.281', ''], '2x46': ['P.91', ''], '5x46': ['P.220', ''], '6x45': ['P.271', ''], '2x45': ['P.90', ''], '3x40': ['P.136', ''], '1x24': ['P.41', ''], '4x49': ['P.172', ''], '12x51': ['P.81', ''], '6x57': ['P.283', ''], '7x50': ['P.315', ''], '2x57': ['P.102', ''], '3x34': ['P.130', ''], '4x50': ['P.173', ''], '7x43': ['P.309', ''], '1x52': ['P.69', ''], '6x27': ['P.253', ''], '1x42': ['P.59', ''], '3x56': ['P.152', ''], '3x51': ['P.147', ''], '5x49': ['P.224', ''], '5x33': ['P.207', '']}

    //database din: 
    var nameToResiTable={'4x54': ['P.178', ''], '4x61': ['P.185', ''], '4x50': ['P.174', ''], '2x45': ['P.90', ''], '5x62': ['P.232', ''], '1x33': ['P.50', ''], '8x58': ['P.384', ''], '2x55': ['P.100', ''], '3x31': ['P.128', ''], '6x33': ['P.312', ''], '2x57': ['P.103', ''], '5x42': ['P.211', ''], '7x50': ['P.366', ''], '3x21': ['P.118', ''], '4x46': ['P.170', ''], '4x58': ['P.182', ''], '7x36': ['P.353', ''], '2x52': ['P.97', ''], '6x30': ['P.309', ''], '4x47': ['P.171', ''], '1x31': ['P.48', ''], '6x40': ['P.319', ''], '8x52': ['P.378', ''], '7x54': ['P.370', ''], '45x50': ['P.199', ''], '3x43': ['P.140', ''], '2x51': ['P.96', ''], '8x50': ['P.376', ''], '6x53': ['P.332', ''], '5x56': ['P.226', ''], '4x49': ['P.173', ''], '5x71': ['P.301', ''], '1x42': ['P.59', ''], '1x30': ['P.47', ''], '3x27': ['P.124', ''], '6x38': ['P.317', ''], '6x59': ['P.338', ''], '4x56': ['P.180', ''], '7x42': ['P.359', ''], '3x35': ['P.132', ''], '7x56': ['P.372', ''], '5x47': ['P.217', ''], '5x38': ['P.207', ''], '7x43': ['P.360', ''], '2x38': ['P.83', ''], '6x51': ['P.330', ''], '8x53': ['P.379', ''], '7x31': ['P.348', ''], '5x63': ['P.233', ''], '4x52': ['P.176', ''], '12x49': ['P.79', ''], '5x36': ['P.205', ''], '4x59': ['P.183', ''], '2x49': ['P.94', ''], '1x32': ['P.49', ''], '5x60': ['P.230', ''], '3x46': ['P.143', ''], '34x57': ['P.161', ''], '1x47': ['P.64', ''], '6x35': ['P.314', ''], '5x68': ['P.238', ''], '6x42': ['P.321', ''], '3x51': ['P.148', ''], '5x69': ['P.239', ''], '5x54': ['P.224', ''], '1x50': ['P.67', ''], '7x47': ['P.363', ''], '3x24': ['P.121', ''], '34x56': ['P.160', ''], '2x58': ['P.104', ''], '5x43': ['P.212', ''], '1x43': ['P.60', ''], '6x26': ['P.305', ''], '7x34': ['P.351', ''], '3x37': ['P.134', ''], '1x59': ['P.76', ''], '7x33': ['P.350', ''], '2x47': ['P.92', ''], '34x54': ['P.158', ''], '6x57': ['P.336', ''], '4x51': ['P.175', ''], '2x50': ['P.95', ''], '6x39': ['P.318', ''], '1x38': ['P.55', ''], '3x30': ['P.127', ''], '8x55': ['P.381', ''], '5x44': ['P.213', ''], '5x53': ['P.223', ''], '7x37': ['P.354', ''], '2x46': ['P.91', ''], '5x45': ['P.214', ''], '6x31': ['P.310', ''], '5x40': ['P.209', ''], '6x28': ['P.307', ''], '5x55': ['P.225', ''], '7x30': ['P.347', ''], '2x62': ['P.108', ''], '5x52': ['P.222', ''], '1x49': ['P.66', ''], '5x57': ['P.227', ''], '6x32': ['P.311', ''], '1x46': ['P.63', ''], '1x58': ['P.75', ''], '1x37': ['P.54', ''], '6x29': ['P.308', ''], '4x39': ['P.163', ''], '6x43': ['P.322', ''], '2x60': ['P.106', ''], '3x28': ['P.125', ''], '23x52': ['P.117', ''], '2x53': ['P.98', ''], '6x41': ['P.320', ''], '3x39': ['P.136', ''], '5x50': ['P.220', ''], '7x49': ['P.365', ''], '12x50': ['P.80', ''], '3x44': ['P.141', ''], '4x57': ['P.181', ''], '2x63': ['P.109', ''], '2x48': ['P.93', ''], '4x43': ['P.167', ''], '7x38': ['P.355', ''], '7x46': ['P.362', ''], '7x39': ['P.356', ''], '7x35': ['P.352', ''], '6x55': ['P.334', ''], '4x40': ['P.164', ''], '3x32': ['P.129', ''], '6x48': ['P.327', ''], '7x32': ['P.349', ''], '6x52': ['P.331', ''], '12x48': ['P.78', ''], '2x551': ['P.101', ''], '6x45': ['P.324', ''], '8x49': ['P.375', ''], '6x34': ['P.313', ''], '34x53': ['P.157', ''], '4x45': ['P.169', ''], '2x41': ['P.86', ''], '4x60': ['P.184', ''], '23x50': ['P.115', ''], '6x49': ['P.328', ''], '2x42': ['P.87', ''], '12x51': ['P.81', ''], '7x55': ['P.371', ''], '23x51': ['P.116', ''], '1x44': ['P.61', ''], '4x44': ['P.168', ''], '8x48': ['P.374', ''], '1x57': ['P.74', ''], '2x40': ['P.85', ''], '8x47': ['P.373', ''], '2x43': ['P.88', ''], '3x49': ['P.146', ''], '34x50': ['P.154', ''], '34x55': ['P.159', ''], '3x34': ['P.131', ''], '3x54': ['P.151', ''], '5x59': ['P.229', ''], '1x48': ['P.65', ''], '23x49': ['P.114', ''], '5x41': ['P.210', ''], '5x61': ['P.231', ''], '3x33': ['P.130', ''], '7x45': ['P.361', ''], '4x41': ['P.165', ''], '3x22': ['P.119', ''], '8x56': ['P.382', ''], '2x39': ['P.84', ''], '5x48': ['P.218', ''], '6x27': ['P.306', ''], '1x45': ['P.62', ''], '1x52': ['P.69', ''], '6x54': ['P.333', ''], '6x37': ['P.316', ''], '2x65': ['P.111', ''], '5x67': ['P.237', ''], '3x53': ['P.150', ''], '5x65': ['P.235', ''], '7x41': ['P.358', ''], '6x46': ['P.325', ''], '1x35': ['P.52', ''], '6x56': ['P.335', ''], '3x29': ['P.126', ''], '6x58': ['P.337', ''], '6x60': ['P.339', ''], '3x25': ['P.122', ''], '5x39': ['P.208', ''], '5x37': ['P.206', ''], '1x51': ['P.68', ''], '3x23': ['P.120', ''], '2x59': ['P.105', ''], '5x51': ['P.221', ''], '3x55': ['P.152', ''], '3x26': ['P.123', ''], '3x47': ['P.144', ''], '3x38': ['P.135', ''], '2x64': ['P.110', ''], '1x54': ['P.71', ''], '1x41': ['P.58', ''], '4x42': ['P.166', ''], '5x66': ['P.236', ''], '34x51': ['P.155', ''], '8x51': ['P.377', ''], '7x51': ['P.367', ''], '6x44': ['P.323', ''], '5x49': ['P.219', ''], '1x29': ['P.46', ''], '34x52': ['P.156', ''], '1x39': ['P.56', ''], '45x52': ['P.201', ''], '4x62': ['P.186', ''], '7x48': ['P.364', ''], '7x53': ['P.369', ''], '1x53': ['P.70', ''], '3x40': ['P.137', ''], '2x56': ['P.102', ''], '3x50': ['P.147', ''], '6x47': ['P.326', ''], '2x66': ['P.112', ''], '3x41': ['P.138', ''], '1x55': ['P.72', ''], '4x55': ['P.179', ''], '5x64': ['P.234', ''], '3x36': ['P.133', ''], '1x40': ['P.57', ''], '1x60': ['P.77', ''], '6x50': ['P.329', ''], '3x45': ['P.142', ''], '2x37': ['P.82', ''], '3x42': ['P.139', ''], '4x48': ['P.172', ''], '3x56': ['P.153', ''], '5x46': ['P.215', ''], '1x36': ['P.53', ''], '3x52': ['P.149', ''], '45x51': ['P.200', ''], '3x48': ['P.145', ''], '6x36': ['P.315', ''], '2x44': ['P.89', ''], '7x40': ['P.357', ''], '2x61': ['P.107', ''], '2x54': ['P.99', ''], '1x56': ['P.73', ''], '4x53': ['P.177', ''], '7x52': ['P.368', ''], '8x57': ['P.383', ''], '8x54': ['P.380', ''], '1x34': ['P.51', ''], '5x461': ['P.216', ''], '5x58': ['P.228', ''], '4x63': ['P.187', '']}

 
    var i =1;
    var roundN=1
    var cluster_pre=clustering.split('"');
    while( i < cluster_pre.length){
        cpos_li=cluster_pre[i].split(" ");
        for (cposN in cpos_li){
            cpos_p = cpos_li[cposN];
            cpos=cpos_p.split(".")[1];
            if (nameToResiTable[cpos]){
                nameToResiTable[cpos][1]=[roundN]
            }
        }
        i+=2
        roundN++
    }

  function nameToResi(name){
    if( name in nameToResiTable )
      return nameToResiTable[name][0];
    else{
      console.log("Error looking up "+name);
      return undefined;
    }
  }
  function updateInteractions(frame){
    viewer.rm('interactions');
    var cm = viewer.customMesh('interactions');
    links[frame].forEach(function(d){
      var name1 = d.name1.substring(d.name1.lastIndexOf(".")+1);
      var name2 = d.name2.substring(d.name2.lastIndexOf(".")+1);
      //console.log(name1)
      if( name1 in toggledNodes || name2 in toggledNodes ){
        var resi1 = nameToResi(name1);
        var resi2 = nameToResi(name2);
        if(resi1!==undefined && resi2!==undefined){

          var atom1 = struc.atom(resi1+'.CA'); //[!]Chain should not be hardcoded!!!!
          var atom2 = struc.atom(resi2+'.CA');
          cm.addTube(atom1.pos(), atom2.pos(), 0.3, {cap:false, color:'black'});
        }

      }
    });

  }

  tickListeners.push(updateInteractions);

  function indexToClusterColor(idx){
    var colTab = {"":[0.5,0.5,0.5,1], "1":[0,1,1,1], "2":[1,0,1,1]};
    for (var key in nameToResiTable) {
      if (nameToResiTable.hasOwnProperty(key)) {
        var pos=nameToResiTable[key][0].split(".")[1];
        if(pos==""+idx) {
          return colTab[nameToResiTable[key][1]];
        }
      }
    }
    return colTab[""];
  }

  function updateColors(clustered){
    viewer.rm('protein');
    var geom = viewer.trace('protein', struc, { color : color.ssSuccession() });
    if(clustered){
      function clusterCol() {
        return new pv.color.ColorOp(function(atom, out, index) {
          var col = indexToClusterColor(atom.residue().num());

          out[index+0] = col[0];
          out[index+1] = col[1];
          out[index+2] = col[2];
        });
      }
      geom.colorBy(clusterCol());
    }
  }
  clusterListeners.push(updateColors);
</script>
