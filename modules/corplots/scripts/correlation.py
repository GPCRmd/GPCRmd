import pandas as pd
import numpy as np
from scipy.stats.stats import pearsonr

def robust_pearson(a, b):
    a = np.array(a)
    b = np.array(b)
    coef_list = []
    coef, p_val = pearsonr(a, b)
    coef_list.append(coef)
    for i in range(len(a)):
        coef, p_val = pearsonr(np.delete(a,i), np.delete(b,i))
        coef_list.append(coef)
    coef_purged = np.nan_to_num(coef_list)
    return min(coef_purged, key=lambda x: abs(x))

# Load dataframe with correlation data
csvpath = "../../../files/Precomputed/corplots/polypharma_clinical_outcomes.csv"
df = pd.read_csv(csvpath)

paths = ["Gq_antagonist_5ht2a_emax","Gq_antagonist_5ht2a_ec50","Gq_antagonist_5ht2b_emax","Gq_antagonist_5ht2b_ec50","Gq_antagonist_5ht2c_emax","Gq_antagonist_5ht2c_ec50","Gq_antagonist_m1_emax","Gq_antagonist_m1_ec50","Gq_antagonist_m3_emax","Gq_antagonist_m3_ec50","Gq_antagonist_m5_emax","Gq_antagonist_m5_ec50","Gq_antagonist_h1_emax","Gq_antagonist_h1_ec50","Gq_antagonist_α1a_emax","Gq_antagonist_α1a_ec50","Gq_agonist_5ht2a_emax","Gq_agonist_5ht2a_ec50","Gq_agonist_5ht2b_emax","Gq_agonist_5ht2b_ec50","Gq_agonist_5ht2c_emax","Gq_agonist_5ht2c_ec50","Gq_agonist_h1_emax","Gq_agonist_h1_ec50","G11_antagonist_5ht2a_emax","G11_antagonist_5ht2a_ec50","G11_antagonist_5ht2b_emax","G11_antagonist_5ht2b_ec50","G11_antagonist_5ht2c_emax","G11_antagonist_5ht2c_ec50","G11_antagonist_m1_emax","G11_antagonist_m1_ec50","G11_antagonist_m3_emax","G11_antagonist_m3_ec50","G11_antagonist_m4_emax","G11_antagonist_m4_ec50","G11_antagonist_m5_emax","G11_antagonist_m5_ec50","G11_antagonist_h1_emax","G11_antagonist_h1_ec50","G11_antagonist_α1a_emax","G11_antagonist_α1a_ec50","G11_agonist_5ht2a_emax","G11_agonist_5ht2a_ec50","G11_agonist_5ht2b_emax","G11_agonist_5ht2b_ec50","G11_agonist_5ht2c_emax","G11_agonist_5ht2c_ec50","G11_agonist_m1_emax","G11_agonist_m1_ec50","G11_agonist_m5_emax","G11_agonist_m5_ec50","G14_antagonist_5ht2a_emax","G14_antagonist_5ht2a_ec50","G14_antagonist_5ht2b_emax","G14_antagonist_5ht2b_ec50","G14_antagonist_5ht2c_emax","G14_antagonist_5ht2c_ec50","G14_antagonist_5ht1a_emax","G14_antagonist_5ht1a_ec50","G14_antagonist_m1_emax","G14_antagonist_m1_ec50","G14_antagonist_m2_emax","G14_antagonist_m2_ec50","G14_antagonist_m3_emax","G14_antagonist_m3_ec50","G14_antagonist_m4_emax","G14_antagonist_m4_ec50","G14_antagonist_m5_emax","G14_antagonist_m5_ec50","G14_antagonist_h1_emax","G14_antagonist_h1_ec50","G14_antagonist_α1a_emax","G14_antagonist_α1a_ec50","G14_agonist_5ht2a_emax","G14_agonist_5ht2a_ec50","G14_agonist_5ht2b_emax","G14_agonist_5ht2b_ec50","G14_agonist_m5_emax","G14_agonist_m5_ec50","G14_agonist_h1_emax","G14_agonist_h1_ec50","G15_antagonist_5ht2a_emax","G15_antagonist_5ht2a_ec50","G15_antagonist_5ht2b_emax","G15_antagonist_5ht2b_ec50","G15_antagonist_5ht2c_emax","G15_antagonist_5ht2c_ec50","G15_antagonist_5ht1a_emax","G15_antagonist_5ht1a_ec50","G15_antagonist_5ht6_emax","G15_antagonist_5ht6_ec50","G15_antagonist_d1_emax","G15_antagonist_d1_ec50","G15_antagonist_d5_emax","G15_antagonist_d5_ec50","G15_antagonist_m1_emax","G15_antagonist_m1_ec50","G15_antagonist_m2_emax","G15_antagonist_m2_ec50","G15_antagonist_m3_emax","G15_antagonist_m3_ec50","G15_antagonist_m4_emax","G15_antagonist_m4_ec50","G15_antagonist_m5_emax","G15_antagonist_m5_ec50","G15_antagonist_h1_emax","G15_antagonist_h1_ec50","G15_antagonist_α1a_emax","G15_antagonist_α1a_ec50","G15_antagonist_α2a_emax","G15_antagonist_α2a_ec50","G15_agonist_5ht2a_emax","G15_agonist_5ht2a_ec50","G15_agonist_5ht7a_emax","G15_agonist_5ht7a_ec50","G15_agonist_h1_emax","G15_agonist_h1_ec50","Gi1_antagonist_5ht2a_emax","Gi1_antagonist_5ht2a_ec50","Gi1_antagonist_5ht2c_emax","Gi1_antagonist_5ht2c_ec50","Gi1_antagonist_d3_emax","Gi1_antagonist_d3_ec50","Gi1_antagonist_m2_emax","Gi1_antagonist_m2_ec50","Gi1_antagonist_m3_emax","Gi1_antagonist_m3_ec50","Gi1_antagonist_m4_emax","Gi1_antagonist_m4_ec50","Gi1_antagonist_m5_emax","Gi1_antagonist_m5_ec50","Gi1_antagonist_h1_emax","Gi1_antagonist_h1_ec50","Gi1_antagonist_α2a_emax","Gi1_antagonist_α2a_ec50","Gi1_agonist_5ht1a_emax","Gi1_agonist_5ht1a_ec50","Gi1_agonist_5ht1b_emax","Gi1_agonist_5ht1b_ec50","Gi1_agonist_5ht1d_emax","Gi1_agonist_5ht1d_ec50","Gi1_agonist_d2_emax","Gi1_agonist_d2_ec50","Gi1_agonist_d3_emax","Gi1_agonist_d3_ec50","Gi1_agonist_d4_emax","Gi1_agonist_d4_ec50","Gi1_agonist_m2_emax","Gi1_agonist_m2_ec50","Gi1_agonist_α2c_emax","Gi1_agonist_α2c_ec50","Gi2_antagonist_5ht2a_emax","Gi2_antagonist_5ht2a_ec50","Gi2_antagonist_5ht2c_emax","Gi2_antagonist_5ht2c_ec50","Gi2_antagonist_d3_emax","Gi2_antagonist_d3_ec50","Gi2_antagonist_d4_emax","Gi2_antagonist_d4_ec50","Gi2_antagonist_m1_emax","Gi2_antagonist_m1_ec50","Gi2_antagonist_m2_emax","Gi2_antagonist_m2_ec50","Gi2_antagonist_m3_emax","Gi2_antagonist_m3_ec50","Gi2_antagonist_m4_emax","Gi2_antagonist_m4_ec50","Gi2_antagonist_m5_emax","Gi2_antagonist_m5_ec50","Gi2_antagonist_h1_emax","Gi2_antagonist_h1_ec50","Gi2_antagonist_α2a_emax","Gi2_antagonist_α2a_ec50","Gi2_antagonist_α2b_emax","Gi2_antagonist_α2b_ec50","Gi2_antagonist_α2c_emax","Gi2_antagonist_α2c_ec50","Gi2_agonist_5ht1a_emax","Gi2_agonist_5ht1a_ec50","Gi2_agonist_5ht1b_emax","Gi2_agonist_5ht1b_ec50","Gi2_agonist_5ht1d_emax","Gi2_agonist_5ht1d_ec50","Gi2_agonist_d2_emax","Gi2_agonist_d2_ec50","Gi2_agonist_d3_emax","Gi2_agonist_d3_ec50","Gi2_agonist_d4_emax","Gi2_agonist_d4_ec50","Gi2_agonist_m2_emax","Gi2_agonist_m2_ec50","Gi2_agonist_α2c_emax","Gi2_agonist_α2c_ec50","Gi3_antagonist_5ht2a_emax","Gi3_antagonist_5ht2a_ec50","Gi3_antagonist_5ht2c_emax","Gi3_antagonist_5ht2c_ec50","Gi3_antagonist_d3_emax","Gi3_antagonist_d3_ec50","Gi3_antagonist_d4_emax","Gi3_antagonist_d4_ec50","Gi3_antagonist_m1_emax","Gi3_antagonist_m1_ec50","Gi3_antagonist_m2_emax","Gi3_antagonist_m2_ec50","Gi3_antagonist_m3_emax","Gi3_antagonist_m3_ec50","Gi3_antagonist_m4_emax","Gi3_antagonist_m4_ec50","Gi3_antagonist_m5_emax","Gi3_antagonist_m5_ec50","Gi3_antagonist_α2a_emax","Gi3_antagonist_α2a_ec50","Gi3_antagonist_α2b_emax","Gi3_antagonist_α2b_ec50","Gi3_antagonist_α2c_emax","Gi3_antagonist_α2c_ec50","Gi3_agonist_5ht1a_emax","Gi3_agonist_5ht1a_ec50","Gi3_agonist_d2_emax","Gi3_agonist_d2_ec50","Gi3_agonist_d3_emax","Gi3_agonist_d3_ec50","Gi3_agonist_d4_emax","Gi3_agonist_d4_ec50","GoA_antagonist_5ht2a_emax","GoA_antagonist_5ht2a_ec50","GoA_antagonist_5ht2c_emax","GoA_antagonist_5ht2c_ec50","GoA_antagonist_d4_emax","GoA_antagonist_d4_ec50","GoA_antagonist_m2_emax","GoA_antagonist_m2_ec50","GoA_antagonist_m3_emax","GoA_antagonist_m3_ec50","GoA_antagonist_m5_emax","GoA_antagonist_m5_ec50","GoA_antagonist_h1_emax","GoA_antagonist_h1_ec50","GoA_antagonist_α2a_emax","GoA_antagonist_α2a_ec50","GoA_antagonist_α2c_emax","GoA_antagonist_α2c_ec50","GoA_agonist_5ht1a_emax","GoA_agonist_5ht1a_ec50","GoA_agonist_5ht1b_emax","GoA_agonist_5ht1b_ec50","GoA_agonist_5ht1d_emax","GoA_agonist_5ht1d_ec50","GoA_agonist_d2_emax","GoA_agonist_d2_ec50","GoA_agonist_d3_emax","GoA_agonist_d3_ec50","GoA_agonist_d4_emax","GoA_agonist_d4_ec50","GoA_agonist_m2_emax","GoA_agonist_m2_ec50","GoA_agonist_α2c_emax","GoA_agonist_α2c_ec50","GoB_antagonist_5ht2a_emax","GoB_antagonist_5ht2a_ec50","GoB_antagonist_5ht2b_emax","GoB_antagonist_5ht2b_ec50","GoB_antagonist_5ht2c_emax","GoB_antagonist_5ht2c_ec50","GoB_antagonist_d1_emax","GoB_antagonist_d1_ec50","GoB_antagonist_d4_emax","GoB_antagonist_d4_ec50","GoB_antagonist_d5_emax","GoB_antagonist_d5_ec50","GoB_antagonist_m1_emax","GoB_antagonist_m1_ec50","GoB_antagonist_m2_emax","GoB_antagonist_m2_ec50","GoB_antagonist_m3_emax","GoB_antagonist_m3_ec50","GoB_antagonist_m4_emax","GoB_antagonist_m4_ec50","GoB_antagonist_m5_emax","GoB_antagonist_m5_ec50","GoB_antagonist_h1_emax","GoB_antagonist_h1_ec50","GoB_antagonist_α2a_emax","GoB_antagonist_α2a_ec50","GoB_agonist_5ht2b_emax","GoB_agonist_5ht2b_ec50","GoB_agonist_5ht1a_emax","GoB_agonist_5ht1a_ec50","GoB_agonist_5ht1b_emax","GoB_agonist_5ht1b_ec50","GoB_agonist_5ht1d_emax","GoB_agonist_5ht1d_ec50","GoB_agonist_5ht7b_emax","GoB_agonist_5ht7b_ec50","GoB_agonist_d2_emax","GoB_agonist_d2_ec50","GoB_agonist_d3_emax","GoB_agonist_d3_ec50","GoB_agonist_d4_emax","GoB_agonist_d4_ec50","GoB_agonist_m2_emax","GoB_agonist_m2_ec50","GoB_agonist_α2c_emax","GoB_agonist_α2c_ec50","Gz_antagonist_5ht2a_emax","Gz_antagonist_5ht2a_ec50","Gz_antagonist_5ht2b_emax","Gz_antagonist_5ht2b_ec50","Gz_antagonist_5ht2c_emax","Gz_antagonist_5ht2c_ec50","Gz_antagonist_5ht1a_emax","Gz_antagonist_5ht1a_ec50","Gz_antagonist_5ht4_emax","Gz_antagonist_5ht4_ec50","Gz_antagonist_5ht6_emax","Gz_antagonist_5ht6_ec50","Gz_antagonist_d1_emax","Gz_antagonist_d1_ec50","Gz_antagonist_d3_emax","Gz_antagonist_d3_ec50","Gz_antagonist_d5_emax","Gz_antagonist_d5_ec50","Gz_antagonist_m1_emax","Gz_antagonist_m1_ec50","Gz_antagonist_m2_emax","Gz_antagonist_m2_ec50","Gz_antagonist_m3_emax","Gz_antagonist_m3_ec50","Gz_antagonist_m4_emax","Gz_antagonist_m4_ec50","Gz_antagonist_m5_emax","Gz_antagonist_m5_ec50","Gz_antagonist_h1_emax","Gz_antagonist_h1_ec50","Gz_antagonist_α1a_emax","Gz_antagonist_α1a_ec50","Gz_agonist_5ht2a_emax","Gz_agonist_5ht2a_ec50","Gz_agonist_5ht2b_emax","Gz_agonist_5ht2b_ec50","Gz_agonist_5ht1a_emax","Gz_agonist_5ht1a_ec50","Gz_agonist_5ht1b_emax","Gz_agonist_5ht1b_ec50","Gz_agonist_5ht1d_emax","Gz_agonist_5ht1d_ec50","Gz_agonist_5ht7a_emax","Gz_agonist_5ht7a_ec50","Gz_agonist_5ht7b_emax","Gz_agonist_5ht7b_ec50","Gz_agonist_d2_emax","Gz_agonist_d2_ec50","Gz_agonist_d3_emax","Gz_agonist_d3_ec50","Gz_agonist_d4_emax","Gz_agonist_d4_ec50","Gz_agonist_m2_emax","Gz_agonist_m2_ec50","Gz_agonist_h1_emax","Gz_agonist_h1_ec50","Gz_agonist_α2c_emax","Gz_agonist_α2c_ec50","Gs_antagonist_5ht4_emax","Gs_antagonist_5ht4_ec50","Gs_antagonist_5ht6_emax","Gs_antagonist_5ht6_ec50","Gs_antagonist_5ht7a_emax","Gs_antagonist_5ht7a_ec50","Gs_antagonist_5ht7b_emax","Gs_antagonist_5ht7b_ec50","Gs_antagonist_d1_emax","Gs_antagonist_d1_ec50","Gs_antagonist_d5_emax","Gs_antagonist_d5_ec50","Gs_antagonist_m1_emax","Gs_antagonist_m1_ec50","Gs_antagonist_m2_emax","Gs_antagonist_m2_ec50","Gs_antagonist_α1a_emax","Gs_antagonist_α1a_ec50","Gs_agonist_5ht4_emax","Gs_agonist_5ht4_ec50","G12_antagonist_5ht2c_emax","G12_antagonist_5ht2c_ec50","G13_antagonist_5ht2c_emax","G13_antagonist_5ht2c_ec50","Barrestin1_antagonist_5ht2a_emax","Barrestin1_antagonist_5ht2a_ec50","Barrestin1_antagonist_5ht2c_emax","Barrestin1_antagonist_5ht2c_ec50","Barrestin1_antagonist_5ht1a_emax","Barrestin1_antagonist_5ht1a_ec50","Barrestin1_antagonist_d1_emax","Barrestin1_antagonist_d1_ec50","Barrestin1_antagonist_m2_emax","Barrestin1_antagonist_m2_ec50","Barrestin1_antagonist_m3_emax","Barrestin1_antagonist_m3_ec50","Barrestin1_antagonist_m4_emax","Barrestin1_antagonist_m4_ec50","Barrestin1_antagonist_h1_emax","Barrestin1_antagonist_h1_ec50","Barrestin1_antagonist_α2a_emax","Barrestin1_antagonist_α2a_ec50","Barrestin2_antagonist_5ht2a_emax","Barrestin2_antagonist_5ht2a_ec50","Barrestin2_antagonist_5ht2c_emax","Barrestin2_antagonist_5ht2c_ec50","Barrestin2_antagonist_5ht1a_emax","Barrestin2_antagonist_5ht1a_ec50","Barrestin2_antagonist_5ht6_emax","Barrestin2_antagonist_5ht6_ec50","Barrestin2_antagonist_d1_emax","Barrestin2_antagonist_d1_ec50","Barrestin2_antagonist_d5_emax","Barrestin2_antagonist_d5_ec50","Barrestin2_antagonist_m2_emax","Barrestin2_antagonist_m2_ec50","Barrestin2_antagonist_m3_emax","Barrestin2_antagonist_m3_ec50","Barrestin2_antagonist_m4_emax","Barrestin2_antagonist_m4_ec50","Barrestin2_antagonist_m5_emax","Barrestin2_antagonist_m5_ec50","Barrestin2_antagonist_h1_emax","Barrestin2_antagonist_h1_ec50","Barrestin2_antagonist_α2a_emax","Barrestin2_antagonist_α2a_ec50","Barrestin2_agonist_5ht2c_emax","Barrestin2_agonist_5ht2c_ec50"]
outcomes = ["overall_change","positive","negative_","depressive","social_functioning","discontinuation","weight_gain","parkinson","Akathisia","prolactin","qtc_prolongation","sedation","anticholinergic"]

# Find correlation values for each path-outcome pair
cors = []
for path in paths:
	for out in outcomes:
		# Create minidf with columns of interest
		df_mini =  pd.concat([df[out], df[path]], axis=1)
		# Remove rows with nans
		df_mini.dropna(inplace=True)
		# Correlations 
		cor = df_mini[out].corr(df_mini[path])
		# Correlations (advanced Adrian method)
		cor_r = robust_pearson(df_mini[out], df_mini[path])
		cors.append((path,out,cor,cor_r,df_mini.shape[0]))

# Store results in pandas dataframe 
cors_df = pd.DataFrame(cors, columns=("path","out","cors","cors_r",'n'))

# Replace nans by 0
cors_df.fillna(0,inplace=True)

# Sort  by absolute value
cors_df['cor_abs'] = cors_df['cors_r'].abs()
cors_df.sort_values(by=['cor_abs'], ascending=False,inplace=True)

# Round numbers
cors_df['cors'] = cors_df['cors'].round(4)

# Save csv
cors_df.to_csv("../../../files/Precomputed/corplots/cors.csv")